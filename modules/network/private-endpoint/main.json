{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "1.10-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
    "_generator": {
      "name": "bicep",
      "version": "0.17.1.54307",
      "templateHash": "3846513701405097945"
    }
  },
  "parameters": {
    "name": {
      "type": "string",
      "maxLength": 64,
      "minLength": 2,
      "metadata": {
        "description": "The name of the Private Endpoint."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for the Private Endpoint."
      }
    },
    "privateLinkServiceId": {
      "type": "string",
      "metadata": {
        "description": "The ID of the Private Link Service."
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "The ID of the Subnet to associate with the Private Endpoint."
      }
    },
    "groupIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "The group IDs to associate with the Private Endpoint."
      }
    },
    "privateDnsZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "The Private DNS Zones to associate with the Private Endpoint."
      }
    },
    "manualApprovalEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Flag to enable manual approval for the Private Endpoint."
      }
    },
    "customNetworkInterfaceName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the custom Network Interface to associate with the Private Endpoint."
      }
    },
    "tags": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "defaultValue": {},
      "metadata": {
        "description": "Tags to assign too the Private Endpoint."
      }
    }
  },
  "resources": {
    "privateEndpoint": {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2022-11-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "privateLinkServiceConnections": "[if(parameters('manualApprovalEnabled'), null(), createArray(createObject('name', parameters('name'), 'properties', createObject('privateLinkServiceId', parameters('privateLinkServiceId'), 'groupIds', if(not(empty(parameters('groupIds'))), parameters('groupIds'), null())))))]",
        "manualPrivateLinkServiceConnections": "[if(parameters('manualApprovalEnabled'), createArray(createObject('name', parameters('name'), 'properties', createObject('privateLinkServiceId', parameters('privateLinkServiceId'), 'groupIds', if(not(empty(parameters('groupIds'))), parameters('groupIds'), null())))), null())]",
        "subnet": {
          "id": "[parameters('subnetId')]"
        },
        "customNetworkInterfaceName": "[if(not(empty(parameters('customNetworkInterfaceName'))), parameters('customNetworkInterfaceName'), null())]"
      }
    },
    "privateDnsZoneGroup": {
      "condition": "[not(empty(parameters('privateDnsZones')))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2022-11-01",
      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
      "properties": {
        "copy": [
          {
            "name": "privateDnsZoneConfigs",
            "count": "[length(parameters('privateDnsZones'))]",
            "input": {
              "name": "[coalesce(tryGet(parameters('privateDnsZones')[copyIndex('privateDnsZoneConfigs')], 'name'), 'default')]",
              "properties": {
                "privateDnsZoneId": "[parameters('privateDnsZones')[copyIndex('privateDnsZoneConfigs')].zoneId]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "privateEndpoint"
      ]
    }
  },
  "outputs": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Output. The name of the Private Endpoint."
      },
      "value": "[parameters('name')]"
    },
    "id": {
      "type": "string",
      "metadata": {
        "description": "Output. The ID of the Private Endpoint."
      },
      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
    },
    "networkInterfaces": {
      "type": "array",
      "metadata": {
        "description": "Output. The Network Interfaces of the Private Endpoint."
      },
      "value": "[reference('privateEndpoint').networkInterfaces]"
    }
  }
}