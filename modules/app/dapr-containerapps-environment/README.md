# Dapr ACA Environment

Container Apps Environment for Dapr

## Description

Provides an optimised Container App Environment for Dapr applications.

The Azure resources that this module creates are;

- Azure Container Apps Environment
- Dapr components for Container Apps
- Log Analytics Workspace
- Application Insights

Depending on which `daprComponentType` is selected, the corresponding Azure service is deployed and integrated with Dapr. These patterns are aligned with the Container Apps Environments required by the Dapr application quickstarts.

Dapr component type | Azure Service | Sample reference
------------------- | ------------- | ----------------
Pub-Sub | Azure Service Bus | [dapr pub sub quickstart](https://github.com/dapr/quickstarts/tree/master/pub_sub/javascript/sdk)
State Blob | Azure Storage Account | [dapr container apps microservices](https://docs.microsoft.com/en-us/azure/container-apps/microservices-dapr-azure-resource-manager)
State CosmosDb | Azure CosmosDb | [dapr container apps api store](https://github.com/Azure-Samples/container-apps-store-api-microservice)

## Parameters

| Name                    | Type     | Required | Description                                                                |
| :---------------------- | :------: | :------: | :------------------------------------------------------------------------- |
| `location`              | `string` | Yes      | Specifies the location for all resources.                                  |
| `nameseed`              | `string` | Yes      | Used to name the Azure resources that are created                          |
| `applicationEntityName` | `string` | No       | The application relevant name for the dapr component you are implementing  |
| `daprComponentType`     | `string` | Yes      | The dapr application component type to configure in the Environment        |
| `daprComponentName`     | `string` | No       | The name of the dapr component, this will be autogenerated if not provided |
| `daprComponentScopes`   | `array`  | No       | Names of container apps that can use this dapr component                   |
| `tags`                  | `object` | No       | Any tags that are to be applied to the Environment Components              |

## Outputs

| Name                          | Type   | Description                                                     |
| :---------------------------- | :----: | :-------------------------------------------------------------- |
| containerAppEnvironmentName   | string | The name of the created Azure Container Apps Environment        |
| appInsightsInstrumentationKey | string | The Azure Applications Insights (telemetry) instrumentation key |

## Examples

### Creation of Environment for ServiceBus PubSub apps

```bicep
module myenv 'br/public:app/dapr-containerapps-environment:1.0.1' = {
  name: 'pubsub'
  params: {
    location: location
    nameseed: 'pubsub-sb1'
    applicationEntityName: 'orders'
    daprComponentType: 'pubsub.azure.servicebus'
  }
}
```

### Creation of Environment for Blob based state

```bicep
module myenv 'br/public:app/dapr-containerapps-environment:1.0.1' = {
  name: 'state'
  params: {
    location: location
    nameseed: 'stateSt1'
    applicationEntityName: 'appdata'
    daprComponentType: 'state.azure.blobstorage'
    daprComponentScopes: [
      'myapp'
    ]
  }
}
```

### Creation of Environment for CosmosDb based state

```bicep
module myenv 'br/public:app/dapr-containerapps-environment:1.0.1' = {
  name: 'state'
  params: {
    location: location
    nameseed: 'stateSt2'
    applicationEntityName: 'appdata'
    daprComponentType: 'state.azure.cosmosdb'
    daprComponentScopes: [
      'myapp'
    ]
  }
}
```