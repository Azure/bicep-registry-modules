# Dapr ACA Environment

Container Apps Environment for Dapr

## Description

Provides an optimised Container App Environment for Dapr applications.

The Azure resources that this module creates are;

- Azure Container Apps Environment
- Dapr components for Container Apps
- Log Analytics Workspace
- Application Insights

Depending on which `daprComponentType` is selected, the corresponding Azure service is deployed and integrated with Dapr. These patterns are aligned with the Container Apps Environments required by the Dapr application quickstarts.

Dapr component type | Azure Service | Sample reference
------------------- | ------------- | ----------------
Pub-Sub | Azure Service Bus | [dapr pub sub quickstart](https://github.com/dapr/quickstarts/tree/master/pub_sub/javascript/sdk)
State Blob | Azure Storage Account | [dapr container apps microservices](https://docs.microsoft.com/en-us/azure/container-apps/microservices-dapr-azure-resource-manager)
State CosmosDb | Azure CosmosDb | [dapr container apps api store](https://github.com/Azure-Samples/container-apps-store-api-microservice)

## Parameters

| Name                       | Type     | Required | Description                                                                     |
| :------------------------- | :------: | :------: | :------------------------------------------------------------------------------ |
| `location`                 | `string` | Yes      | Specifies the location for all resources.                                       |
| `nameseed`                 | `string` | Yes      | Used to name the Azure resources that are created                               |
| `environmentAlreadyExists` | `bool`   | No       | Indicates if we should deploy the Dapr components to an existing environment    |
| `containerAppEnvName`      | `string` | No       | Specifies the name of the container app environment.                            |
| `applicationEntityName`    | `string` | No       | The application relevant name for the dapr component you are implementing       |
| `daprComponentType`        | `string` | Yes      | The dapr application component type to configure in the Environment             |
| `daprComponentName`        | `string` | No       | The name of the dapr component, this will be autogenerated if not provided      |
| `daprComponentScopes`      | `array`  | No       | Names of container apps that can use this dapr component                        |
| `infrastructureSubnetId`   | `string` | No       | For deploying in your own Virtual Network, provide the Infrastructure Subnet Id |
| `zoneRedundant`            | `bool`   | No       | Zone Redundant (needs infrastructureSubnetId)                                   |
| `tags`                     | `object` | No       | Any tags that are to be applied to the Environment Components                   |

## Outputs

| Name                          | Type   | Description                                                     |
| :---------------------------- | :----: | :-------------------------------------------------------------- |
| containerAppEnvironmentName   | string | The name of the created Azure Container Apps Environment        |
| appInsightsInstrumentationKey | string | The Azure Applications Insights (telemetry) instrumentation key |

## Examples

### Creation of Environment for ServiceBus PubSub apps

```bicep
module myenv 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'pubsub'
  params: {
    location: location
    nameseed: 'pubsub-sb1'
    applicationEntityName: 'orders'
    daprComponentType: 'pubsub.azure.servicebus'
  }
}
```

### Creation of Environment for Blob based state

```bicep
module myenv 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'state'
  params: {
    location: location
    nameseed: 'stateSt1'
    applicationEntityName: 'appdata'
    daprComponentType: 'state.azure.blobstorage'
    daprComponentScopes: [
      'myapp'
    ]
  }
}
```

### Creation of Environment for CosmosDb based state

```bicep
module myenv 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'state'
  params: {
    location: location
    nameseed: 'stateSt2'
    applicationEntityName: 'appdata'
    daprComponentType: 'state.azure.cosmosdb'
    daprComponentScopes: [
      'myapp'
    ]
  }
}
```

### Using an existing Container Apps Environment

Create the Azure Service and Dapr component on an existing Container Apps Environment

```bicep
module envAndComponent1 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'multiComponentEnvPlusCosmos'
  params: {
    location: location
    nameseed: 'myname'
    daprComponentType: 'state.azure.cosmosdb'
    environmentAlreadyExists: true
    containerAppEnvName: 'env-MyEnvironment'
  }
}
```

### Creation of multiple dapr components in the environment

When using multiple components, you can stack the deployments

```bicep
module envAndComponent1 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'multiComponentEnvPlusCosmos'
  params: {
    location: location
    nameseed: 'myname'
    daprComponentType: 'state.azure.cosmosdb'
    daprComponentScopes: [
      'myappDbComponent'
    ]
  }
}

module component2 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'multicomponentBlobAddToEnv'
  params: {
    location: location
    nameseed: 'myname'
    daprComponentType: 'state.azure.blobstorage'
    daprComponentScopes: [
      'myappLogComponent'
    ]
    environmentAlreadyExists: true
    containerAppEnvName: envAndComponent1.outputs.containerAppEnvironmentName
  }
}
```

### Zone Redundant

To create a Container Apps Environment that is Zone Redundant

```bicep
resource vnet 'Microsoft.Network/virtualNetworks@2022-05-01' = {
  name: 'vnet-${uniqueString(resourceGroup().id)}'
  location: resourceGroup().location
  properties: {
   addressSpace: {
    addressPrefixes: [
      '10.0.0.0/16'
    ]
   } 
   subnets: [
    {
      name: 'default'
      properties: {
        addressPrefix: '10.0.0.0/23'
      }
    }
   ]
  }
}

module zoneRedundantEnv 'br/public:app/dapr-containerapps-environment:1.2.1' = {
  name: 'zoneRedundantEnv'
  params: {
    location: location
    nameseed: 'zoneRed'
    daprComponentType: 'state.azure.blobstorage'
    infrastructureSubnetId: '${vnet.id}/subnets/default'
    zoneRedundant: true
  }
}
```