{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "1.10-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
    "_generator": {
      "name": "bicep",
      "version": "0.19.5.34762",
      "templateHash": "15356301695359649663"
    },
    "name": "Azure Cosmos DB",
    "description": "Bicep module for simplified deployment of Cosmos DB; enables VNet integration and offers flexible configuration options.",
    "owner": "dciborow"
  },
  "definitions": {
    "corsType": {
      "type": "object",
      "properties": {
        "allowedOrigins": {
          "type": "string",
          "metadata": {
            "description": "The origin domains that are permitted to make a request against the service via CORS."
          }
        },
        "allowedMethods": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The methods (HTTP request verbs) that the origin domain may use for a CORS request. (comma separated)"
          }
        },
        "allowedHeaders": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The response headers that should be sent back to the client for CORS requests. (comma separated)"
          }
        },
        "exposedHeaders": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The response headers that should be exposed to the client for CORS requests. (comma separated)"
          }
        },
        "maxAgeInSeconds": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "The maximum amount time that a browser should cache the preflight OPTIONS request."
          }
        }
      }
    },
    "schemaType": {
      "type": "object",
      "properties": {
        "columns": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "type": {
                "type": "string"
              }
            }
          },
          "metadata": {
            "description": "List of Cassandra table columns."
          }
        },
        "partitionKeys": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              }
            }
          },
          "metadata": {
            "description": "List of Cassandra table partition keys."
          }
        },
        "clusterKeys": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "orderBy": {
                "type": "string",
                "metadata": {
                  "description": "Order of the Cosmos DB Cassandra table cluster key, only support \"Asc\" and \"Desc\""
                }
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "List of Cassandra table cluster keys."
          }
        }
      },
      "metadata": {
        "description": "Schema of the Cosmos DB Cassandra table."
      }
    },
    "performanceConfigType": {
      "type": "object",
      "properties": {
        "enableAutoScale": {
          "type": "bool",
          "metadata": {
            "description": "Flag to enable/disable automatic throughput scaling."
          }
        },
        "throughput": {
          "type": "int",
          "metadata": {
            "description": "  When enableAutoScale is set to false, this parameter is the static throughput capability. 400 RU/s is the minimum for production workloads and must be set in increments of 100. The maxium is 100,000 unless a higher limit is requested via Azure Support.\n  When enableAutoScale is set to true, this parameter is the maximum of the autoscaled throughput capability. It would scale down to a minimum of 10% of this max throughput based on usage. It ranges from 1000 to 100,000 inclusive.\n  "
          },
          "minValue": 400
        }
      },
      "metadata": {
        "description": "Performance configurations."
      }
    },
    "cassandraTableType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the Cassandra table."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configuration."
          }
        },
        "defaultTtl": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Default time to live (TTL) in seconds."
          }
        },
        "schema": {
          "$ref": "#/definitions/schemaType",
          "metadata": {
            "description": "The schema of the Cassandra table."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the Cassandra table."
          }
        }
      },
      "metadata": {
        "description": "Cassandra table configurations."
      }
    },
    "cassandraKeyspaceType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the Cassandra keyspace."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Throughtput configuration."
          }
        },
        "tables": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/cassandraTableType"
          },
          "nullable": true,
          "metadata": {
            "description": "The object of Cassandra table configurations."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the Cassandra keyspace."
          }
        }
      },
      "metadata": {
        "description": "Cassandra keyspaces configurations."
      }
    },
    "sqlContainerClientEncryptionPolicyIncludedPathsType": {
      "type": "object",
      "properties": {
        "clientEncryptionKeyId": {
          "type": "string",
          "metadata": {
            "description": "The identifier of the Client Encryption Key to be used to encrypt the path."
          }
        },
        "encryptionAlgorithm": {
          "type": "string",
          "metadata": {
            "description": "The encryption algorithm which will be used. Eg - AEAD_AES_256_CBC_HMAC_SHA256."
          }
        },
        "encryptionType": {
          "type": "string",
          "metadata": {
            "description": "The type of encryption to be performed. Eg - Deterministic, Randomized."
          }
        },
        "path": {
          "type": "string",
          "metadata": {
            "description": "Path that needs to be encrypted."
          }
        }
      },
      "metadata": {
        "description": "The type definition of sql container client encryption policy included paths."
      }
    },
    "sqlContainerClientEncryptionPolicyType": {
      "type": "object",
      "properties": {
        "includedPaths": {
          "$ref": "#/definitions/sqlContainerClientEncryptionPolicyIncludedPathsType",
          "metadata": {
            "description": "Paths of the item that need encryption along with path-specific settings."
          }
        },
        "policyFormatVersion": {
          "type": "int",
          "allowedValues": [
            1,
            2
          ],
          "metadata": {
            "description": "Version of the client encryption policy definition. Supported versions are 1 and 2. Version 2 supports id and partition key path encryption."
          }
        }
      },
      "metadata": {
        "description": "Type definition of client encryption policy for the container."
      }
    },
    "sqlContainerIndexingPolicyIncludedPathsIndexesType": {
      "type": "object",
      "properties": {
        "kind": {
          "type": "string",
          "allowedValues": [
            "Hash",
            "Range",
            "Spatial",
            null
          ],
          "nullable": true,
          "metadata": {
            "description": "The type of index."
          }
        },
        "precision": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "The precision of the index. -1 is maximum precision."
          }
        },
        "dataType": {
          "type": "string",
          "allowedValues": [
            "LineString",
            "MultiPolygon",
            "Number",
            "Point",
            "Polygon",
            "String",
            null
          ],
          "nullable": true,
          "metadata": {
            "description": "The datatype for which the indexing behavior is applied to."
          }
        }
      }
    },
    "sqlContainerIndexingPolicyIncludedPathsType": {
      "type": "object",
      "properties": {
        "path": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The path for which the indexing behavior applies to. Index paths typically start with root and end with wildcard (/path/*)."
          }
        },
        "indexes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerIndexingPolicyIncludedPathsIndexesType"
          },
          "nullable": true,
          "metadata": {
            "description": "List of indexes for this path."
          }
        }
      },
      "metadata": {
        "description": "Type definition of container indexing policy's included paths."
      }
    },
    "sqlContainerIndexingPolicyCompositeIndexesType": {
      "type": "object",
      "properties": {
        "path": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The path for which the indexing behavior applies to. Index paths typically start with root and end with wildcard (/path/*)."
          }
        },
        "order": {
          "type": "string",
          "allowedValues": [
            "ascending",
            "descending",
            null
          ],
          "nullable": true,
          "metadata": {
            "description": "The sort order for composite paths."
          }
        }
      },
      "metadata": {
        "description": "Type definition of container indexing policy's composite indexes."
      }
    },
    "sqlContainerIndexingPolicySpatialIndexesType": {
      "type": "object",
      "properties": {
        "path": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The path for which the indexing behavior applies to. Index paths typically start with root and end with wildcard (/path/*)."
          }
        },
        "types": {
          "type": "string",
          "allowedValues": [
            "LineString",
            "MultiPolygon",
            "Point",
            "Polygon",
            null
          ],
          "nullable": true,
          "metadata": {
            "description": "The spatial type"
          }
        }
      },
      "metadata": {
        "description": "Type definition of container indexing policy's spatial indexes."
      }
    },
    "graphIndexingPolicyTypeForSqlContainerAndGremlinGraph": {
      "type": "object",
      "properties": {
        "indexingMode": {
          "type": "string",
          "allowedValues": [
            "consistent",
            "lazy",
            "none"
          ],
          "nullable": true,
          "metadata": {
            "description": "The indexing mode."
          }
        },
        "automatic": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Indicates if the indexing policy is automatic."
          }
        },
        "includedPaths": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerIndexingPolicyIncludedPathsType"
          },
          "nullable": true,
          "metadata": {
            "description": "The indexing paths"
          }
        },
        "excludedPaths": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": {
                "type": "string",
                "nullable": true,
                "metadata": {
                  "description": "The path for which the indexing behavior applies to. Index paths typically start with root and end with wildcard (/path/*)."
                }
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "List of paths to exclude from indexing."
          }
        },
        "compositeIndexes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerIndexingPolicyCompositeIndexesType"
          },
          "nullable": true,
          "metadata": {
            "description": "List of composite path list."
          }
        },
        "spatialIndexes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerIndexingPolicySpatialIndexesType"
          },
          "nullable": true,
          "metadata": {
            "description": "The spatial indexes"
          }
        }
      }
    },
    "conflictResolutionPolicyTypeForSqlContainerAndGremlinGraph": {
      "type": "object",
      "properties": {
        "conflictResolutionPath": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The conflict resolution path in the container."
          }
        },
        "conflictResolutionProcedure": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The conflict resolution procedure in the container."
          }
        },
        "mode": {
          "type": "string",
          "allowedValues": [
            "Custom",
            "LastWriterWins",
            null
          ],
          "nullable": true,
          "metadata": {
            "description": "The conflict resolution mode."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container conflict resolution policy."
      }
    },
    "partitionKeyTypeForSqlContainerAndGremlinGraph": {
      "type": "object",
      "properties": {
        "kind": {
          "type": "string",
          "allowedValues": [
            "Hash",
            "MultiHash",
            "Range",
            null
          ],
          "nullable": true,
          "metadata": {
            "description": "Indicates the kind of algorithm used for partitioning. For MultiHash, multiple partition keys (upto three maximum) are supported for container create"
          }
        },
        "paths": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "List of paths using which data within the container can be partitioned."
          }
        },
        "version": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Indicates the version of the partition key definition."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container partition key."
      }
    },
    "graphUniqueKeyPolicyTypeForSqlContainerAndGremlinGraph": {
      "type": "object",
      "properties": {
        "uniqueKeys": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "paths": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "nullable": true,
                "metadata": {
                  "description": "List of paths must be unique for each document in the Azure Cosmos DB service."
                }
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "List of unique keys."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container unique key policy."
      }
    },
    "sqlContainerStoredProceduresType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the stored procedure."
          }
        },
        "body": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The body of the stored procedure."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container stored procedures."
      }
    },
    "sqlContainerUserDefinedFunctionsType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the user defined function."
          }
        },
        "body": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The body of the user defined functions."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container user defined functions."
      }
    },
    "sqlContainerTriggersType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the trigger."
          }
        },
        "body": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The body of the triggers."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "triggerType": {
          "type": "string",
          "allowedValues": [
            "Post",
            "Pre"
          ],
          "nullable": true,
          "metadata": {
            "description": "Type of the Trigger"
          }
        },
        "triggerOperation": {
          "type": "string",
          "allowedValues": [
            "All",
            "Create",
            "Delete",
            "Replace",
            "Update"
          ],
          "nullable": true,
          "metadata": {
            "description": "The operation the trigger is associated with."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container triggers."
      }
    },
    "sqlContainerType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the container."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "defaultTtl": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Default time to live (TTL) in seconds."
          }
        },
        "conflictResolutionPolicy": {
          "$ref": "#/definitions/conflictResolutionPolicyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The conflict resolution policy for the container."
          }
        },
        "indexingPolicy": {
          "$ref": "#/definitions/graphIndexingPolicyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The indexing policy for the container. The configuration of the indexing policy. By default, the indexing is automatic for all document paths within the container."
          }
        },
        "partitionKey": {
          "$ref": "#/definitions/partitionKeyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The configuration of the partition key to be used for partitioning data into multiple partitions."
          }
        },
        "uniqueKeyPolicy": {
          "$ref": "#/definitions/graphUniqueKeyPolicyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The unique key policy configuration for specifying uniqueness constraints on documents in the collection in the Azure Cosmos DB service."
          }
        },
        "storedProcedures": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerStoredProceduresType"
          },
          "nullable": true,
          "metadata": {
            "description": "Configuration of stored procedures in the container."
          }
        },
        "userDefinedFunctions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerUserDefinedFunctionsType"
          },
          "nullable": true,
          "metadata": {
            "description": "Configuration of user defined functions in the container."
          }
        },
        "triggers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerTriggersType"
          },
          "nullable": true,
          "metadata": {
            "description": "Configuration of triggers in the container."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database container."
      }
    },
    "sqlDatabaseType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the SQL database."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "containers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlContainerType"
          },
          "nullable": true,
          "metadata": {
            "description": "sql Container configurations."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the SQL database."
          }
        }
      },
      "metadata": {
        "description": "The type definition of SQL database configuration."
      }
    },
    "consistencyPolicyType": {
      "type": "object",
      "properties": {
        "defaultConsistencyLevel": {
          "type": "string",
          "allowedValues": [
            "BoundedStaleness",
            "ConsistentPrefix",
            "Eventual",
            "Session",
            "Strong"
          ],
          "metadata": {
            "description": "The default consistency level and configuration settings of the Cosmos DB account."
          }
        },
        "maxStalenessPrefix": {
          "type": "int",
          "nullable": true,
          "maxValue": 2147483647,
          "minValue": 10,
          "metadata": {
            "description": "  When used with the Bounded Staleness consistency level, this value represents the time amount of staleness (in seconds) tolerated.\n  Required only when defaultConsistencyPolicy is set to 'BoundedStaleness'.\n  Valid ranges:\n  - Single Region: 10 to 2147483647\n  - Multi Region: 100000 to 2147483647.\n  "
          }
        },
        "maxIntervalInSeconds": {
          "type": "int",
          "nullable": true,
          "maxValue": 86400,
          "minValue": 5,
          "metadata": {
            "description": "  When used with the Bounded Staleness consistency level, this value represents the number of stale requests tolerated.\n  Required only when defaultConsistencyPolicy is set to 'BoundedStaleness'.\n  Valid ranges:\n  - Single Region: 5 to 84600.\n  - Multi Region: 300 to 86400.\n  "
          }
        }
      }
    },
    "mongodbDatabaseIndexOptionsType": {
      "type": "object",
      "properties": {
        "expireAfterSeconds": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Expire after seconds."
          }
        },
        "unique": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Is it unique or not."
          }
        }
      }
    },
    "mongodbDatabaseIndexType": {
      "type": "object",
      "properties": {
        "key": {
          "type": "object",
          "properties": {
            "keys": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "nullable": true,
              "metadata": {
                "description": "List of keys for the MongoDB collection."
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "Cosmos DB MongoDB collection index keys."
          }
        },
        "options": {
          "$ref": "#/definitions/mongodbDatabaseIndexOptionsType",
          "metadata": {
            "description": "Cosmos DB MongoDB collection index key options."
          }
        }
      }
    },
    "mongodbDatabaseCollectionType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Name of the collection."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "indexes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/mongodbDatabaseIndexType"
          },
          "nullable": true,
          "metadata": {
            "description": "\tList of index keys."
          }
        },
        "shardKey": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "A key-value pair of shard keys to be applied for the request."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      }
    },
    "mongodbDatabaseType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Name of the database."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "collections": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/mongodbDatabaseCollectionType"
          },
          "nullable": true
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      }
    },
    "tableType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Name of the table."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      }
    },
    "gremlinGraphType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Name fo the graph."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "defaultTtl": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "The default time to live in seconds."
          }
        },
        "conflictResolutionPolicy": {
          "$ref": "#/definitions/conflictResolutionPolicyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The conflict resolution policy for the graph."
          }
        },
        "indexingPolicy": {
          "$ref": "#/definitions/graphIndexingPolicyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The configuration of the indexing policy. By default, the indexing is automatic for all document paths within the graph."
          }
        },
        "partitionKey": {
          "$ref": "#/definitions/partitionKeyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The configuration of the partition key to be used for partitioning data into multiple partitions."
          }
        },
        "uniqueKeyPolicy": {
          "$ref": "#/definitions/graphUniqueKeyPolicyTypeForSqlContainerAndGremlinGraph",
          "nullable": true,
          "metadata": {
            "description": "The unique key policy configuration for specifying uniqueness constraints on documents in the collection in the Azure Cosmos DB service."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      }
    },
    "gremlinDatabaseType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "name of the database."
          }
        },
        "performance": {
          "$ref": "#/definitions/performanceConfigType",
          "nullable": true,
          "metadata": {
            "description": "Performance configs."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        },
        "graphs": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/gremlinGraphType"
          },
          "nullable": true,
          "metadata": {
            "description": "The object of Gremlin database graphs."
          }
        }
      }
    },
    "sqlRoleDefinitionPermissionType": {
      "type": "object",
      "properties": {
        "actions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "The set of permissions that the role definition contains."
          }
        },
        "dataActions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "The set of Data Actions that the role definition contains."
          }
        }
      },
      "metadata": {
        "description": "Type definition for the SQL Role Definition Permission."
      }
    },
    "sqlCustomRoleAssignmentType": {
      "type": "object",
      "properties": {
        "principalId": {
          "type": "string",
          "metadata": {
            "description": "The principal ID of the assigment."
          }
        },
        "scope": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "  The scope of the assignment. It can be the entire cosmosDB account, or a specific database or container.\n  If omitted, it means the entire cosmosDB account.\n  "
          }
        }
      }
    },
    "sqlBuiltinRoleAsignmentType": {
      "type": "object",
      "properties": {
        "principalId": {
          "type": "string",
          "metadata": {
            "description": "The principal ID of the assigment."
          }
        },
        "builtinRoleId": {
          "type": "string",
          "allowedValues": [
            "00000000-0000-0000-0000-000000000001",
            "00000000-0000-0000-0000-000000000002"
          ],
          "metadata": {
            "description": "  The ID of the builtin role.\n  See https://learn.microsoft.com/en-us/azure/cosmos-db/how-to-setup-rbac#built-in-role-definitions for defail about the built-in roles.\n  "
          }
        },
        "scope": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "  The scope of the assignment. It can be the entire cosmosDB account, or a specific database or container.\n  If omitted, it means the entire cosmosDB account.\n  "
          }
        }
      }
    },
    "sqlCustomRoleDefinitionType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the SQL role definition."
          }
        },
        "permissions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlRoleDefinitionPermissionType"
          },
          "nullable": true
        },
        "assisgnments": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sqlCustomRoleAssignmentType"
          },
          "nullable": true,
          "metadata": {
            "description": "The list of SQL role assignments."
          }
        }
      }
    },
    "privateEndpointType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the private endpoint."
          }
        },
        "subnetId": {
          "type": "string",
          "metadata": {
            "description": "The subnet that the private endpoint should be created in."
          }
        },
        "groupId": {
          "type": "string",
          "metadata": {
            "description": "The subresource name of the target Azure resource that private endpoint will connect to."
          }
        },
        "privateDnsZoneId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The ID of the private DNS zone in which private endpoint will register its private IP address."
          }
        },
        "isManualApproval": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "When set to true, users will need to manually approve the private endpoint connection request."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      }
    },
    "locationType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the Azure region."
          }
        },
        "isZoneRedundant": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Flag to indicate whether or not this region is an AvailabilityZone region"
          }
        }
      }
    },
    "roleAssignmentType": {
      "type": "object",
      "properties": {
        "roleDefinitionId": {
          "type": "string",
          "metadata": {
            "description": "The ID of the role definition."
          }
        },
        "principalId": {
          "type": "string",
          "metadata": {
            "description": "The ID of the principal to whom the role is assigned."
          }
        },
        "principalType": {
          "type": "string",
          "allowedValues": [
            "Device",
            "ForeignGroup",
            "Group",
            "ServicePrincipal",
            "User"
          ],
          "nullable": true,
          "metadata": {
            "description": "The type of principal to whom the role is assigned."
          }
        },
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The description of the role assignment."
          }
        },
        "delegatedManagedIdentityResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The ID of the delegated managed identity resource."
          }
        }
      }
    }
  },
  "parameters": {
    "backendApi": {
      "type": "string",
      "defaultValue": "sql",
      "allowedValues": [
        "cassandra",
        "gremlin",
        "mongodb",
        "sql",
        "table"
      ],
      "metadata": {
        "description": "The bakend API type of Cosmos DB database account. The API selection cannot be changed after account creation. Possible values: \"cassandra\", \"gremlin\", \"mongodb\", \"sql\", \"table\"."
      }
    },
    "prefix": {
      "type": "string",
      "defaultValue": "[createObject('cassandra', 'coscas', 'gremlin', 'cosgrm', 'mongodb', 'cosmon', 'sql', 'cosmos', 'table', 'costab')[parameters('backendApi')]]",
      "metadata": {
        "description": "Prefix of Cosmos DB Resource Name. Not used if name is provided."
      }
    },
    "name": {
      "type": "string",
      "defaultValue": "[format('{0}-{1}', parameters('prefix'), uniqueString(resourceGroup().id, resourceGroup().location, 'cosmosdb', parameters('backendApi')))]",
      "minLength": 3,
      "maxLength": 44,
      "metadata": {
        "description": "The name of the Cosmos DB account. Character limit: 3-44, valid characters: lowercase letters, numbers, and hyphens. It must me unique across Azure."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The primary location of the Cosmos DB account. Default is the location of the resource group.\nThis would be the write region if param.additionalLocations contains more regions for georeplication.\n"
      }
    },
    "isZoneRedundant": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Indicate whether or not to enable zone redundancy for region specified by param.location. It must be an AvailabilityZone region.\nTo enable this feature for other regions, please enable parameter isZoneRedundant in param.additionalLocations.\n"
      }
    },
    "enableAutomaticFailover": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enables automatic failover of the write region in the rare event that the region is unavailable due to an outage. Automatic failover will result in a new write region for the account and is chosen based on the failover priorities configured for the account."
      }
    },
    "enableMultipleWriteLocations": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enables the account to write in multiple locations. Once enabled, all regions included in the param.locations will be read/write regions.\nMulti-region writes capability allows you to take advantage of the provisioned throughput for your databases and containers across the globe."
      }
    },
    "enableServerless": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Serverless for consumption-based usage."
      }
    },
    "enableFreeTier": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Flag to indicate whether Free Tier is enabled, up to one account per subscription is allowed."
      }
    },
    "totalThroughputLimit": {
      "type": "int",
      "defaultValue": -1,
      "minValue": -1,
      "metadata": {
        "description": "The total throughput limit of the Cosmos DB account in measurement of requests units (RUs) per second, -1 indicates no limits on provisioning of throughput."
      }
    },
    "additionalLocations": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/locationType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The array of geo locations that Cosmos DB account would be hosted in.\nEach element defines a region of georeplication.\nThe order of regions in this list is the order for region failover. The first element is the primary region which is a write region of the Cosmos DB account.\n"
      }
    },
    "mongoDBServerVersion": {
      "type": "string",
      "defaultValue": "4.2",
      "allowedValues": [
        "3.2",
        "3.6",
        "4.0",
        "4.2"
      ],
      "metadata": {
        "description": "MongoDB server version. Required for mongodb API type Cosmos DB account"
      }
    },
    "cors": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/corsType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "List of CORS rules. Each CORS rule allows or denies requests from a set of origins to a Cosmos DB account or a database"
      }
    },
    "createMode": {
      "type": "string",
      "defaultValue": "Default",
      "allowedValues": [
        "Default",
        "Restore"
      ],
      "metadata": {
        "description": "The mode of the Cosmos Account creation. Set to Restore to restore from an existing account."
      }
    },
    "disableKeyBasedMetadataWriteAccess": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Disable write operations on metadata resources (databases, containers, throughput) via account keys."
      }
    },
    "enablePublicNetworkAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether requests from public network allowed."
      }
    },
    "networkAclBypass": {
      "type": "string",
      "defaultValue": "AzureServices",
      "metadata": {
        "description": "Indicates what services are allowed to bypass firewall checks."
      },
      "allowedValues": [
        "AzureServices",
        "None"
      ]
    },
    "ipRules": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "List of IpRules to be allowed.\nEach element in this array is either a single IPv4 address or a single IPv4 address range in CIDR format.\n"
      }
    },
    "virtualNetworkRules": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "metadata": {
              "description": "The id of the subnet. For example: /subscriptions/{subscriptionId}/resourceGroups/{groupName}/providers/Microsoft.Network/virtualNetworks/{virtualNetworkName}/subnets/{subnetName}."
            }
          },
          "ignoreMissingVNetServiceEndpoint": {
            "type": "bool",
            "nullable": true,
            "metadata": {
              "description": "Whether to ignore missing virtual network service endpoint."
            }
          }
        }
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of virtual network ACL rules. Subnets in this list will be allowed to connect."
      }
    },
    "networkAclBypassResourceIds": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "An array that contains the Resource Ids for Network Acl Bypass."
      }
    },
    "extraCapabilities": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Extra capabilities besides the ones required by param.backendApi and param.enableServerless."
      }
    },
    "disableLocalAuth": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Opt-out of local authentication and ensure only MSI and AAD can be used exclusively for authentication."
      }
    },
    "enableAnalyticalStorage": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Flag to indicate whether to enable storage analytics."
      }
    },
    "analyticalStorageSchemaType": {
      "type": "string",
      "defaultValue": "WellDefined",
      "allowedValues": [
        "FullFidelity",
        "WellDefined"
      ],
      "metadata": {
        "description": "The type of schema for analytical storage."
      }
    },
    "cassandraKeyspaces": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/cassandraKeyspaceType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The array of Cassandra keyspaces configurations."
      }
    },
    "sqlDatabases": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/sqlDatabaseType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The object of sql database configurations."
      }
    },
    "mongodbDatabases": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/mongodbDatabaseType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of MongoDB databases configurations."
      }
    },
    "tables": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/tableType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The object of Table databases configurations."
      }
    },
    "gremlinDatabases": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/gremlinDatabaseType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of Gremlin databases configurations."
      }
    },
    "sqlCustomRoleDefinitions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/sqlCustomRoleDefinitionType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of SQL role definitions. Only valid when param.backendApi is set to \"Sql\"."
      }
    },
    "sqlBuiltinRoleAssignments": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/sqlBuiltinRoleAsignmentType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of SQL built-in role assignments. Only valid when param.backendApi is set to \"Sql\"."
      }
    },
    "roleAssignments": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/roleAssignmentType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of role assignments for the Cosmos DB account."
      }
    },
    "identityType": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "SystemAssigned",
        "SystemAssigned,UserAssigned",
        "UserAssigned"
      ],
      "metadata": {
        "description": "The type of identity used for the Cosmos DB account. The type \"SystemAssigned, UserAssigned\" includes both an implicitly created identity and a set of user-assigned identities. The type \"None\" will remove any identities from the Cosmos DB account."
      }
    },
    "userAssignedIdentities": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of user-assigned managed identities. The user identity dictionary key references will be ARM resource ids in the form: \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/{identityName}\""
      }
    },
    "tags": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "defaultValue": {},
      "metadata": {
        "description": "A object of key-value pairs that describe the resource."
      }
    },
    "lock": {
      "type": "string",
      "defaultValue": "NotSpecified",
      "metadata": {
        "description": "Specify the type of lock on Cosmos DB account resource."
      },
      "allowedValues": [
        "CanNotDelete",
        "NotSpecified",
        "ReadOnly"
      ]
    },
    "consistencyPolicy": {
      "$ref": "#/definitions/consistencyPolicyType",
      "defaultValue": {
        "defaultConsistencyLevel": "Session"
      },
      "metadata": {
        "description": "The consistency policy for the Cosmos DB account."
      }
    },
    "privateEndpoints": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/privateEndpointType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Private Endpoints that should be created for Azure Cosmos DB account."
      }
    },
    "minimalTlsVersion": {
      "type": "string",
      "defaultValue": "Tls12",
      "metadata": {
        "description": "The minimum TLS version to support on this account."
      },
      "allowedValues": [
        "Tls",
        "Tls11",
        "Tls12"
      ]
    },
    "enablePartitionMerge": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Flag to indicate enabling/disabling of Partition Merge feature on the account."
      }
    },
    "enablePartitionKeyMonitor": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Flag to indicate enabling/disabling of Partition Split feature on the account."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "allLocations",
        "count": "[length(union(createArray(createObject('name', parameters('location'), 'isZoneRedundant', parameters('isZoneRedundant'))), parameters('additionalLocations')))]",
        "input": {
          "locationName": "[union(createArray(createObject('name', parameters('location'), 'isZoneRedundant', parameters('isZoneRedundant'))), parameters('additionalLocations'))[copyIndex('allLocations')].name]",
          "failoverPriority": "[copyIndex('allLocations')]",
          "isZoneRedundant": "[coalesce(tryGet(union(createArray(createObject('name', parameters('location'), 'isZoneRedundant', parameters('isZoneRedundant'))), parameters('additionalLocations'))[copyIndex('allLocations')], 'isZoneRedundant'), false())]"
        }
      },
      {
        "name": "capabilities",
        "count": "[length(union(parameters('extraCapabilities'), if(parameters('enableServerless'), createArray('EnableServerless'), createArray()), variables('capabilityNeededForBackendApi')[parameters('backendApi')]))]",
        "input": {
          "name": "[union(parameters('extraCapabilities'), if(parameters('enableServerless'), createArray('EnableServerless'), createArray()), variables('capabilityNeededForBackendApi')[parameters('backendApi')])[copyIndex('capabilities')]]"
        }
      }
    ],
    "capabilityNeededForBackendApi": {
      "cassandra": [
        "EnableCassandra"
      ],
      "gremlin": [
        "EnableGremlin"
      ],
      "mongodb": [
        "EnableMongo"
      ],
      "table": [
        "EnableTable"
      ],
      "sql": []
    }
  },
  "resources": {
    "cosmosDBAccount": {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2023-04-15",
      "name": "[toLower(parameters('name'))]",
      "location": "[parameters('location')]",
      "kind": "[if(equals(parameters('backendApi'), 'mongodb'), 'MongoDB', 'GlobalDocumentDB')]",
      "properties": {
        "copy": [
          {
            "name": "ipRules",
            "count": "[length(parameters('ipRules'))]",
            "input": {
              "ipAddressOrRange": "[parameters('ipRules')[copyIndex('ipRules')]]"
            }
          }
        ],
        "analyticalStorageConfiguration": "[if(parameters('enableAnalyticalStorage'), createObject('schemaType', parameters('analyticalStorageSchemaType')), null())]",
        "apiProperties": "[if(equals(parameters('backendApi'), 'mongodb'), createObject('serverVersion', parameters('mongoDBServerVersion')), null())]",
        "capabilities": "[variables('capabilities')]",
        "capacity": "[if(parameters('enableServerless'), null(), createObject('totalThroughputLimit', parameters('totalThroughputLimit')))]",
        "consistencyPolicy": "[parameters('consistencyPolicy')]",
        "cors": "[parameters('cors')]",
        "createMode": "[parameters('createMode')]",
        "databaseAccountOfferType": "Standard",
        "disableKeyBasedMetadataWriteAccess": "[parameters('disableKeyBasedMetadataWriteAccess')]",
        "disableLocalAuth": "[if(equals(parameters('backendApi'), 'sql'), parameters('disableLocalAuth'), null())]",
        "enableAnalyticalStorage": "[parameters('enableAnalyticalStorage')]",
        "enableAutomaticFailover": "[parameters('enableAutomaticFailover')]",
        "enableFreeTier": "[parameters('enableFreeTier')]",
        "enableMultipleWriteLocations": "[if(parameters('enableServerless'), false(), parameters('enableMultipleWriteLocations'))]",
        "enablePartitionMerge": "[parameters('enablePartitionMerge')]",
        "enablePartitionKeyMonitor": "[parameters('enablePartitionKeyMonitor')]",
        "isVirtualNetworkFilterEnabled": "[greater(length(parameters('virtualNetworkRules')), 0)]",
        "locations": "[if(parameters('enableServerless'), createArray(variables('allLocations')[0]), variables('allLocations'))]",
        "minimalTlsVersion": "[parameters('minimalTlsVersion')]",
        "networkAclBypass": "[parameters('networkAclBypass')]",
        "networkAclBypassResourceIds": "[parameters('networkAclBypassResourceIds')]",
        "publicNetworkAccess": "[if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled')]",
        "virtualNetworkRules": "[parameters('virtualNetworkRules')]"
      },
      "identity": {
        "type": "[parameters('identityType')]",
        "userAssignedIdentities": "[if(contains(parameters('identityType'), 'UserAssigned'), toObject(parameters('userAssignedIdentities'), lambda('id', lambdaVariables('id')), lambda('id', createObject())), null())]"
      },
      "tags": "[parameters('tags')]"
    },
    "cosmosDBAccount_sqlBuiltinRoleAssignments": {
      "copy": {
        "name": "cosmosDBAccount_sqlBuiltinRoleAssignments",
        "count": "[length(parameters('sqlBuiltinRoleAssignments'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'sql')]",
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
      "apiVersion": "2023-04-15",
      "name": "[format('{0}/{1}', toLower(parameters('name')), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('sqlBuiltinRoleAssignments')[copyIndex()].builtinRoleId, parameters('sqlBuiltinRoleAssignments')[copyIndex()].principalId))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', toLower(parameters('name')), parameters('sqlBuiltinRoleAssignments')[copyIndex()].builtinRoleId)]",
        "principalId": "[parameters('sqlBuiltinRoleAssignments')[copyIndex()].principalId]",
        "scope": "[format('{0}{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), coalesce(tryGet(parameters('sqlBuiltinRoleAssignments')[copyIndex()], 'scope'), ''))]"
      },
      "dependsOn": [
        "cosmosDBAccount",
        "cosmosDBAccount_sqlDatabases"
      ]
    },
    "cosmosDBAccount_roleAssignment": {
      "copy": {
        "name": "cosmosDBAccount_roleAssignment",
        "count": "[length(parameters('roleAssignments'))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', toLower(parameters('name')))]",
      "name": "[guid(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('roleAssignments')[copyIndex()].roleDefinitionId, parameters('roleAssignments')[copyIndex()].principalId)]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
        "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
        "principalType": "[tryGet(parameters('roleAssignments')[copyIndex()], 'principalType')]",
        "description": "[tryGet(parameters('roleAssignments')[copyIndex()], 'description')]",
        "delegatedManagedIdentityResourceId": "[tryGet(parameters('roleAssignments')[copyIndex()], 'delegatedManagedIdentityResourceId')]"
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_lock": {
      "condition": "[not(equals(parameters('lock'), 'NotSpecified'))]",
      "type": "Microsoft.Authorization/locks",
      "apiVersion": "2020-05-01",
      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', toLower(parameters('name')))]",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('lock'))]",
      "properties": {
        "level": "[parameters('lock')]",
        "notes": "[if(equals(parameters('lock'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot modify the resource or child resources.')]"
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_cassandraKeyspaces": {
      "copy": {
        "name": "cosmosDBAccount_cassandraKeyspaces",
        "count": "[length(parameters('cassandraKeyspaces'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'cassandra')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('cassandraKeyspaces')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[parameters('name')]"
          },
          "keyspace": {
            "value": "[parameters('cassandraKeyspaces')[copyIndex()]]"
          },
          "enableServerless": {
            "value": "[parameters('enableServerless')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "15522634699029320922"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string"
            },
            "enableServerless": {
              "type": "bool"
            },
            "keyspace": {
              "type": "object"
            }
          },
          "resources": {
            "cosmosDBAccount::cassandraKeyspaces::cassandraTables": {
              "copy": {
                "name": "cassandraTables",
                "count": "[length(coalesce(tryGet(parameters('keyspace'), 'tables'), createArray()))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDBAccountName'), parameters('keyspace').name, coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()].name)]",
              "properties": {
                "resource": {
                  "id": "[coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()].name]",
                  "defaultTtl": "[tryGet(coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()], 'defaultTtl')]",
                  "schema": "[tryGet(coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()], 'schema')]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()], 'performance'), null())), null(), if(coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()].performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()].performance.throughput)), createObject('throughput', coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()].performance.throughput)))]"
              },
              "tags": "[coalesce(tryGet(coalesce(tryGet(parameters('keyspace'), 'tables'), createArray())[copyIndex()], 'tags'), createObject())]",
              "dependsOn": [
                "cosmosDBAccount::cassandraKeyspaces"
              ]
            },
            "cosmosDBAccount::cassandraKeyspaces": {
              "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), parameters('keyspace').name)]",
              "properties": {
                "resource": {
                  "id": "[parameters('keyspace').name]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(parameters('keyspace'), 'performance'), null())), null(), if(parameters('keyspace').performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', parameters('keyspace').performance.throughput)), createObject('throughput', parameters('keyspace').performance.throughput)))]"
              },
              "tags": "[coalesce(tryGet(parameters('keyspace'), 'tags'), createObject())]"
            },
            "cosmosDBAccount": {
              "existing": true,
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosDBAccountName')]"
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_sqlDatabases": {
      "copy": {
        "name": "cosmosDBAccount_sqlDatabases",
        "count": "[length(parameters('sqlDatabases'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'sql')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('sqlDatabases')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[parameters('name')]"
          },
          "database": {
            "value": "[parameters('sqlDatabases')[copyIndex()]]"
          },
          "enableServerless": {
            "value": "[parameters('enableServerless')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "12084678724345651618"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string"
            },
            "enableServerless": {
              "type": "bool"
            },
            "database": {
              "type": "object"
            }
          },
          "resources": {
            "cosmosDBAccount": {
              "existing": true,
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosDBAccountName')]"
            },
            "sqlDatabase": {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2022-11-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), parameters('database').name)]",
              "tags": "[coalesce(tryGet(parameters('database'), 'tags'), createObject())]",
              "properties": {
                "resource": {
                  "id": "[parameters('database').name]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(parameters('database'), 'performance'), null())), null(), if(parameters('database').performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', parameters('database').performance.throughput)), createObject('throughput', parameters('database').performance.throughput)))]"
              }
            },
            "sqlDatabaseContainers": {
              "copy": {
                "name": "sqlDatabaseContainers",
                "count": "[length(coalesce(tryGet(parameters('database'), 'containers'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDBAccountName'), parameters('database').name), coalesce(tryGet(parameters('database'), 'containers'), createArray())[copyIndex()].name)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosDBAccountName": {
                    "value": "[parameters('cosmosDBAccountName')]"
                  },
                  "databaseName": {
                    "value": "[parameters('database').name]"
                  },
                  "container": {
                    "value": "[coalesce(tryGet(parameters('database'), 'containers'), createArray())[copyIndex()]]"
                  },
                  "enableServerless": {
                    "value": "[parameters('enableServerless')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "1.10-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
                    "_generator": {
                      "name": "bicep",
                      "version": "0.19.5.34762",
                      "templateHash": "503132590308591695"
                    }
                  },
                  "parameters": {
                    "cosmosDBAccountName": {
                      "type": "string"
                    },
                    "databaseName": {
                      "type": "string"
                    },
                    "enableServerless": {
                      "type": "bool"
                    },
                    "container": {
                      "type": "object"
                    }
                  },
                  "resources": {
                    "cosmosDBAccount::sqlDatabase::databaseContainers::databaseContainersStoredProcedures": {
                      "copy": {
                        "name": "databaseContainersStoredProcedures",
                        "count": "[length(coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray()))]"
                      },
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures",
                      "apiVersion": "2023-04-15",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('cosmosDBAccountName'), parameters('databaseName'), parameters('container').name, coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()].name)]",
                      "tags": "[coalesce(tryGet(coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()], 'tags'), createObject())]",
                      "properties": {
                        "resource": {
                          "id": "[coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()].name]",
                          "body": "[coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()].body]"
                        },
                        "options": "[if(or(parameters('enableServerless'), equals(tryGet(coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()], 'performance'), null())), null(), if(coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()].performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()].performance.throughput)), createObject('throughput', coalesce(tryGet(parameters('container'), 'storedProcedures'), createArray())[copyIndex()].performance.throughput)))]"
                      },
                      "dependsOn": [
                        "cosmosDBAccount::sqlDatabase::databaseContainers"
                      ]
                    },
                    "cosmosDBAccount::sqlDatabase::databaseContainers::databaseContainersUserDefinedFunction": {
                      "copy": {
                        "name": "databaseContainersUserDefinedFunction",
                        "count": "[length(coalesce(tryGet(parameters('container'), 'userDefinedFunctions'), createArray()))]"
                      },
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions",
                      "apiVersion": "2023-04-15",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('cosmosDBAccountName'), parameters('databaseName'), parameters('container').name, coalesce(tryGet(parameters('container'), 'userDefinedFunctions'), createArray())[copyIndex()].name)]",
                      "tags": "[coalesce(tryGet(coalesce(tryGet(parameters('container'), 'userDefinedFunctions'), createArray())[copyIndex()], 'tags'), createObject())]",
                      "properties": {
                        "resource": {
                          "id": "[coalesce(tryGet(parameters('container'), 'userDefinedFunctions'), createArray())[copyIndex()].name]",
                          "body": "[coalesce(tryGet(parameters('container'), 'userDefinedFunctions'), createArray())[copyIndex()].body]"
                        }
                      },
                      "dependsOn": [
                        "cosmosDBAccount::sqlDatabase::databaseContainers"
                      ]
                    },
                    "cosmosDBAccount::sqlDatabase::databaseContainers::databaseContainersTriggers": {
                      "copy": {
                        "name": "databaseContainersTriggers",
                        "count": "[length(coalesce(tryGet(parameters('container'), 'triggers'), createArray()))]"
                      },
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers",
                      "apiVersion": "2023-04-15",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('cosmosDBAccountName'), parameters('databaseName'), parameters('container').name, coalesce(tryGet(parameters('container'), 'triggers'), createArray())[copyIndex()].name)]",
                      "tags": "[coalesce(tryGet(coalesce(tryGet(parameters('container'), 'triggers'), createArray())[copyIndex()], 'tags'), createObject())]",
                      "properties": {
                        "resource": {
                          "id": "[coalesce(tryGet(parameters('container'), 'triggers'), createArray())[copyIndex()].name]",
                          "body": "[coalesce(tryGet(parameters('container'), 'triggers'), createArray())[copyIndex()].body]",
                          "triggerOperation": "[tryGet(coalesce(tryGet(parameters('container'), 'triggers'), createArray())[copyIndex()], 'triggerOperation')]",
                          "triggerType": "[tryGet(coalesce(tryGet(parameters('container'), 'triggers'), createArray())[copyIndex()], 'triggerType')]"
                        }
                      },
                      "dependsOn": [
                        "cosmosDBAccount::sqlDatabase::databaseContainers"
                      ]
                    },
                    "cosmosDBAccount::sqlDatabase::databaseContainers": {
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
                      "apiVersion": "2023-04-15",
                      "name": "[format('{0}/{1}/{2}', parameters('cosmosDBAccountName'), parameters('databaseName'), parameters('container').name)]",
                      "tags": "[coalesce(tryGet(parameters('container'), 'tags'), createObject())]",
                      "properties": {
                        "resource": {
                          "id": "[parameters('container').name]",
                          "defaultTtl": "[tryGet(parameters('container'), 'defaultTtl')]",
                          "conflictResolutionPolicy": "[tryGet(parameters('container'), 'conflictResolutionPolicy')]",
                          "uniqueKeyPolicy": "[tryGet(parameters('container'), 'uniqueKeyPolicy')]",
                          "indexingPolicy": "[tryGet(parameters('container'), 'indexingPolicy')]",
                          "partitionKey": "[tryGet(parameters('container'), 'partitionKey')]"
                        },
                        "options": "[if(or(parameters('enableServerless'), equals(tryGet(parameters('container'), 'performance'), null())), null(), if(parameters('container').performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', parameters('container').performance.throughput)), createObject('throughput', parameters('container').performance.throughput)))]"
                      }
                    },
                    "cosmosDBAccount::sqlDatabase": {
                      "existing": true,
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
                      "apiVersion": "2023-04-15",
                      "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), parameters('databaseName'))]"
                    },
                    "cosmosDBAccount": {
                      "existing": true,
                      "type": "Microsoft.DocumentDB/databaseAccounts",
                      "apiVersion": "2023-04-15",
                      "name": "[parameters('cosmosDBAccountName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "sqlDatabase"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_mongodbDatabases": {
      "copy": {
        "name": "cosmosDBAccount_mongodbDatabases",
        "count": "[length(parameters('mongodbDatabases'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'mongodb')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('mongodbDatabases')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[parameters('name')]"
          },
          "database": {
            "value": "[parameters('mongodbDatabases')[copyIndex()]]"
          },
          "enableServerless": {
            "value": "[parameters('enableServerless')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "18287492754499819717"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string"
            },
            "enableServerless": {
              "type": "bool",
              "defaultValue": false
            },
            "database": {
              "type": "object"
            }
          },
          "resources": {
            "cosmosDBAccount::mongodbDatabase::mongodbDatabaseCollections": {
              "copy": {
                "name": "mongodbDatabaseCollections",
                "count": "[length(coalesce(tryGet(parameters('database'), 'collections'), createArray()))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDBAccountName'), parameters('database').name, coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()].name)]",
              "properties": {
                "resource": {
                  "id": "[coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()].name]",
                  "indexes": "[tryGet(coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()], 'indexes')]",
                  "shardKey": "[tryGet(coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()], 'shardKey')]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()], 'performance'), null())), null(), if(coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()].performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()].performance.throughput)), createObject('throughput', coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()].performance.throughput)))]"
              },
              "tags": "[coalesce(tryGet(coalesce(tryGet(parameters('database'), 'collections'), createArray())[copyIndex()], 'tags'), createObject())]",
              "dependsOn": [
                "cosmosDBAccount::mongodbDatabase"
              ]
            },
            "cosmosDBAccount::mongodbDatabase": {
              "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), parameters('database').name)]",
              "properties": {
                "resource": {
                  "id": "[parameters('database').name]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(parameters('database'), 'performance'), null())), null(), if(parameters('database').performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', parameters('database').performance.throughput)), createObject('throughput', parameters('database').performance.throughput)))]"
              },
              "tags": "[coalesce(tryGet(parameters('database'), 'tags'), createObject())]"
            },
            "cosmosDBAccount": {
              "existing": true,
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosDBAccountName')]"
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_tables": {
      "copy": {
        "name": "cosmosDBAccount_tables",
        "count": "[length(parameters('tables'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'table')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('tables')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[parameters('name')]"
          },
          "table": {
            "value": "[parameters('tables')[copyIndex()]]"
          },
          "enableServerless": {
            "value": "[parameters('enableServerless')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "352182291244014987"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string"
            },
            "enableServerless": {
              "type": "bool"
            },
            "table": {
              "type": "object"
            }
          },
          "resources": {
            "cosmosDBAccount::tables": {
              "type": "Microsoft.DocumentDB/databaseAccounts/tables",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), parameters('table').name)]",
              "tags": "[coalesce(tryGet(parameters('table'), 'tags'), createObject())]",
              "properties": {
                "resource": {
                  "id": "[parameters('table').name]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(parameters('table'), 'performance'), null())), null(), if(parameters('table').performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', parameters('table').performance.throughput)), createObject('throughput', parameters('table').performance.throughput)))]"
              }
            },
            "cosmosDBAccount": {
              "existing": true,
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosDBAccountName')]"
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_gremlinDatabases": {
      "copy": {
        "name": "cosmosDBAccount_gremlinDatabases",
        "count": "[length(parameters('gremlinDatabases'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'gremlin')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('gremlinDatabases')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[parameters('name')]"
          },
          "database": {
            "value": "[parameters('gremlinDatabases')[copyIndex()]]"
          },
          "enableServerless": {
            "value": "[parameters('enableServerless')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "14406191392985530497"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string"
            },
            "enableServerless": {
              "type": "bool"
            },
            "database": {
              "type": "object"
            }
          },
          "resources": {
            "cosmosDBAccount::gremlinDatabase::gremlinDatabaseGraphs": {
              "copy": {
                "name": "gremlinDatabaseGraphs",
                "count": "[length(coalesce(tryGet(parameters('database'), 'graphs'), createArray()))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDBAccountName'), parameters('database').name, coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()].name)]",
              "properties": {
                "resource": {
                  "id": "[coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()].name]",
                  "defaultTtl": "[tryGet(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()], 'defaultTtl')]",
                  "indexingPolicy": "[tryGet(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()], 'indexingPolicy')]",
                  "partitionKey": "[tryGet(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()], 'partitionKey')]",
                  "uniqueKeyPolicy": "[tryGet(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()], 'uniqueKeyPolicy')]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()], 'performance'), null())), null(), if(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()].performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()].performance.throughput)), createObject('throughput', coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()].performance.throughput)))]"
              },
              "tags": "[coalesce(tryGet(coalesce(tryGet(parameters('database'), 'graphs'), createArray())[copyIndex()], 'tags'), createObject())]",
              "dependsOn": [
                "cosmosDBAccount::gremlinDatabase"
              ]
            },
            "cosmosDBAccount::gremlinDatabase": {
              "type": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), parameters('database').name)]",
              "properties": {
                "resource": {
                  "id": "[parameters('database').name]"
                },
                "options": "[if(or(parameters('enableServerless'), equals(tryGet(parameters('database'), 'performance'), null())), null(), if(parameters('database').performance.enableAutoScale, createObject('autoscaleSettings', createObject('maxThroughput', parameters('database').performance.throughput)), createObject('throughput', parameters('database').performance.throughput)))]"
              },
              "tags": "[coalesce(tryGet(parameters('database'), 'tags'), createObject())]"
            },
            "cosmosDBAccount": {
              "existing": true,
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosDBAccountName')]"
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    },
    "cosmosDBAccount_sqlRoles": {
      "copy": {
        "name": "cosmosDBAccount_sqlRoles",
        "count": "[length(parameters('sqlCustomRoleDefinitions'))]"
      },
      "condition": "[equals(parameters('backendApi'), 'sql')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('sqlCustomRoleDefinitions')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[parameters('name')]"
          },
          "role": {
            "value": "[parameters('sqlCustomRoleDefinitions')[copyIndex()]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "2516204004951964226"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string"
            },
            "role": {
              "type": "object"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "allScopes",
                "count": "[length(coalesce(tryGet(parameters('role'), 'assignments'), createArray()))]",
                "input": "[coalesce(tryGet(coalesce(tryGet(parameters('role'), 'assignments'), createArray())[copyIndex('allScopes')], 'scope'), '')]"
              }
            ],
            "assignableScopes": "[filter(variables('allScopes'), lambda('scope', not(empty(lambdaVariables('scope')))))]"
          },
          "resources": {
            "cosmosDBAccount": {
              "existing": true,
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosDBAccountName')]"
            },
            "sqlRoleDefinitions": {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), guid(parameters('cosmosDBAccountName'), parameters('role').name))]",
              "properties": {
                "roleName": "[parameters('role').name]",
                "type": "CustomRole",
                "assignableScopes": "[if(empty(variables('assignableScopes')), createArray(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName'))), variables('assignableScopes'))]",
                "permissions": "[tryGet(parameters('role'), 'permissions')]"
              }
            },
            "sqlRoleAssignments": {
              "copy": {
                "name": "sqlRoleAssignments",
                "count": "[length(coalesce(tryGet(parameters('role'), 'assignments'), createArray()))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosDBAccountName'), guid(parameters('cosmosDBAccountName'), parameters('role').name)), coalesce(tryGet(parameters('role'), 'assignments'), createArray())[copyIndex()].principalId))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosDBAccountName'), guid(parameters('cosmosDBAccountName'), parameters('role').name))]",
                "principalId": "[coalesce(tryGet(parameters('role'), 'assignments'), createArray())[copyIndex()].principalId]",
                "scope": "[format('{0}{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), coalesce(tryGet(coalesce(tryGet(parameters('role'), 'assignments'), createArray())[copyIndex()], 'scope'), ''))]"
              },
              "dependsOn": [
                "sqlRoleDefinitions"
              ]
            }
          },
          "outputs": {
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "The role definition ids of the created role definitions."
              },
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosDBAccountName'), guid(parameters('cosmosDBAccountName'), parameters('role').name))]"
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount",
        "cosmosDBAccount_sqlDatabases"
      ]
    },
    "cosmosDBAccount_privateEndpoints": {
      "copy": {
        "name": "cosmosDBAccount_privateEndpoints",
        "count": "[length(parameters('privateEndpoints'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name'))), parameters('privateEndpoints')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountId": {
            "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name')))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "endpoint": {
            "value": "[parameters('privateEndpoints')[copyIndex()]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "17969280035918507949"
            }
          },
          "parameters": {
            "cosmosDBAccountId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "endpoint": {
              "type": "object"
            }
          },
          "variables": {
            "manualApprovalEnabled": "[coalesce(tryGet(parameters('endpoint'), 'isManualApproval'), false())]"
          },
          "resources": {
            "privateEndpoint::privateDnsZoneGroup": {
              "condition": "[not(equals(tryGet(parameters('endpoint'), 'privateDnsZoneId'), null()))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('endpoint').name, 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "default",
                    "properties": {
                      "privateDnsZoneId": "[parameters('endpoint').privateDnsZoneId]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "privateEndpoint"
              ]
            },
            "privateEndpoint": {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2022-07-01",
              "name": "[parameters('endpoint').name]",
              "location": "[parameters('location')]",
              "tags": "[coalesce(tryGet(parameters('endpoint'), 'tags'), createObject())]",
              "properties": {
                "privateLinkServiceConnections": "[if(variables('manualApprovalEnabled'), null(), createArray(createObject('name', parameters('endpoint').name, 'properties', createObject('privateLinkServiceId', parameters('cosmosDBAccountId'), 'groupIds', createArray(parameters('endpoint').groupId)))))]",
                "manualPrivateLinkServiceConnections": "[if(variables('manualApprovalEnabled'), createArray(createObject('name', parameters('endpoint').name, 'properties', createObject('privateLinkServiceId', parameters('cosmosDBAccountId'), 'groupIds', createArray(parameters('endpoint').groupId)))), null())]",
                "subnet": {
                  "id": "[parameters('endpoint').subnetId]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "cosmosDBAccount"
      ]
    }
  },
  "outputs": {
    "id": {
      "type": "string",
      "metadata": {
        "description": "Cosmos DB Account Resource ID"
      },
      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('name')))]"
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "Cosmos DB Account Resource Name"
      },
      "value": "[toLower(parameters('name'))]"
    },
    "systemAssignedIdentityPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "Object Id of system assigned managed identity for Cosmos DB account (if enabled)."
      },
      "value": "[if(contains(parameters('identityType'), 'SystemAssigned'), reference('cosmosDBAccount', '2023-04-15', 'full').identity.principalId, '')]"
    },
    "sqlRoleDefinitionIds": {
      "type": "array",
      "metadata": {
        "description": "Resource Ids of sql role definition resources created for this Cosmos DB account."
      },
      "copy": {
        "count": "[length(parameters('sqlCustomRoleDefinitions'))]",
        "input": "[reference(format('cosmosDBAccount_sqlRoles[{0}]', copyIndex())).outputs.roleDefinitionId.value]"
      }
    }
  }
}