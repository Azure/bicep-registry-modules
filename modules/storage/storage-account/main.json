{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "1.10-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
    "_generator": {
      "name": "bicep",
      "version": "0.20.4.51522",
      "templateHash": "14407591854696997315"
    },
    "name": "Azure Storage Account",
    "description": "This Bicep module creates a Storage Account with zone-redundancy, encryption, virtual network access, and TLS version.",
    "owner": "dciborow"
  },
  "definitions": {
    "changeFeed": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "bool"
        },
        "retentionInDays": {
          "type": "int",
          "nullable": true,
          "minValue": 1,
          "maxValue": 146000,
          "metadata": {
            "description": "Indicates the duration of changeFeed retention in days. A null value indicates an infinite retention of the change feed."
          }
        }
      },
      "metadata": {
        "description": "The blob service properties for change feed events."
      }
    },
    "deleteRetentionPolicyType": {
      "type": "object",
      "properties": {
        "allowPermanentDelete": {
          "type": "bool",
          "metadata": {
            "description": "This property when set to true allows deletion of the soft deleted blob versions and snapshots. This property cannot be used blob restore policy. This property only applies to blob service and does not apply to containers or file share."
          }
        },
        "days": {
          "type": "int",
          "nullable": true,
          "minValue": 1,
          "maxValue": 365,
          "metadata": {
            "description": "Indicates the number of days that the deleted item should be retained."
          }
        },
        "enabled": {
          "type": "bool"
        }
      }
    },
    "cors": {
      "type": "object",
      "properties": {
        "corsRules": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "allowedHeaders": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "metadata": {
                  "description": "A list of headers allowed to be part of the cross-origin request."
                }
              },
              "allowedMethods": {
                "type": "array",
                "allowedValues": [
                  "DELETE",
                  "GET",
                  "HEAD",
                  "MERGE",
                  "OPTIONS",
                  "PATCH",
                  "POST",
                  "PUT"
                ],
                "metadata": {
                  "description": "A list of HTTP methods that are allowed to be executed by the origin."
                }
              },
              "allowedOrigins": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "metadata": {
                  "description": "A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains"
                }
              },
              "exposedHeaders": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "metadata": {
                  "description": "A list of response headers to expose to CORS clients."
                }
              },
              "maxAgeInSeconds": {
                "type": "int",
                "metadata": {
                  "description": "The number of seconds that the client/browser should cache a preflight response."
                }
              }
            }
          }
        }
      },
      "metadata": {
        "description": "Specifies CORS rules for the Blob service. You can include up to five CorsRule elements in the request. If no CorsRule elements are included in the request body, all CORS rules will be deleted, and CORS will be disabled for the Blob service."
      }
    },
    "lastAccessTimeTrackingPolicyType": {
      "type": "object",
      "properties": {
        "blobType": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true
        },
        "enable": {
          "type": "bool"
        }
      },
      "metadata": {
        "description": "The blob service property to configure last access time based tracking policy."
      }
    },
    "restorePolicy": {
      "type": "object",
      "properties": {
        "days": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "how long this blob can be restored. It should be great than zero and less than DeleteRetentionPolicy.days."
          }
        },
        "enabled": {
          "type": "bool"
        }
      },
      "metadata": {
        "description": "The blob service property to configure last access time based tracking policy."
      }
    },
    "blobContainerPropertiesType": {
      "type": "object",
      "properties": {
        "defaultEncryptionScope": {
          "type": "string",
          "nullable": true
        },
        "denyEncryptionScopeOverride": {
          "type": "bool",
          "nullable": true
        },
        "publicAccess": {
          "type": "string",
          "allowedValues": [
            "Blob",
            "Container",
            "None"
          ],
          "nullable": true
        }
      }
    },
    "blobContainerType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 3,
          "maxLength": 63
        },
        "properties": {
          "$ref": "#/definitions/blobContainerPropertiesType",
          "nullable": true
        }
      }
    },
    "activeDirectoryPropertiesType": {
      "type": "object",
      "properties": {
        "domainGuid": {
          "type": "string",
          "metadata": {
            "description": "Specifies the domain GUID."
          }
        },
        "domainName": {
          "type": "string",
          "metadata": {
            "description": "Specifies the primary domain that the AD DNS server is authoritative for."
          }
        },
        "accountType": {
          "type": "string",
          "allowedValues": [
            "Computer",
            "User"
          ],
          "nullable": true,
          "metadata": {
            "description": "Specifies the Active Directory account type for Azure Storage."
          }
        },
        "azureStorageSid": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Specifies the security identifier (SID) for Azure Storage."
          }
        },
        "domainSid": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Specifies the security identifier (SID) for domain."
          }
        },
        "forestName": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Specifies the Active Directory forest to get."
          }
        },
        "netBiosDomainName": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Specifies the NetBIOS domain name."
          }
        },
        "samAccountName": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Specifies the Active Directory SAMAccountName for Azure Storage."
          }
        }
      }
    },
    "azureFilesIdentityBasedAuthenticationType": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "bool"
        },
        "configurations": {
          "type": "object",
          "properties": {
            "activeDirectoryProperties": {
              "$ref": "#/definitions/activeDirectoryPropertiesType",
              "nullable": true,
              "metadata": {
                "description": "Required if directoryServiceOptions are AD, optional if they are AADKERB."
              }
            },
            "defaultSharePermission": {
              "type": "string",
              "allowedValues": [
                "None",
                "StorageFileDataSmbShareContributor",
                "StorageFileDataSmbShareElevatedContributor",
                "StorageFileDataSmbShareReader"
              ],
              "nullable": true,
              "metadata": {
                "description": "Default share permission for users using Kerberos authentication if RBAC role is not assigned."
              }
            },
            "directoryServiceOptions": {
              "type": "string",
              "allowedValues": [
                "AADDS",
                "AADKERB",
                "AD",
                "None"
              ],
              "metadata": {
                "description": "Indicates the directory service used. Note that this enum may be extended in the future."
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "Required when enable=true."
          }
        }
      }
    },
    "EncryptionIdentityType": {
      "type": "object",
      "properties": {
        "federatedIdentityClientId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "ClientId of the multi-tenant application to be used in conjunction with the user-assigned identity for cross-tenant customer-managed-keys server-side encryption on the storage account."
          }
        },
        "userAssignedIdentity": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Resource identifier of the UserAssigned identity to be associated with server-side encryption on the storage account."
          }
        }
      }
    },
    "encryptionKeyVaultPropertiesType": {
      "type": "object",
      "properties": {
        "keyName": {
          "type": "string",
          "metadata": {
            "description": "The name of KeyVault key."
          }
        },
        "keyVaultUri": {
          "type": "string",
          "metadata": {
            "description": "The Uri of KeyVault."
          }
        },
        "keyVersion": {
          "type": "string",
          "metadata": {
            "description": "The version of KeyVault key."
          }
        }
      }
    },
    "encryptionServiceType": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "bool",
          "metadata": {
            "description": "A boolean indicating whether or not the service encrypts the data as it is stored. Encryption at rest is enabled by default today and cannot be disabled."
          }
        },
        "keyType": {
          "type": "string",
          "allowedValues": [
            "Account",
            "Service"
          ],
          "nullable": true,
          "metadata": {
            "description": "Encryption key type to be used for the encryption service. \"Account\" key type implies that an account-scoped encryption key will be used. \"Service\" key type implies that a default service key is used."
          }
        }
      }
    },
    "encryptionServicesType": {
      "type": "object",
      "properties": {
        "blob": {
          "$ref": "#/definitions/encryptionServiceType",
          "nullable": true,
          "metadata": {
            "description": "The encryption function of the blob storage service."
          }
        },
        "file": {
          "$ref": "#/definitions/encryptionServiceType",
          "nullable": true,
          "metadata": {
            "description": "The encryption function of the file storage service."
          }
        },
        "queue": {
          "$ref": "#/definitions/encryptionServiceType",
          "nullable": true,
          "metadata": {
            "description": "The encryption function of the queue storage service."
          }
        },
        "table": {
          "$ref": "#/definitions/encryptionServiceType",
          "nullable": true,
          "metadata": {
            "description": "The encryption function of the table storage service."
          }
        }
      }
    },
    "encryptionType": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "bool"
        },
        "configurations": {
          "type": "object",
          "properties": {
            "identity": {
              "$ref": "#/definitions/EncryptionIdentityType",
              "nullable": true,
              "metadata": {
                "description": "The identity to be used with service-side encryption at rest."
              }
            },
            "keySource": {
              "type": "string",
              "allowedValues": [
                "Microsoft.Keyvault",
                "Microsoft.Storage"
              ],
              "nullable": true,
              "metadata": {
                "description": "Specifies the encryption keySource (provider)."
              }
            },
            "keyVaultProperties": {
              "$ref": "#/definitions/encryptionKeyVaultPropertiesType",
              "nullable": true,
              "metadata": {
                "description": "Properties provided by key vault."
              }
            },
            "requireInfrastructureEncryption": {
              "type": "bool",
              "nullable": true,
              "metadata": {
                "description": "A boolean indicating whether or not the service applies a secondary layer of encryption with platform managed keys for data at rest."
              }
            },
            "services": {
              "$ref": "#/definitions/encryptionServicesType",
              "nullable": true,
              "metadata": {
                "description": "    List of services which enable encryption using customer-managed keys.\n    Azure only support enabling either blob and file, queue and table, or all of them.\n    "
              }
            }
          },
          "nullable": true
        }
      }
    },
    "networkAclsResourceAccessRuleType": {
      "type": "object",
      "properties": {
        "resourceAccessRuleId": {
          "type": "string",
          "metadata": {
            "description": "Specifies the resource id of the resource to which the access rule applies."
          }
        },
        "tenantId": {
          "type": "string",
          "metadata": {
            "description": "Specifies the tenant id of the resource to which the access rule applies."
          }
        }
      }
    },
    "networkAclsType": {
      "type": "object",
      "properties": {
        "bypass": {
          "type": "string",
          "allowedValues": [
            "AzureServices",
            "Logging",
            "Metrics",
            "None"
          ],
          "nullable": true,
          "metadata": {
            "description": "Specifies whether traffic is bypassed for Logging/Metrics/AzureServices. Possible values are any combination of Logging,Metrics,AzureServices (For example, \"Logging, Metrics\"), or None to bypass none of those traffics."
          }
        },
        "defaultAction": {
          "type": "string",
          "allowedValues": [
            "Allow",
            "Deny"
          ],
          "metadata": {
            "description": "Specifies whether all network access is allowed or denied when no other rules match."
          }
        },
        "ipAllowlist": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Specifies the IP or IP range in CIDR format to be allowed to connect. Only IPV4 address is allowed."
          }
        },
        "resourceAccessRules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/networkAclsResourceAccessRuleType"
          },
          "nullable": true,
          "metadata": {
            "description": "Sets the resource access rules."
          }
        },
        "subnetIds": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Sets the virtual network rules."
          }
        }
      }
    },
    "routingPreferenceType": {
      "type": "object",
      "properties": {
        "publishInternetEndpoints": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "A boolean flag which indicates whether internet routing storage endpoints are to be published."
          }
        },
        "publishMicrosoftEndpoints": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "A boolean flag which indicates whether microsoft routing storage endpoints are to be published."
          }
        },
        "routingChoice": {
          "type": "string",
          "allowedValues": [
            "InternetRouting",
            "MicrosoftRouting"
          ],
          "metadata": {
            "description": "Routing Choice defines the kind of network routing opted by the user."
          }
        }
      }
    },
    "accessKeyPolicyType": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "bool"
        },
        "keyExpirationPeriodInDays": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "  Required when enable=true\n  The key expiration period in days."
          }
        }
      }
    },
    "sasTokenPolicyType": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "bool"
        },
        "configurations": {
          "type": "object",
          "properties": {
            "expirationAction": {
              "type": "string",
              "allowedValues": [
                "log"
              ]
            },
            "sasExpirationPeriod": {
              "type": "string",
              "metadata": {
                "description": "The SAS expiration period, DD.HH:MM:SS."
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "Required when enable=true."
          }
        }
      }
    },
    "privateEndpointType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "The name of the private endpoint."
          }
        },
        "subnetId": {
          "type": "string",
          "metadata": {
            "description": "The subnet that the private endpoint should be created in."
          }
        },
        "groupId": {
          "type": "string",
          "metadata": {
            "description": "The subresource name of the target Azure resource that private endpoint will connect to."
          }
        },
        "privateDnsZoneId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "The ID of the private DNS zone in which private endpoint will register its private IP address."
          }
        },
        "isManualApproval": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "When set to true, users will need to manually approve the private endpoint connection request."
          }
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Tags for the resource."
          }
        }
      }
    },
    "blobServicePropertiesType": {
      "type": "object",
      "properties": {
        "changeFeed": {
          "$ref": "#/definitions/changeFeed",
          "nullable": true
        },
        "containerDeleteRetentionPolicy": {
          "$ref": "#/definitions/deleteRetentionPolicyType",
          "nullable": true
        },
        "cors": {
          "$ref": "#/definitions/cors",
          "nullable": true
        },
        "deleteRetentionPolicy": {
          "$ref": "#/definitions/deleteRetentionPolicyType",
          "nullable": true
        },
        "isVersioningEnabled": {
          "type": "bool",
          "nullable": true
        },
        "lastAccessTimeTrackingPolicy": {
          "$ref": "#/definitions/lastAccessTimeTrackingPolicyType",
          "nullable": true
        },
        "restorePolicy": {
          "$ref": "#/definitions/restorePolicy",
          "nullable": true
        }
      },
      "metadata": {
        "description": "The properties of a storage account’s Blob service."
      }
    },
    "managementPolicyRuleType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "A rule name can contain any combination of alpha numeric characters. Rule name is case-sensitive. It must be unique within a policy."
          }
        },
        "enabled": {
          "type": "bool",
          "nullable": true
        },
        "definition": {
          "$ref": "#/definitions/managementPolicyRuleDefinitionType",
          "nullable": true
        }
      }
    },
    "managementPolicyRuleDefinitionType": {
      "type": "object",
      "properties": {
        "actions": {
          "$ref": "#/definitions/managementPolicyActionType",
          "metadata": {
            "description": "An object that defines the action set."
          }
        },
        "filters": {
          "$ref": "#/definitions/managementPolicyFilterType",
          "metadata": {
            "description": "An object that defines the filter set."
          }
        }
      }
    },
    "managementPolicyFilterType": {
      "type": "object",
      "properties": {
        "blobTypes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "metadata": {
            "description": "An array of predefined enum values. Currently blockBlob supports all tiering and delete actions. Only delete actions are supported for appendBlob."
          }
        },
        "prefixMatch": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "An array of strings for prefixes to be match."
          }
        },
        "blobIndexMatch": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/managementPolicyTagFilterType"
          },
          "nullable": true,
          "maxLength": 10,
          "metadata": {
            "description": "An array of blob index tag based filters, there can be at most 10 tag filters"
          }
        }
      }
    },
    "managementPolicyTagFilterType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 128,
          "metadata": {
            "description": "This is the filter tag name, it can have 1 - 128 characters"
          }
        },
        "op": {
          "type": "string",
          "allowedValues": [
            "="
          ],
          "metadata": {
            "description": "This is the comparison operator which is used for object comparison and filtering. Only == (equality operator) is currently supported"
          }
        },
        "value": {
          "type": "string",
          "maxLength": 256,
          "metadata": {
            "description": "This is the filter tag value field used for tag based filtering, it can have 0 - 256 characters."
          }
        }
      }
    },
    "managementPolicyActionType": {
      "type": "object",
      "properties": {
        "baseBlob": {
          "$ref": "#/definitions/managementPolicyBaseBlobType",
          "nullable": true,
          "metadata": {
            "description": "The management policy action for base blob."
          }
        },
        "snapshot": {
          "$ref": "#/definitions/managementPolicySnapShotAndVersionType",
          "nullable": true,
          "metadata": {
            "description": "The management policy action for snapshot."
          }
        },
        "version": {
          "$ref": "#/definitions/managementPolicySnapShotAndVersionType",
          "nullable": true,
          "metadata": {
            "description": "The management policy action for version."
          }
        }
      }
    },
    "managementPolicySnapShotAndVersionType": {
      "type": "object",
      "properties": {
        "delete": {
          "$ref": "#/definitions/managementPolicyDateAfterCreationType",
          "nullable": true,
          "metadata": {
            "description": "The function to delete the blob snapshot/version."
          }
        },
        "tierToArchive": {
          "$ref": "#/definitions/managementPolicyDateAfterCreationType",
          "nullable": true
        },
        "tierToCold": {
          "$ref": "#/definitions/managementPolicyDateAfterCreationType",
          "nullable": true
        },
        "tierToCool": {
          "$ref": "#/definitions/managementPolicyDateAfterCreationType",
          "nullable": true
        },
        "tierToHot": {
          "$ref": "#/definitions/managementPolicyDateAfterCreationType",
          "nullable": true
        }
      }
    },
    "managementPolicyDateAfterCreationType": {
      "type": "object",
      "properties": {
        "daysAfterCreationGreaterThan": {
          "type": "int",
          "metadata": {
            "description": "Value indicating the age in days after creation."
          }
        },
        "daysAfterLastTierChangeGreaterThan": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Value indicating the age in days after last blob tier change time. This property is only applicable for tierToArchive actions and requires daysAfterCreationGreaterThan to be set for snapshots and blob version based actions. The blob will be archived if both the conditions are satisfied."
          }
        }
      }
    },
    "managementPolicyBaseBlobType": {
      "type": "object",
      "properties": {
        "enableAutoTierToHotFromCool": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "This property enables auto tiering of a blob from cool to hot on a blob access. This property requires tierToCool.daysAfterLastAccessTimeGreaterThan."
          }
        },
        "delete": {
          "$ref": "#/definitions/managementPolicyDateAfterModificationType",
          "nullable": true
        },
        "tierToArchive": {
          "$ref": "#/definitions/managementPolicyDateAfterModificationType",
          "nullable": true
        },
        "tierToCold": {
          "$ref": "#/definitions/managementPolicyDateAfterModificationType",
          "nullable": true
        },
        "tierToCool": {
          "$ref": "#/definitions/managementPolicyDateAfterModificationType",
          "nullable": true
        },
        "tierToHot": {
          "$ref": "#/definitions/managementPolicyDateAfterModificationType",
          "nullable": true
        }
      }
    },
    "managementPolicyDateAfterModificationType": {
      "type": "object",
      "properties": {
        "daysAfterCreationGreaterThan": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Value indicating the age in days after blob creation."
          }
        },
        "daysAfterLastAccessTimeGreaterThan": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Value indicating the age in days after last blob access. This property can only be used in conjunction with last access time tracking policy."
          }
        },
        "daysAfterLastTierChangeGreaterThan": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Value indicating the age in days after last blob tier change time. This property is only applicable for tierToArchive actions and requires daysAfterModificationGreaterThan to be set for baseBlobs based actions. The blob will be archived if both the conditions are satisfied."
          }
        },
        "daysAfterModificationGreaterThan": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Value indicating the age in days after last modification."
          }
        }
      }
    },
    "objectReplicationSourcePolicyType": {
      "type": "object",
      "properties": {
        "policyId": {
          "type": "string",
          "metadata": {
            "description": "The value of the policy ID returned from the matching policy of the destination account."
          }
        },
        "destinationStorageAccountId": {
          "type": "string",
          "metadata": {
            "description": "The ID of the destination storage account."
          }
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/objectReplicationSourceRuelType"
          }
        }
      }
    },
    "objectReplicationDestinationPolicyType": {
      "type": "object",
      "properties": {
        "sourceStorageAccountId": {
          "type": "string",
          "metadata": {
            "description": "The ID of the source storage account."
          }
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/objectReplicationDestinationRuelType"
          }
        }
      }
    },
    "objectReplicationSourceRuelType": {
      "type": "object",
      "properties": {
        "ruleId": {
          "type": "string",
          "metadata": {
            "description": "The values of the rule IDs returned from the matching policy of the destination account."
          }
        },
        "destinationContainer": {
          "type": "string",
          "metadata": {
            "description": "Destination container name."
          }
        },
        "sourceContainer": {
          "type": "string",
          "metadata": {
            "description": "Source container name."
          }
        },
        "filters": {
          "$ref": "#/definitions/objectReplicationRuleFilterType",
          "nullable": true
        }
      }
    },
    "objectReplicationDestinationRuelType": {
      "type": "object",
      "properties": {
        "destinationContainer": {
          "type": "string",
          "metadata": {
            "description": "Destination container name."
          }
        },
        "sourceContainer": {
          "type": "string",
          "metadata": {
            "description": "Source container name."
          }
        },
        "filters": {
          "$ref": "#/definitions/objectReplicationRuleFilterType",
          "nullable": true
        }
      }
    },
    "objectReplicationRuleFilterType": {
      "type": "object",
      "properties": {
        "prefixMatch": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Filters the results to replicate only blobs whose names begin with the specified prefix.."
          }
        },
        "minCreationTime": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Blobs created after the time will be replicated to the destination.\n  It must be in datetime format \"yyyy-MM-ddTHH:mm:ssZ\". Example: 2020-02-19T16:05:00Z.\n  "
          }
        }
      }
    },
    "storageRoleAssignmentsType": {
      "type": "object",
      "properties": {
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Description of role assignment."
          }
        },
        "roleDefinitionIdOrName": {
          "type": "string",
          "metadata": {
            "description": "The role definition ID, or the name of a built-in role from the list var.builtInRoles."
          }
        },
        "principalId": {
          "type": "string"
        },
        "delegatedManagedIdentityResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Id of the delegated managed identity resource."
          }
        },
        "principalType": {
          "type": "string",
          "allowedValues": [
            "Device",
            "ForeignGroup",
            "Group",
            "ServicePrincipal",
            "User"
          ],
          "nullable": true
        }
      }
    },
    "containerRoleAssignmentsArray": {
      "type": "object",
      "properties": {
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Description of role assignment."
          }
        },
        "roleDefinitionIdOrName": {
          "type": "string",
          "metadata": {
            "description": "The role definition ID, or the name of a built-in role from the list var.builtInRoles."
          }
        },
        "principalId": {
          "type": "string"
        },
        "delegatedManagedIdentityResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Id of the delegated managed identity resource."
          }
        },
        "principalType": {
          "type": "string",
          "allowedValues": [
            "Device",
            "ForeignGroup",
            "Group",
            "ServicePrincipal",
            "User"
          ],
          "nullable": true
        },
        "containerName": {
          "type": "string"
        }
      }
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Deployment Location. It defaults to the location of the resource group."
      }
    },
    "prefix": {
      "type": "string",
      "defaultValue": "st",
      "metadata": {
        "description": "Prefix of Storage Account Resource Name. This param is ignored when name is provided."
      }
    },
    "name": {
      "type": "string",
      "defaultValue": "[format('{0}{1}', parameters('prefix'), uniqueString(resourceGroup().id, parameters('location')))]",
      "minLength": 3,
      "maxLength": 24,
      "metadata": {
        "description": "Name of Storage Account. Must be unique within Azure."
      }
    },
    "tags": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "defaultValue": {},
      "metadata": {
        "description": "Tags to be applied to the Storage Account."
      }
    },
    "isZoneRedundant": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "This toggle changes the default value of the sku parameter from Standard_LRS to Standard_ZRS."
      }
    },
    "sku": {
      "type": "string",
      "defaultValue": "[if(parameters('isZoneRedundant'), 'Standard_ZRS', 'Standard_LRS')]",
      "allowedValues": [
        "Premium_LRS",
        "Premium_ZRS",
        "Standard_GRS",
        "Standard_GZRS",
        "Standard_LRS",
        "Standard_RAGRS",
        "Standard_RAGZRS",
        "Standard_ZRS"
      ],
      "metadata": {
        "description": "Storage Account SKU."
      }
    },
    "kind": {
      "type": "string",
      "defaultValue": "StorageV2",
      "allowedValues": [
        "BlobStorage",
        "BlockBlobStorage",
        "FileStorage",
        "Storage",
        "StorageV2"
      ],
      "metadata": {
        "description": "Storage Account Kind."
      }
    },
    "identityType": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "SystemAssigned",
        "SystemAssigned,UserAssigned",
        "UserAssigned"
      ],
      "metadata": {
        "description": "The type of identity used for the storage account. The type \"SystemAssigned, UserAssigned\" includes both an implicitly created identity and a set of user-assigned identities. The type \"None\" will remove any identities from the resource."
      }
    },
    "userAssignedIdentities": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "The list of user-assigned managed identities. The user identity dictionary key references will be ARM resource ids in the form: \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/{identityName}\""
      }
    },
    "accessTier": {
      "type": "string",
      "defaultValue": "Hot",
      "allowedValues": [
        "Cool",
        "Hot"
      ],
      "metadata": {
        "description": "The access tier of the storage account, which is used for billing.\nRequired for storage accounts where kind = BlobStorage. The 'Premium' access tier is the default value for premium block blobs storage account type and it cannot be changed for the premium block blobs storage account type.\n"
      }
    },
    "allowBlobPublicAccess": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow or disallow public access to all blobs or containers in the storage account."
      }
    },
    "allowCrossTenantReplication": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Replication of objects between AAD tenants is allowed or not. For this property, the default interpretation is true."
      }
    },
    "allowedCopyScope": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "bool"
        },
        "scope": {
          "type": "string",
          "allowedValues": [
            "AAD",
            "PrivateLink"
          ],
          "nullable": true,
          "metadata": {
            "description": "Required when enable=true."
          }
        }
      },
      "defaultValue": {
        "enable": false
      },
      "metadata": {
        "description": "Restrict copy to and from Storage Accounts within an AAD tenant or with Private Links to the same VNet."
      }
    },
    "allowSharedKeyAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Indicates whether the storage account permits requests to be authorized with the account access key via Shared Key. If false, then all requests, including shared access signatures, must be authorized with Azure Active Directory (Azure AD)."
      }
    },
    "azureFilesIdentityBasedAuthentication": {
      "$ref": "#/definitions/azureFilesIdentityBasedAuthenticationType",
      "defaultValue": {
        "enable": false
      },
      "metadata": {
        "description": "Provides the identity based authentication settings for Azure Files."
      }
    },
    "defaultToOAuthAuthentication": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "A boolean flag which indicates whether the default authentication is OAuth or not."
      }
    },
    "dnsEndpointType": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "AzureDnsZone",
        "Standard"
      ],
      "metadata": {
        "description": "Allows you to specify the type of endpoint. Set this to AzureDNSZone to create a large number of accounts in a single subscription, which creates accounts in an Azure DNS Zone and the endpoint URL will have an alphanumeric DNS Zone identifier."
      }
    },
    "encryption": {
      "$ref": "#/definitions/encryptionType",
      "defaultValue": {
        "enable": false
      },
      "metadata": {
        "description": "Encryption settings to be used for server-side encryption for the storage account."
      }
    },
    "enableHns": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Account HierarchicalNamespace enabled if sets to true."
      }
    },
    "enableLocalUser": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enables local users feature, if set to true."
      }
    },
    "enableNfsV3": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "NFS 3.0 protocol support enabled if set to true."
      }
    },
    "enableSftp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enables Secure File Transfer Protocol, if set to true."
      }
    },
    "accessKeyPolicy": {
      "$ref": "#/definitions/accessKeyPolicyType",
      "defaultValue": {
        "enable": false
      },
      "metadata": {
        "description": "Policies for the access keys of the storage account."
      }
    },
    "enablelargeFileShares": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow large file shares if sets to Enabled. It cannot be disabled once it is enabled."
      }
    },
    "networkAcls": {
      "$ref": "#/definitions/networkAclsType",
      "defaultValue": {
        "defaultAction": "Allow"
      },
      "metadata": {
        "description": "Configuration for network access rules."
      }
    },
    "routingPreference": {
      "$ref": "#/definitions/routingPreferenceType",
      "defaultValue": {
        "routingChoice": "MicrosoftRouting"
      },
      "metadata": {
        "description": "Network routing choice for data transfer."
      }
    },
    "sasTokenPolicy": {
      "$ref": "#/definitions/sasTokenPolicyType",
      "defaultValue": {
        "enable": false
      },
      "metadata": {
        "description": "SasPolicy assigned to the storage account."
      }
    },
    "supportHttpsTrafficOnly": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allows https traffic only to storage service if sets to true."
      }
    },
    "enablePublicNetworkAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allow or disallow public network access to Storage Account. Value is optional but if passed in, must be Enabled or Disabled."
      }
    },
    "minimumTlsVersion": {
      "type": "string",
      "defaultValue": "TLS1_2",
      "allowedValues": [
        "TLS1_0",
        "TLS1_1",
        "TLS1_2"
      ],
      "metadata": {
        "description": "Set the minimum TLS version to be permitted on requests to storage. The default interpretation is TLS 1.0 for this property."
      }
    },
    "privateEndpoints": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/privateEndpointType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Private Endpoints that should be created for the storage account."
      }
    },
    "blobServiceProperties": {
      "$ref": "#/definitions/blobServicePropertiesType",
      "defaultValue": {},
      "metadata": {
        "description": "Properties object for a Blob service of a Storage Account."
      }
    },
    "blobContainers": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/blobContainerType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Array of blob containers to be created for blobServices of Storage Account."
      }
    },
    "managementPolicyRules": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/managementPolicyRuleType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Configuration for the blob inventory policy."
      }
    },
    "objectReplicationSourcePolicy": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/objectReplicationSourcePolicyType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Configure object replication on a source storage accounts.\nThis config only applies to the current storage account managed by this module.\n"
      }
    },
    "objectReplicationDestinationPolicy": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/objectReplicationDestinationPolicyType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Configure object replication on a destination storage accounts.\nThis config only applies to the current storage account managed by this module.\n"
      }
    },
    "storageRoleAssignments": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/storageRoleAssignmentsType"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Array of role assignment objects with Storage Account scope that contain the 'roleDefinitionIdOrName', 'principalId' and 'principalType' to define RBAC role assignments on that resource. In the roleDefinitionIdOrName attribute, you can provide either the display name of the role definition, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'"
      }
    },
    "containerRoleAssignments": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/containerRoleAssignmentsArray"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Array of role assignment objects with blobServices/containers scope that contain the 'containerName', 'roleDefinitionIdOrName', 'principalId' and 'principalType' to define RBAC role assignments on that resource. In the roleDefinitionIdOrName attribute, you can provide either the display name of the role definition, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "managementPolicyRulesWithDefaults",
        "count": "[length(parameters('managementPolicyRules'))]",
        "input": "[union(parameters('managementPolicyRules')[copyIndex('managementPolicyRulesWithDefaults')], createObject('enabled', coalesce(tryGet(parameters('managementPolicyRules')[copyIndex('managementPolicyRulesWithDefaults')], 'enabled'), true()), 'type', 'Lifecycle'))]"
      },
      {
        "name": "varNetworkAclsIpRules",
        "count": "[length(coalesce(tryGet(parameters('networkAcls'), 'ipAllowlist'), createArray()))]",
        "input": {
          "action": "Allow",
          "value": "[coalesce(tryGet(parameters('networkAcls'), 'ipAllowlist'), createArray())[copyIndex('varNetworkAclsIpRules')]]"
        }
      },
      {
        "name": "varNetworkAclsVirtualNetworkRules",
        "count": "[length(coalesce(tryGet(parameters('networkAcls'), 'subnetIds'), createArray()))]",
        "input": {
          "action": "Allow",
          "id": "[coalesce(tryGet(parameters('networkAcls'), 'subnetIds'), createArray())[copyIndex('varNetworkAclsVirtualNetworkRules')]]"
        }
      },
      {
        "name": "objectReplicationDestinationPolicyWithName",
        "count": "[length(parameters('objectReplicationDestinationPolicy'))]",
        "input": "[union(parameters('objectReplicationDestinationPolicy')[copyIndex('objectReplicationDestinationPolicyWithName')], createObject('sourceStorageAccountName', last(split(parameters('objectReplicationDestinationPolicy')[copyIndex('objectReplicationDestinationPolicyWithName')].sourceStorageAccountId, '/'))))]"
      },
      {
        "name": "objectReplicationSourcePolicyWithName",
        "count": "[length(parameters('objectReplicationSourcePolicy'))]",
        "input": "[union(parameters('objectReplicationSourcePolicy')[copyIndex('objectReplicationSourcePolicyWithName')], createObject('destinationStorageAccountName', last(split(parameters('objectReplicationSourcePolicy')[copyIndex('objectReplicationSourcePolicyWithName')].destinationStorageAccountId, '/'))))]"
      }
    ],
    "isPremium": "[contains(parameters('sku'), 'Premium')]",
    "varNetworkAcls": {
      "bypass": "[coalesce(tryGet(parameters('networkAcls'), 'bypass'), 'AzureServices')]",
      "defaultAction": "[parameters('networkAcls').defaultAction]",
      "ipRules": "[variables('varNetworkAclsIpRules')]",
      "resourceAccessRules": "[tryGet(parameters('networkAcls'), 'resourceAccessRules')]",
      "virtualNetworkRules": "[variables('varNetworkAclsVirtualNetworkRules')]"
    },
    "builtInRoles": {
      "Owner": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
      "Contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
      "Reader": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
      "Avere Contributor": "4f8fab4f-1852-4a58-a46a-8eaf358af14a",
      "Avere Operator": "c025889f-8102-4ebf-b32c-fc0c6f0c6bd9",
      "Backup Contributor": "5e467623-bb1f-42f4-a55d-6e525e11384b",
      "Backup Operator": "00c29273-979b-4161-815c-10b084fb9324",
      "Backup Reader": "a795c7a0-d4a2-40c1-ae25-d81f01202912",
      "Classic Storage Account Contributor": "86e8f5dc-a6e9-4c67-9d15-de283e8eac25",
      "Classic Storage Account Key Operator Service Role": "985d6b00-f706-48f5-a6fe-d0ca12fb668d",
      "Data Box Contributor": "add466c9-e687-43fc-8d98-dfcf8d720be5",
      "Data Box Reader": "028f4ed7-e2a9-465e-a8f4-9c0ffdfdc027",
      "Data Lake Analytics Developer": "47b7735b-770e-4598-a7da-8b91488b4c88",
      "Elastic SAN Owner": "80dcbedb-47ef-405d-95bd-188a1b4ac406",
      "Elastic SAN Reader": "af6a70f8-3c9f-4105-acf1-d719e9fca4ca",
      "Elastic SAN Volume Group Owner": "a8281131-f312-4f34-8d98-ae12be9f0d23",
      "Reader and Data Access": "c12c1c16-33a1-487b-954d-41c89c60f349",
      "Storage Account Backup Contributor": "e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1",
      "Storage Account Contributor": "17d1049b-9a84-46fb-8f53-869881c3d3ab",
      "Storage Account Key Operator Service Role": "81a9662b-bebf-436f-a333-f67b29880f12",
      "Storage Blob Data Contributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
      "Storage Blob Data Owner": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
      "Storage Blob Data Reader": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
      "Storage Blob Delegator": "db58b8e5-c6ad-4a2a-8342-4190687cbf4a",
      "Storage File Data SMB Share Contributor": "0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb",
      "Storage File Data SMB Share Elevated Contributor": "a7264617-510b-434b-a828-9731dc254ea7",
      "Storage File Data SMB Share Reader": "aba4ae5f-2193-4029-9191-0cb91df5e314",
      "Storage Queue Data Contributor": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
      "Storage Queue Data Message Processor": "8a0f0c08-91a1-4084-bc3d-661d67233fed",
      "Storage Queue Data Message Sender": "c6a89b2d-59bc-44d0-9896-0f6e12d7b80a",
      "Storage Queue Data Reader": "19e7f393-937e-4f77-808e-94535e297925",
      "Storage Table Data Contributor": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
      "Storage Table Data Reader": "76199698-9eea-4c19-bc75-cec21354c6b6"
    }
  },
  "resources": {
    "storageAccount": {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "[parameters('sku')]"
      },
      "kind": "[parameters('kind')]",
      "identity": {
        "type": "[parameters('identityType')]",
        "userAssignedIdentities": "[if(contains(parameters('identityType'), 'UserAssigned'), toObject(parameters('userAssignedIdentities'), lambda('id', lambdaVariables('id')), lambda('id', createObject())), null())]"
      },
      "properties": "[union(createObject('accessTier', if(variables('isPremium'), 'Premium', parameters('accessTier')), 'allowBlobPublicAccess', parameters('allowBlobPublicAccess'), 'allowCrossTenantReplication', parameters('allowCrossTenantReplication'), 'allowSharedKeyAccess', parameters('allowSharedKeyAccess'), 'defaultToOAuthAuthentication', parameters('defaultToOAuthAuthentication'), 'dnsEndpointType', parameters('dnsEndpointType'), 'isHnsEnabled', parameters('enableHns'), 'isLocalUserEnabled', parameters('enableLocalUser'), 'isNfsV3Enabled', parameters('enableNfsV3'), 'isSftpEnabled', parameters('enableSftp'), 'largeFileSharesState', if(parameters('enablelargeFileShares'), 'Enabled', 'Disabled'), 'minimumTlsVersion', parameters('minimumTlsVersion'), 'networkAcls', variables('varNetworkAcls'), 'publicNetworkAccess', if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled'), 'routingPreference', parameters('routingPreference'), 'supportsHttpsTrafficOnly', parameters('supportHttpsTrafficOnly')), if(parameters('allowedCopyScope').enable, createObject('allowedCopyScope', parameters('allowedCopyScope').scope), createObject()), if(parameters('encryption').enable, createObject('encryption', parameters('encryption').configurations), createObject()), if(parameters('accessKeyPolicy').enable, createObject('keyPolicy', parameters('accessKeyPolicy').keyExpirationPeriodInDays), createObject()), if(parameters('sasTokenPolicy').enable, createObject('sasPolicy', parameters('sasTokenPolicy').configurations), createObject()), if(parameters('azureFilesIdentityBasedAuthentication').enable, createObject('azureFilesIdentityBasedAuthentication', parameters('azureFilesIdentityBasedAuthentication').configurations), createObject()))]"
    },
    "managementpolicy": {
      "condition": "[not(empty(variables('managementPolicyRulesWithDefaults')))]",
      "type": "Microsoft.Storage/storageAccounts/managementPolicies",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
      "properties": {
        "policy": {
          "rules": "[variables('managementPolicyRulesWithDefaults')]"
        }
      },
      "dependsOn": [
        "blobService",
        "storageAccount"
      ]
    },
    "blobService": {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
      "properties": "[parameters('blobServiceProperties')]",
      "dependsOn": [
        "storageAccount"
      ]
    },
    "blobContainer": {
      "copy": {
        "name": "blobContainer",
        "count": "[length(parameters('blobContainers'))]"
      },
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('blobContainers')[copyIndex()].name)]",
      "properties": "[coalesce(tryGet(parameters('blobContainers')[copyIndex()], 'properties'), createObject())]",
      "dependsOn": [
        "blobService"
      ]
    },
    "storageAccount_RoleAssignment": {
      "copy": {
        "name": "storageAccount_RoleAssignment",
        "count": "[length(parameters('storageRoleAssignments'))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('name'))]",
      "name": "[guid(parameters('name'), parameters('storageRoleAssignments')[copyIndex()].principalId, parameters('storageRoleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
      "properties": {
        "description": "[coalesce(tryGet(parameters('storageRoleAssignments')[copyIndex()], 'description'), '')]",
        "roleDefinitionId": "[if(contains(variables('builtInRoles'), parameters('storageRoleAssignments')[copyIndex()].roleDefinitionIdOrName), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('builtInRoles')[parameters('storageRoleAssignments')[copyIndex()].roleDefinitionIdOrName]), parameters('storageRoleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
        "principalId": "[parameters('storageRoleAssignments')[copyIndex()].principalId]",
        "principalType": "[tryGet(parameters('storageRoleAssignments')[copyIndex()], 'principalType')]"
      },
      "dependsOn": [
        "storageAccount"
      ]
    },
    "storageAccount_containerRoleAssignment": {
      "copy": {
        "name": "storageAccount_containerRoleAssignment",
        "count": "[length(parameters('containerRoleAssignments'))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}/containers/{2}', parameters('name'), 'default', parameters('blobContainers')[indexOf(map(parameters('blobContainers'), lambda('container', lambdaVariables('container').name)), parameters('containerRoleAssignments')[copyIndex()].containerName)].name)]",
      "name": "[guid(parameters('name'), parameters('containerRoleAssignments')[copyIndex()].principalId, parameters('containerRoleAssignments')[copyIndex()].roleDefinitionIdOrName, parameters('containerRoleAssignments')[copyIndex()].containerName)]",
      "properties": {
        "description": "[coalesce(tryGet(parameters('containerRoleAssignments')[copyIndex()], 'description'), '')]",
        "roleDefinitionId": "[if(contains(variables('builtInRoles'), parameters('containerRoleAssignments')[copyIndex()].roleDefinitionIdOrName), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('builtInRoles')[parameters('containerRoleAssignments')[copyIndex()].roleDefinitionIdOrName]), parameters('containerRoleAssignments')[copyIndex()].roleDefinitionIdOrName)]",
        "principalId": "[parameters('containerRoleAssignments')[copyIndex()].principalId]",
        "principalType": "[tryGet(parameters('containerRoleAssignments')[copyIndex()], 'principalType')]"
      },
      "dependsOn": [
        "blobContainer",
        "storageAccount"
      ]
    },
    "storageAccount_objectReplicationSourcePolicy": {
      "copy": {
        "name": "storageAccount_objectReplicationSourcePolicy",
        "count": "[length(variables('objectReplicationSourcePolicyWithName'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[join(createArray(parameters('name'), 'to', variables('objectReplicationSourcePolicyWithName')[copyIndex()].destinationStorageAccountName), '-')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('name')]"
          },
          "policy": {
            "value": "[union(variables('objectReplicationSourcePolicyWithName')[copyIndex()], createObject('id', variables('objectReplicationSourcePolicyWithName')[copyIndex()].policyId, 'type', 'source', 'sourceStorageAccountId', resourceId('Microsoft.Storage/storageAccounts', parameters('name'))))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.20.4.51522",
              "templateHash": "57663108792819753"
            }
          },
          "definitions": {
            "objectReplicationPolicyType": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "type": {
                  "type": "string",
                  "allowedValues": [
                    "destination",
                    "source"
                  ]
                },
                "destinationStorageAccountId": {
                  "type": "string",
                  "metadata": {
                    "description": "The ID of the source storage account."
                  }
                },
                "sourceStorageAccountId": {
                  "type": "string"
                },
                "rules": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/objectReplicationRuelType"
                  }
                }
              }
            },
            "objectReplicationRuelType": {
              "type": "object",
              "properties": {
                "ruleId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "  The ID of the rule. It should be obtaineed from the object relication policy rules of the destination storage account.\n  Required if the policyType is \"source\".\n  "
                  }
                },
                "destinationContainer": {
                  "type": "string",
                  "metadata": {
                    "description": "Destination container name."
                  }
                },
                "sourceContainer": {
                  "type": "string",
                  "metadata": {
                    "description": "Source container name."
                  }
                },
                "filters": {
                  "type": "object",
                  "nullable": true
                }
              }
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string"
            },
            "policy": {
              "$ref": "#/definitions/objectReplicationPolicyType"
            }
          },
          "resources": {
            "storageAccount": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-05-01",
              "name": "[parameters('storageAccountName')]"
            },
            "storageAccount_objectReplicationPolicy": {
              "type": "Microsoft.Storage/storageAccounts/objectReplicationPolicies",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), if(equals(parameters('policy').type, 'source'), parameters('policy').id, 'default'))]",
              "properties": {
                "copy": [
                  {
                    "name": "rules",
                    "count": "[length(coalesce(tryGet(parameters('policy'), 'rules'), createArray()))]",
                    "input": {
                      "ruleId": "[if(equals(parameters('policy').type, 'source'), coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')].ruleId, null())]",
                      "sourceContainer": "[coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')].sourceContainer]",
                      "destinationContainer": "[coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')].destinationContainer]",
                      "filters": "[tryGet(coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')], 'filters')]"
                    }
                  }
                ],
                "sourceAccount": "[parameters('policy').sourceStorageAccountId]",
                "destinationAccount": "[parameters('policy').destinationStorageAccountId]"
              }
            }
          },
          "outputs": {
            "policyId": {
              "type": "string",
              "value": "[reference('storageAccount_objectReplicationPolicy').policyId]"
            },
            "ruleIds": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "value": "[map(reference('storageAccount_objectReplicationPolicy').rules, lambda('rule', lambdaVariables('rule').ruleId))]"
            }
          }
        }
      },
      "dependsOn": [
        "storageAccount"
      ]
    },
    "storageAccount_objectReplicationDestinationPolicy": {
      "copy": {
        "name": "storageAccount_objectReplicationDestinationPolicy",
        "count": "[length(variables('objectReplicationDestinationPolicyWithName'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[join(createArray(variables('objectReplicationDestinationPolicyWithName')[copyIndex()].sourceStorageAccountName, 'to', parameters('name')), '-')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('name')]"
          },
          "policy": {
            "value": "[union(variables('objectReplicationDestinationPolicyWithName')[copyIndex()], createObject('id', 'default', 'type', 'destination', 'destinationStorageAccountId', resourceId('Microsoft.Storage/storageAccounts', parameters('name'))))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.20.4.51522",
              "templateHash": "57663108792819753"
            }
          },
          "definitions": {
            "objectReplicationPolicyType": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "type": {
                  "type": "string",
                  "allowedValues": [
                    "destination",
                    "source"
                  ]
                },
                "destinationStorageAccountId": {
                  "type": "string",
                  "metadata": {
                    "description": "The ID of the source storage account."
                  }
                },
                "sourceStorageAccountId": {
                  "type": "string"
                },
                "rules": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/objectReplicationRuelType"
                  }
                }
              }
            },
            "objectReplicationRuelType": {
              "type": "object",
              "properties": {
                "ruleId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "  The ID of the rule. It should be obtaineed from the object relication policy rules of the destination storage account.\n  Required if the policyType is \"source\".\n  "
                  }
                },
                "destinationContainer": {
                  "type": "string",
                  "metadata": {
                    "description": "Destination container name."
                  }
                },
                "sourceContainer": {
                  "type": "string",
                  "metadata": {
                    "description": "Source container name."
                  }
                },
                "filters": {
                  "type": "object",
                  "nullable": true
                }
              }
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string"
            },
            "policy": {
              "$ref": "#/definitions/objectReplicationPolicyType"
            }
          },
          "resources": {
            "storageAccount": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-05-01",
              "name": "[parameters('storageAccountName')]"
            },
            "storageAccount_objectReplicationPolicy": {
              "type": "Microsoft.Storage/storageAccounts/objectReplicationPolicies",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), if(equals(parameters('policy').type, 'source'), parameters('policy').id, 'default'))]",
              "properties": {
                "copy": [
                  {
                    "name": "rules",
                    "count": "[length(coalesce(tryGet(parameters('policy'), 'rules'), createArray()))]",
                    "input": {
                      "ruleId": "[if(equals(parameters('policy').type, 'source'), coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')].ruleId, null())]",
                      "sourceContainer": "[coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')].sourceContainer]",
                      "destinationContainer": "[coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')].destinationContainer]",
                      "filters": "[tryGet(coalesce(tryGet(parameters('policy'), 'rules'), createArray())[copyIndex('rules')], 'filters')]"
                    }
                  }
                ],
                "sourceAccount": "[parameters('policy').sourceStorageAccountId]",
                "destinationAccount": "[parameters('policy').destinationStorageAccountId]"
              }
            }
          },
          "outputs": {
            "policyId": {
              "type": "string",
              "value": "[reference('storageAccount_objectReplicationPolicy').policyId]"
            },
            "ruleIds": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "value": "[map(reference('storageAccount_objectReplicationPolicy').rules, lambda('rule', lambdaVariables('rule').ruleId))]"
            }
          }
        }
      },
      "dependsOn": [
        "storageAccount"
      ]
    },
    "storageAccount_privateEndpoints": {
      "copy": {
        "name": "storageAccount_privateEndpoints",
        "count": "[length(parameters('privateEndpoints'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[uniqueString(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), parameters('privateEndpoints')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "targetResourceId": {
            "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "endpoint": {
            "value": "[parameters('privateEndpoints')[copyIndex()]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "1.10-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
            "_generator": {
              "name": "bicep",
              "version": "0.20.4.51522",
              "templateHash": "6354356391494568367"
            }
          },
          "parameters": {
            "targetResourceId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "endpoint": {
              "type": "object"
            }
          },
          "variables": {
            "manualApprovalEnabled": "[coalesce(tryGet(parameters('endpoint'), 'isManualApproval'), false())]"
          },
          "resources": {
            "privateEndpoint::privateDnsZoneGroup": {
              "condition": "[not(equals(tryGet(parameters('endpoint'), 'privateDnsZoneId'), null()))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('endpoint').name, 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "default",
                    "properties": {
                      "privateDnsZoneId": "[parameters('endpoint').privateDnsZoneId]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "privateEndpoint"
              ]
            },
            "privateEndpoint": {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2022-07-01",
              "name": "[parameters('endpoint').name]",
              "location": "[parameters('location')]",
              "tags": "[coalesce(tryGet(parameters('endpoint'), 'tags'), createObject())]",
              "properties": {
                "privateLinkServiceConnections": "[if(variables('manualApprovalEnabled'), null(), createArray(createObject('name', parameters('endpoint').name, 'properties', createObject('privateLinkServiceId', parameters('targetResourceId'), 'groupIds', createArray(parameters('endpoint').groupId)))))]",
                "manualPrivateLinkServiceConnections": "[if(variables('manualApprovalEnabled'), createArray(createObject('name', parameters('endpoint').name, 'properties', createObject('privateLinkServiceId', parameters('targetResourceId'), 'groupIds', createArray(parameters('endpoint').groupId)))), null())]",
                "subnet": {
                  "id": "[parameters('endpoint').subnetId]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "storageAccount"
      ]
    }
  },
  "outputs": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the Storage Account resource"
      },
      "value": "[parameters('name')]"
    },
    "id": {
      "type": "string",
      "metadata": {
        "description": "The ID of the Storage Account. Use this ID to reference the Storage Account in other Azure resource deployments."
      },
      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
    },
    "objectReplicationDestinationPolicyIdsAndRuleIds": {
      "type": "array",
      "metadata": {
        "description": "Array of Object Replication Policy IDs and Object Replication PolicyID Rules for OR Policy"
      },
      "copy": {
        "count": "[length(variables('objectReplicationDestinationPolicyWithName'))]",
        "input": {
          "sourceStorageAccountName": "[variables('objectReplicationDestinationPolicyWithName')[copyIndex()].sourceStorageAccountName]",
          "policyId": "[reference(format('storageAccount_objectReplicationDestinationPolicy[{0}]', copyIndex())).outputs.policyId.value]",
          "ruleIds": "[reference(format('storageAccount_objectReplicationDestinationPolicy[{0}]', copyIndex())).outputs.ruleIds.value]"
        }
      }
    }
  }
}