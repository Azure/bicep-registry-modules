# Storage Accounts

This module deploys Microsoft.Storage Storage Accounts and optionally available children or extensions

## Parameters

| Name                                    | Type     | Required | Description                                                                                                                                                                                                                                                                                                                                                                                                    |
| :-------------------------------------- | :------: | :------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`                                  | `string` | No       | Optional. Name of the Storage Account. Autogenerated with a unique string if not provided.                                                                                                                                                                                                                                                                                                                     |
| `location`                              | `string` | No       | Optional. Location for all resources.                                                                                                                                                                                                                                                                                                                                                                          |
| `roleAssignments`                       | `array`  | No       | Optional. Array of role assignment objects that contain the 'roleDefinitionIdOrName' and 'principalId' to define RBAC role assignments on this resource. In the roleDefinitionIdOrName attribute, you can provide either the display name of the role definition, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11' |
| `systemAssignedIdentity`                | `bool`   | No       | Optional. Enables system assigned managed identity on the resource.                                                                                                                                                                                                                                                                                                                                            |
| `userAssignedIdentities`                | `object` | No       | Optional. The ID(s) to assign to the resource.                                                                                                                                                                                                                                                                                                                                                                 |
| `storageAccountKind`                    | `string` | No       | Optional. Type of Storage Account to create.                                                                                                                                                                                                                                                                                                                                                                   |
| `storageAccountSku`                     | `string` | No       | Optional. Storage Account Sku Name.                                                                                                                                                                                                                                                                                                                                                                            |
| `storageAccountAccessTier`              | `string` | No       | Optional. Storage Account Access Tier.                                                                                                                                                                                                                                                                                                                                                                         |
| `azureFilesIdentityBasedAuthentication` | `object` | No       | Optional. Provides the identity based authentication settings for Azure Files.                                                                                                                                                                                                                                                                                                                                 |
| `privateEndpoints`                      | `array`  | No       | Optional. Configuration Details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible                                                                                                                                                                                                                                                                      |
| `managementPolicyRules`                 | `array`  | No       | Optional. The Storage Account ManagementPolicies Rules.                                                                                                                                                                                                                                                                                                                                                        |
| `networkAcls`                           | `object` | No       | Optional. Networks ACLs, this value contains IPs to whitelist and/or Subnet information. For security reasons, it is recommended to set the DefaultAction Deny                                                                                                                                                                                                                                                 |
| `requireInfrastructureEncryption`       | `bool`   | No       | Optional. A boolean indicating whether or not the service applies a secondary layer of encryption with platform managed keys for data at rest. For security reasons, it is recommended to set it to true.                                                                                                                                                                                                      |
| `blobServices`                          | `object` | No       | Optional. Blob service and containers to deploy                                                                                                                                                                                                                                                                                                                                                                |
| `fileServices`                          | `object` | No       | Optional. File service and shares to deploy                                                                                                                                                                                                                                                                                                                                                                    |
| `queueServices`                         | `object` | No       | Optional. Queue service and queues to create.                                                                                                                                                                                                                                                                                                                                                                  |
| `tableServices`                         | `object` | No       | Optional. Table service and tables to create.                                                                                                                                                                                                                                                                                                                                                                  |
| `allowBlobPublicAccess`                 | `bool`   | No       | Optional. Indicates whether public access is enabled for all blobs or containers in the storage account. For security reasons, it is recommended to set it to false.                                                                                                                                                                                                                                           |
| `minimumTlsVersion`                     | `string` | No       | Optional. Set the minimum TLS version on request to storage.                                                                                                                                                                                                                                                                                                                                                   |
| `enableHierarchicalNamespace`           | `bool`   | No       | Optional. If true, enables Hierarchical Namespace for the storage account                                                                                                                                                                                                                                                                                                                                      |
| `diagnosticLogsRetentionInDays`         | `int`    | No       | Optional. Specifies the number of days that logs will be kept for; a value of 0 will retain data indefinitely.                                                                                                                                                                                                                                                                                                 |
| `diagnosticStorageAccountId`            | `string` | No       | Optional. Resource ID of the diagnostic storage account.                                                                                                                                                                                                                                                                                                                                                       |
| `diagnosticWorkspaceId`                 | `string` | No       | Optional. Resource ID of the diagnostic log analytics workspace.                                                                                                                                                                                                                                                                                                                                               |
| `diagnosticEventHubAuthorizationRuleId` | `string` | No       | Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to.                                                                                                                                                                                                                                                     |
| `diagnosticEventHubName`                | `string` | No       | Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category.                                                                                                                                                                                                                                                       |
| `lock`                                  | `string` | No       | Optional. Specify the type of lock.                                                                                                                                                                                                                                                                                                                                                                            |
| `tags`                                  | `object` | No       | Optional. Tags of the resource.                                                                                                                                                                                                                                                                                                                                                                                |
| `basetime`                              | `string` | No       | Generated. Do not provide a value! This date value is used to generate a SAS token to access the modules.                                                                                                                                                                                                                                                                                                      |
| `publicNetworkAccess`                   | `string` | No       | Optional. Enable or disallow public network access to Storage Account..                                                                                                                                                                                                                                                                                                                                        |
| `supportsHttpsTrafficOnly`              | `bool`   | No       | Optional. Allows HTTPS traffic only to storage service if sets to true.                                                                                                                                                                                                                                                                                                                                        |
| `diagnosticMetricsToEnable`             | `array`  | No       | Optional. The name of metrics that will be streamed.                                                                                                                                                                                                                                                                                                                                                           |
| `diagnosticSettingsName`                | `string` | No       | Optional. The name of the diagnostic setting, if deployed.                                                                                                                                                                                                                                                                                                                                                     |

## Outputs

| Name                      | Type   | Description                                                        |
| :------------------------ | :----: | :----------------------------------------------------------------- |
| resourceId                | string | The resource ID of the deployed storage account                    |
| name                      | string | The name of the deployed storage account                           |
| resourceGroupName         | string | The resource group of the deployed storage account                 |
| primaryBlobEndpoint       | string | The primary blob endpoint reference if blob services are deployed. |
| systemAssignedPrincipalId | string | The principal ID of the system assigned identity.                  |

## Examples

### Example 1

Deployment of `1` storage account using the minimum required parameters.

```bicep
module minstrg 'br/public:storage/storage-account:1.0' = {
  name: '${uniqueString(deployment().name, 'WestEurope')}-minstrg'
  params: {
    name: 'carmlazsamin001'
    location: 'WestEurope'
    allowBlobPublicAccess: false
  }
}
```

### Example 2

Example deployment for `1` storage account version 1.

```bicep
module minstrg 'br/public:storage/storage-account:1.0' = {
  name: '${uniqueString(deployment().name, 'WestEurope')}-strg'
  params: {
    name: 'carmlazsav1001'
    location: 'WestEurope'
    storageAccountKind: 'Storage'
  }
}
```

### Example 3

Example deployment of `1` storage account with `1` NFS file share.

```bicep
module minstrg 'br/public:storage/storage-account:1.0' = {
  name: '${uniqueString(deployment().name, 'WestEurope')}-strg'
  params: {
    name: 'carmlazsax001'
    location: 'WestEurope'
    storageAccountSku: 'Premium_LRS'
    storageAccountKind: 'FileStorage'
    allowBlobPublicAccess: false
    supportsHttpsTrafficOnly: false
    fileServices: {
      shares: [
        {
          name: 'nfsfileshare'
          enabledProtocols: 'NFS'
        }
      ]
    }
  }
}
```

### Example 4

Deployment of `1` storage account with

- `2` Tags
- An enabled firewall with
  - `1` whitelisted subnet
  - `1` whitelisted IP
- `1` Systems-Assigned & `1` User-Assigned identities
- `4` Private Endpoints for blob, queue, table & file
- `1` role assignment for `1` identity
- Diagnostic settings using default settings (all logs & metrics) pointing to a storage account, diagnostic workspace & event hub
- Blob services with
  - Diagnostic settings diagnostic settings using default settings (all logs & metrics) pointing to a storage account, diagnostic workspace & event hub
  - `2` containers - `1` of which with RBAC enabled
- File services with
  - Diagnostic settings diagnostic settings using default settings (all logs & metrics) pointing to a storage account, diagnostic workspace & event hub
  - `2` file shares - `1` of which with RBAC enabled
- Queue services with
  - Diagnostic settings diagnostic settings using default settings (all logs & metrics) pointing to a storage account, diagnostic workspace & event hub
  - `2` queues - `1` of which with RBAC enabled
- Table services with
  - Diagnostic settings diagnostic settings using default settings (all logs & metrics) pointing to a storage account, diagnostic workspace & event hub
  - `2` tables

```bicep
module minstrg 'br/public:storage/storage-account:1.0' = {
  name: '${uniqueString(deployment().name, 'WestEurope')}-strg'
  params: {
    name: 'carmlazsax002'
    location: 'WestEurope'
    storageAccountSku: 'Standard_LRS'
    publicNetworkAccess: 'Disabled'
    allowBlobPublicAccess: false
    supportsHttpsTrafficOnly: false
    requireInfrastructureEncryption: true
    networkAcls: {
      bypass: 'AzureServices'
      defaultAction: 'Deny'
      virtualNetworkRules: [
        {
          id: 'subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Network/virtualNetworks/adp-carml-vnet-strg-01/subnets/carml-az-subnet-x-001'
          action: 'Allow'
        }
      ]
      ipRules: [
        {
            action: 'Allow'
            value: '1.1.1.1'
        }
      ]
    }
    privateEndpoints: [
      {
        subnetResourceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Network/virtualNetworks/adp-carml-vnet-strg-01/subnets/carml-az-subnet-x-002-privateEndpoints'
        service: 'blob'
      }
      {
        subnetResourceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Network/virtualNetworks/adp-carml-vnet-strg-01/subnets/carml-az-subnet-x-002-privateEndpoints'
        service: 'table'
      }
      {
        subnetResourceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Network/virtualNetworks/adp-carml-vnet-strg-01/subnets/carml-az-subnet-x-002-privateEndpoints'
        service: 'queue'
      }
      {
        subnetResourceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Network/virtualNetworks/adp-carml-vnet-strg-01/subnets/carml-az-subnet-x-002-privateEndpoints'
        service: 'file'
      }
    ]
    systemAssignedIdentity: true
    userAssignedIdentities: {
      '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/dep-strg-az-msi-x-01' : {}
    }
    tags: {
      tag1: 'tag1Value'
      tag2: 'tag2Value'
    }
    roleAssignments: [
      {
        roleDefinitionIdOrName: 'Reader'
        principalIds: [
          '222222-2222-2222-2222-2222222222'
        ]
        principalType: 'ServicePrincipal'
      }
    ]
    diagnosticLogsRetentionInDays: 7
    diagnosticStorageAccountId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Storage/storageAccounts/adpcarmlazsastrg01'
    diagnosticWorkspaceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/adp-carml-law-strg-01'
    diagnosticEventHubAuthorizationRuleId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.EventHub/namespaces/adp-carml-evhns-strg-01/authorizationRules/RootManageSharedAccessKey'
    diagnosticEventHubName: 'adp-carml-evh-strg-01'
    blobServices: {
      diagnosticLogsRetentionInDays: 7
      diagnosticStorageAccountId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Storage/storageAccounts/adpcarmlazsastrg01'
      diagnosticWorkspaceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/adp-carml-law-strg-01'
      diagnosticEventHubAuthorizationRuleId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.EventHub/namespaces/adp-carml-evhns-strg-01/authorizationRules/RootManageSharedAccessKey'
      diagnosticEventHubName: 'adp-carml-evh-strg-01'
      containers: [
        {
          name: 'avdscripts'
          publicAccess: 'None'
          roleAssignments: [
            {
              roleDefinitionIdOrName: 'Reader'
              principalIds: [
                '222222-2222-2222-2222-2222222222'
              ]
              principalType: 'ServicePrincipal'
            }
          ]
        }
        {
          name: 'archivecontainer'
          publicAccess: 'None'
          enableWORM: true
          WORMRetention: 666
          allowProtectedAppendWrites: false
        }
      ]
    }
    fileServices: {
      diagnosticLogsRetentionInDays: 7
      diagnosticStorageAccountId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Storage/storageAccounts/adpcarmlazsastrg01'
      diagnosticWorkspaceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/adp-carml-law-strg-01'
      diagnosticEventHubAuthorizationRuleId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.EventHub/namespaces/adp-carml-evhns-strg-01/authorizationRules/RootManageSharedAccessKey'
      diagnosticEventHubName: 'adp-carml-evh-strg-01'
      shares: [
        {
          name: 'avdprofiles'
          shareQuota: '5120'
          roleAssignments: [
            {
              roleDefinitionIdOrName: 'Reader'
              principalIds: [
                '222222-2222-2222-2222-2222222222'
              ]
              principalType: 'ServicePrincipal'
            }
          ]
        }
        {
          name: 'avdprofiles2'
          shareQuota: '5120'
        }
      ]
    }
    tableServices: {
      diagnosticLogsRetentionInDays: 7
      diagnosticStorageAccountId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Storage/storageAccounts/adpcarmlazsastrg01'
      diagnosticWorkspaceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/adp-carml-law-strg-01'
      diagnosticEventHubAuthorizationRuleId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.EventHub/namespaces/adp-carml-evhns-strg-01/authorizationRules/RootManageSharedAccessKey'
      diagnosticEventHubName: 'adp-carml-evh-strg-01'
      tables: [
        'table1'
        'table2'
      ]
    }
    queueServices: {
      diagnosticLogsRetentionInDays: 7
      diagnosticStorageAccountId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.Storage/storageAccounts/adpcarmlazsastrg01'
      diagnosticWorkspaceId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.OperationalInsights/workspaces/adp-carml-law-strg-01'
      diagnosticEventHubAuthorizationRuleId: '/subscriptions/111111-1111-1111-1111-111111111/resourceGroups/myRg/providers/Microsoft.EventHub/namespaces/adp-carml-evhns-strg-01/authorizationRules/RootManageSharedAccessKey'
      diagnosticEventHubName: 'adp-carml-evh-strg-01'
      queues: [
        {
          name: 'queue1'
          metadata: {}
          roleAssignments: [
            {
              roleDefinitionIdOrName: 'Reader'
              principalIds: [
                '222222-2222-2222-2222-2222222222'
              ]
              principalType: 'ServicePrincipal'
            }
          ]
        }
        {
          name: 'queue2'
          metadata: {}
        }
      ]
    }
  }
}
```