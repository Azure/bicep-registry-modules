{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "1.10-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
    "_generator": {
      "name": "bicep",
      "version": "0.16.1.55165",
      "templateHash": "14004663166972599569"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location into which the resources should be deployed"
      }
    },
    "name": {
      "type": "string",
      "defaultValue": "[format('psql{0}', uniqueString(resourceGroup().id, subscription().id, parameters('location')))]",
      "metadata": {
        "description": "The name of the PostgreSQL server"
      },
      "maxLength": 63,
      "minLength": 3
    },
    "administratorLogin": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Database administrator login name"
      }
    },
    "administratorLoginPassword": {
      "type": "securestring",
      "maxLength": 128,
      "minLength": 8,
      "metadata": {
        "description": "Database administrator password"
      }
    },
    "postgresFlexibleServersSkuTier": {
      "type": "string",
      "defaultValue": "Burstable",
      "allowedValues": [
        "Burstable",
        "GeneralPurpose",
        "MemoryOptimized"
      ],
      "metadata": {
        "description": "The tier of the particular SKU, e.g. Burstable"
      }
    },
    "postgresFlexibleServersSkuName": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "metadata": {
        "description": "The name of the sku, typically, tier + family + cores, e.g. Standard_D4s_v3"
      }
    },
    "postgresFlexibleServersversion": {
      "type": "string",
      "defaultValue": "13",
      "allowedValues": [
        "11",
        "12",
        "13"
      ],
      "metadata": {
        "description": "The version of a PostgreSQL server"
      }
    },
    "createMode": {
      "type": "string",
      "defaultValue": "Default",
      "allowedValues": [
        "Create",
        "Default",
        "PointInTimeRestore",
        "Update"
      ],
      "metadata": {
        "description": "The mode to create a new PostgreSQL server"
      }
    },
    "storageSizeGB": {
      "type": "int",
      "defaultValue": 32,
      "allowedValues": [
        32,
        64,
        128,
        256,
        512,
        1024,
        2048,
        4096,
        8192,
        16384
      ],
      "metadata": {
        "description": "The size of the storage in GB"
      }
    },
    "backupRetentionDays": {
      "type": "int",
      "defaultValue": 7,
      "maxValue": 35,
      "minValue": 7,
      "metadata": {
        "description": "The number of days a backup is retained"
      }
    },
    "geoRedundantBackup": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "metadata": {
        "description": "The geo-redundant backup setting"
      }
    },
    "highAvailability": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "Enabled"
      ],
      "metadata": {
        "description": "The high availability mode"
      }
    }
  },
  "resources": {
    "postgresFlexibleServers": {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2022-12-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('postgresFlexibleServersSkuName')]",
        "tier": "[parameters('postgresFlexibleServersSkuTier')]"
      },
      "properties": {
        "administratorLogin": "[parameters('administratorLogin')]",
        "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
        "createMode": "[parameters('createMode')]",
        "storage": {
          "storageSizeGB": "[parameters('storageSizeGB')]"
        },
        "backup": {
          "backupRetentionDays": "[parameters('backupRetentionDays')]",
          "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
        },
        "highAvailability": {
          "mode": "[parameters('highAvailability')]"
        },
        "maintenanceWindow": {
          "customWindow": "Disabled",
          "dayOfWeek": 0,
          "startHour": 0,
          "startMinute": 0
        },
        "version": "[parameters('postgresFlexibleServersversion')]"
      }
    }
  }
}