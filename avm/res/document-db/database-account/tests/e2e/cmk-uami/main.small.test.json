{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "7179469649675238399"
    },
    "name": "Using encryption with Customer-Managed-Key",
    "description": "This instance deploys the module using Customer-Managed-Keys using a User-Assigned Identity to access the Customer-Managed-Key secret."
  },
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[format('dep-{0}-documentdb.databaseaccounts-{1}-rg', parameters('namePrefix'), parameters('serviceShort'))]",
      "maxLength": 90,
      "metadata": {
        "description": "Optional. The name of the resource group to deploy for testing purposes."
      }
    },
    "serviceShort": {
      "type": "string",
      "defaultValue": "dddaenc",
      "metadata": {
        "description": "Optional. A short identifier for the kind of deployment. Should be kept short to not run into resource-name length-constraints."
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "uniq",
      "metadata": {
        "description": "Optional. A token to inject into the name of each resource. This value can be automatically injected by the CI."
      }
    }
  },
  "variables": {
    "enforcedLocation": "eastus2",
    "keyVaultName": "[format('dep-{0}-kv-{1}', parameters('namePrefix'), parameters('serviceShort'))]"
  },
  "resources": {
    "resourceGroup": {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2025-04-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[variables('enforcedLocation')]"
    },
    "nestedDependencies": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-nestedDependencies', uniqueString(deployment().name, variables('enforcedLocation')))]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "managedIdentityName": {
            "value": "[format('dep-{0}-msi-{1}', parameters('namePrefix'), parameters('serviceShort'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17220315235136771729"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Optional. The location to deploy resources to."
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the Key Vault to create."
              }
            },
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the Managed Identity to create."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/keys",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'keyEncryptionKey')]",
              "properties": {
                "kty": "RSA",
                "keySize": 3072
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2024-11-30",
              "name": "[parameters('managedIdentityName')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[tenant().tenantId]",
                "enablePurgeProtection": true,
                "softDeleteRetentionInDays": 7,
                "enabledForTemplateDeployment": true,
                "enabledForDiskEncryption": true,
                "enabledForDeployment": true,
                "enableRbacAuthorization": true,
                "accessPolicies": []
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), 'keyEncryptionKey')]",
              "name": "[guid(format('msi-{0}-{1}-{2}-Key-Reader-RoleAssignment', resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), 'keyEncryptionKey'), parameters('location'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), 'keyEncryptionKey')]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the created Key Vault."
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultEncryptionKeyName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault Encryption Key."
              },
              "value": "keyEncryptionKey"
            },
            "managedIdentityResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the created Managed Identity."
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "testDeployment": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-test-{1}', uniqueString(deployment().name, variables('enforcedLocation')), parameters('serviceShort'))]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}{1}001', parameters('namePrefix'), parameters('serviceShort'))]"
          },
          "zoneRedundant": {
            "value": false
          },
          "customerManagedKey": {
            "value": {
              "keyName": "[reference('nestedDependencies').outputs.keyVaultEncryptionKeyName.value]",
              "keyVaultResourceId": "[reference('nestedDependencies').outputs.keyVaultResourceId.value]"
            }
          },
          "defaultIdentity": {
            "value": {
              "name": "UserAssignedIdentity",
              "resourceId": "[reference('nestedDependencies').outputs.managedIdentityResourceId.value]"
            }
          },
          "managedIdentities": {
            "value": {
              "userAssignedResourceIds": [
                "[reference('nestedDependencies').outputs.managedIdentityResourceId.value]"
              ]
            }
          },
          "networkRestrictions": {
            "value": {
              "publicNetworkAccess": "Enabled"
            }
          },
          "disableKeyBasedMetadataWriteAccess": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18233727509469516299"
            },
            "name": "Azure Cosmos DB account",
            "description": "This module deploys an Azure Cosmos DB account. The API used for the account is determined by the child resources that are deployed."
          },
          "definitions": {
            "customerManagedKeyType": {
              "type": "object",
              "properties": {
                "keyVaultResourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The resource ID of a key vault to reference a customer managed key for encryption from."
                  }
                },
                "keyName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the customer managed key to use for encryption."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of a customer-managed key configuration."
              }
            },
            "privateEndpointOutputType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "The name of the private endpoint."
                  }
                },
                "resourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "The resource ID of the private endpoint."
                  }
                },
                "groupId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "The group ID for the private endpoint group."
                  }
                },
                "customDnsConfigs": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "fqdn": {
                        "type": "string",
                        "nullable": true,
                        "metadata": {
                          "description": "fully-qualified domain name (FQDN) that resolves to private endpoint IP address."
                        }
                      },
                      "ipAddresses": {
                        "type": "array",
                        "items": {
                          "type": "string"
                        },
                        "metadata": {
                          "description": "A list of private IP addresses for the private endpoint."
                        }
                      }
                    }
                  },
                  "metadata": {
                    "description": "The custom DNS configurations of the private endpoint."
                  }
                },
                "networkInterfaceResourceIds": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "metadata": {
                    "description": "The IDs of the network interfaces associated with the private endpoint."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for the private endpoint output."
              }
            },
            "failoverLocationType": {
              "type": "object",
              "properties": {
                "failoverPriority": {
                  "type": "int",
                  "metadata": {
                    "description": "Required. The failover priority of the region. A failover priority of 0 indicates a write region. The maximum value for a failover priority = (total number of regions - 1). Failover priority values must be unique for each of the regions in which the database account exists."
                  }
                },
                "isZoneRedundant": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Flag to indicate whether or not this region is an AvailabilityZone region. Defaults to true."
                  }
                },
                "locationName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the region."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for the failover location."
              }
            },
            "sqlRoleAssignmentType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The unique name of the role assignment."
                  }
                },
                "roleDefinitionId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The unique identifier of the Azure Cosmos DB for NoSQL native role-based access control definition."
                  }
                },
                "principalId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The unique identifier for the associated Microsoft Entra ID principal to which access is being granted through this role-based access control assignment. The tenant ID for the principal is inferred using the tenant associated with the subscription."
                  }
                },
                "scope": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for an Azure Cosmos DB for NoSQL native role-based access control assignment."
              }
            },
            "sqlRoleDefinitionType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The unique identifier of the role-based access control definition."
                  }
                },
                "roleName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. A user-friendly name for the role-based access control definition. This must be unique within the database account."
                  }
                },
                "dataActions": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "minLength": 1,
                  "metadata": {
                    "description": "Required. An array of data actions that are allowed."
                  }
                },
                "assignableScopes": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. A set of fully-qualified scopes at or below which role-based access control assignments may be created using this definition. This setting allows application of this definition on the entire account or any underlying resource. This setting must have at least one element. Scopes higher than the account level are not enforceable as assignable scopes. Resources referenced in assignable scopes do not need to exist at creation. Defaults to the current account scope."
                  }
                },
                "assignments": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/nestedSqlRoleAssignmentType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. An array of role-based access control assignments to be created for the definition."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for an Azure Cosmos DB for NoSQL or Table native role-based access control definition."
              }
            },
            "networkRestrictionType": {
              "type": "object",
              "properties": {
                "ipRules": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. A single IPv4 address or a single IPv4 address range in Classless Inter-Domain Routing (CIDR) format. Provided IPs must be well-formatted and cannot be contained in one of the following ranges: `10.0.0.0/8`, `100.64.0.0/10`, `172.16.0.0/12`, `192.168.0.0/16`, since these are not enforceable by the IP address filter. Example of valid inputs: `23.40.210.245` or `23.40.210.0/8`."
                  }
                },
                "networkAclBypass": {
                  "type": "string",
                  "allowedValues": [
                    "AzureServices",
                    "None"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Specifies the network ACL bypass for Azure services. Default to \"None\"."
                  }
                },
                "publicNetworkAccess": {
                  "type": "string",
                  "allowedValues": [
                    "Disabled",
                    "Enabled"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Whether requests from the public network are allowed. Default to \"Disabled\"."
                  }
                },
                "virtualNetworkRules": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "subnetResourceId": {
                        "type": "string",
                        "metadata": {
                          "description": "Required. Resource ID of a subnet."
                        }
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. List of virtual network access control list (ACL) rules configured for the account."
                  }
                },
                "networkAclBypassResourceIds": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. An array that contains the Resource Ids for Network Acl Bypass for the Cosmos DB account."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for the network restriction."
              }
            },
            "gremlinDatabaseType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the Gremlin database."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases@2024-11-15#properties/tags"
                    },
                    "description": "Optional. Tags of the Gremlin database resource."
                  },
                  "nullable": true
                },
                "graphs": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/graphType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Array of graphs to deploy in the Gremlin database."
                  }
                },
                "maxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored. Setting throughput at the database level is only recommended for development/test or when workload across all graphs in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the graph level and not at the database level."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `maxThroughput`. Setting throughput at the database level is only recommended for development/test or when workload across all graphs in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the graph level and not at the database level."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for a gremlin databae."
              }
            },
            "mongoDbType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the mongodb database."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request Units per second. Setting throughput at the database level is only recommended for development/test or when workload across all collections in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                  }
                },
                "collections": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/collectionType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Collections in the mongodb database."
                  }
                },
                "autoscaleSettings": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases@2025-04-15#properties/properties/properties/options/properties/autoscaleSettings"
                    },
                    "description": "Optional. Specifies the Autoscale settings. Note: Either throughput or autoscaleSettings is required, but not both."
                  },
                  "nullable": true
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases@2025-04-15#properties/tags"
                    },
                    "description": "Optional. Tags of the resource."
                  },
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for a mongo databae."
              }
            },
            "sqlDatabaseType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the SQL database ."
                  }
                },
                "containers": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/containerType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Array of containers to deploy in the SQL database."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. Setting throughput at the database level is only recommended for development/test or when workload across all containers in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                  }
                },
                "autoscaleSettingsMaxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. Setting throughput at the database level is only recommended for development/test or when workload across all containers in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases@2025-04-15#properties/tags"
                    },
                    "description": "Optional. Tags of the SQL database resource."
                  },
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for a sql database."
              }
            },
            "tableType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the table."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/tables@2025-04-15#properties/tags"
                    },
                    "description": "Optional. Tags for the table."
                  },
                  "nullable": true
                },
                "maxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `maxThroughput`."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for a table."
              }
            },
            "cassandraStandaloneRoleAssignmentType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The unique name of the role assignment."
                  }
                },
                "roleDefinitionId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The unique identifier of the Azure Cosmos DB for Apache Cassandra native role-based access control definition."
                  }
                },
                "principalId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The unique identifier for the associated Microsoft Entra ID principal to which access is being granted through this role-based access control assignment. The tenant ID for the principal is inferred using the tenant associated with the subscription."
                  }
                },
                "scope": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The data plane resource path for which access is being granted through this role-based access control assignment. Defaults to the current account."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for an Azure Cosmos DB for Apache Cassandra native role-based access control assignment."
              }
            },
            "cassandraRoleDefinitionType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The unique identifier of the role-based access control definition."
                  }
                },
                "roleName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. A user-friendly name for the role-based access control definition. Must be unique for the database account."
                  }
                },
                "dataActions": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. An array of data actions that are allowed. Note: Valid data action strings are currently undocumented (API version 2025-05-01-preview). Expected to follow format similar to SQL RBAC once documented by Microsoft."
                  }
                },
                "notDataActions": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. An array of data actions that are denied. Note: Unlike SQL RBAC, Cassandra supports deny rules for granular access control. Valid data action strings are currently undocumented (API version 2025-05-01-preview)."
                  }
                },
                "assignableScopes": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. A set of fully qualified Scopes at or below which Role Assignments may be created using this Role Definition."
                  }
                },
                "assignments": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/cassandraRoleAssignmentType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. An array of role-based access control assignments to be created for the definition."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for an Azure Cosmos DB for Apache Cassandra native role-based access control definition."
              }
            },
            "cassandraKeyspaceType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the Cassandra keyspace."
                  }
                },
                "tables": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/cassandraTableType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Array of Cassandra tables to deploy in the keyspace."
                  }
                },
                "views": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/cassandraViewType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Array of Cassandra views (materialized views) to deploy in the keyspace."
                  }
                },
                "autoscaleSettingsMaxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored. Setting throughput at the keyspace level is only recommended for development/test or when workload across all tables in the shared throughput keyspace is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the table level and not at the keyspace level."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `autoscaleSettingsMaxThroughput`. Setting throughput at the keyspace level is only recommended for development/test or when workload across all tables in the shared throughput keyspace is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the table level and not at the keyspace level."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces@2024-11-15#properties/tags"
                    },
                    "description": "Optional. Tags of the Cassandra keyspace resource."
                  },
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for an Azure Cosmos DB Cassandra keyspace."
              }
            },
            "defaultIdentityType": {
              "type": "object",
              "discriminator": {
                "propertyName": "name",
                "mapping": {
                  "FirstPartyIdentity": {
                    "$ref": "#/definitions/defaultIdentityFirstPartyType"
                  },
                  "SystemAssignedIdentity": {
                    "$ref": "#/definitions/defaultIdentitySystemAssignedType"
                  },
                  "UserAssignedIdentity": {
                    "$ref": "#/definitions/defaultIdentityUserAssignedType"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type for the default identity."
              }
            },
            "defaultIdentityFirstPartyType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "FirstPartyIdentity"
                  ],
                  "metadata": {
                    "description": "Required. The type of default identity to use."
                  }
                }
              }
            },
            "defaultIdentitySystemAssignedType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "SystemAssignedIdentity"
                  ],
                  "metadata": {
                    "description": "Required. The type of default identity to use."
                  }
                }
              }
            },
            "defaultIdentityUserAssignedType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "UserAssignedIdentity"
                  ],
                  "metadata": {
                    "description": "Required. The type of default identity to use."
                  }
                },
                "resourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The resource ID of the user assigned identity to use as the default identity."
                  }
                }
              }
            },
            "cassandraRoleAssignmentType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The unique identifier of the role assignment."
                  }
                },
                "principalId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The unique identifier for the associated AAD principal."
                  }
                },
                "scope": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The data plane resource path for which access is being granted. Defaults to the current account."
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "cassandra-role-definition/main.bicep"
                }
              }
            },
            "cassandraTableType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the table."
                  }
                },
                "schema": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/properties/properties/resource/properties/schema"
                    },
                    "description": "Required. Schema definition for the table."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/tags"
                    },
                    "description": "Optional. Tags for the table."
                  },
                  "nullable": true
                },
                "defaultTtl": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Default TTL (Time To Live) in seconds for data in the table."
                  }
                },
                "analyticalStorageTtl": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Analytical TTL for the table."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                  }
                },
                "autoscaleSettingsMaxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Maximum autoscale throughput for the table. Cannot be used with throughput."
                  }
                }
              },
              "metadata": {
                "description": "The type of a Cassandra table.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "cassandra-keyspace/main.bicep",
                  "originalIdentifier": "tableType"
                }
              }
            },
            "cassandraViewType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the view."
                  }
                },
                "viewDefinition": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. View definition (CQL statement)."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/views@2025-05-01-preview#properties/tags"
                    },
                    "description": "Optional. Tags for the view."
                  },
                  "nullable": true
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                  }
                },
                "autoscaleSettingsMaxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Maximum autoscale throughput for the view. Cannot be used with throughput."
                  }
                }
              },
              "metadata": {
                "description": "The type of a Cassandra view (materialized view).",
                "__bicep_imported_from!": {
                  "sourceTemplate": "cassandra-keyspace/main.bicep",
                  "originalIdentifier": "viewType"
                }
              }
            },
            "collectionType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the collection."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Request Units per second. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                  }
                },
                "indexes": {
                  "type": "array",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/indexes"
                    },
                    "description": "Required. Indexes for the collection."
                  }
                },
                "shardKey": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/shardKey"
                    },
                    "description": "Required. ShardKey for the collection."
                  }
                }
              },
              "metadata": {
                "description": "The type of a collection.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "mongodb-database/main.bicep"
                }
              }
            },
            "containerType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the container."
                  }
                },
                "analyticalStorageTtl": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Default to 0. Indicates how long data should be retained in the analytical store, for a container. Analytical store is enabled when ATTL is set with a value other than 0. If the value is set to -1, the analytical store retains all historical data, irrespective of the retention of the data in the transactional store."
                  }
                },
                "conflictResolutionPolicy": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/conflictResolutionPolicy"
                    },
                    "description": "Optional. The conflict resolution policy for the container. Conflicts and conflict resolution policies are applicable if the Azure Cosmos DB account is configured with multiple write regions."
                  },
                  "nullable": true
                },
                "defaultTtl": {
                  "type": "int",
                  "nullable": true,
                  "minValue": -1,
                  "maxValue": 2147483647,
                  "metadata": {
                    "description": "Optional. Default to -1. Default time to live (in seconds). With Time to Live or TTL, Azure Cosmos DB provides the ability to delete items automatically from a container after a certain time period. If the value is set to \"-1\", it is equal to infinity, and items don't expire by default."
                  }
                },
                "throughput": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Default to 400. Request Units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                  }
                },
                "autoscaleSettingsMaxThroughput": {
                  "type": "int",
                  "nullable": true,
                  "maxValue": 1000000,
                  "metadata": {
                    "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/tags"
                    },
                    "description": "Optional. Tags of the SQL Database resource."
                  },
                  "nullable": true
                },
                "paths": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "minLength": 1,
                  "maxLength": 3,
                  "metadata": {
                    "description": "Required. List of paths using which data within the container can be partitioned. For kind=MultiHash it can be up to 3. For anything else it needs to be exactly 1."
                  }
                },
                "indexingPolicy": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                    },
                    "description": "Optional. Indexing policy of the container."
                  },
                  "nullable": true
                },
                "uniqueKeyPolicyKeys": {
                  "type": "array",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/uniqueKeyPolicy/properties/uniqueKeys"
                    },
                    "description": "Optional. The unique key policy configuration containing a list of unique keys that enforces uniqueness constraint on documents in the collection in the Azure Cosmos DB service."
                  },
                  "nullable": true
                },
                "kind": {
                  "type": "string",
                  "allowedValues": [
                    "Hash",
                    "MultiHash"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Default to Hash. Indicates the kind of algorithm used for partitioning."
                  }
                },
                "version": {
                  "type": "int",
                  "allowedValues": [
                    1,
                    2
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Default to 1 for Hash and 2 for MultiHash - 1 is not allowed for MultiHash. Version of the partition key definition."
                  }
                }
              },
              "metadata": {
                "description": "The type of a container.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "sql-database/main.bicep"
                }
              }
            },
            "graphType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Name of the graph."
                  }
                },
                "tags": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/tags"
                    },
                    "description": "Optional. Tags of the Gremlin graph resource."
                  },
                  "nullable": true
                },
                "indexingPolicy": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                    },
                    "description": "Optional. Indexing policy of the graph."
                  },
                  "nullable": true
                },
                "partitionKeyPaths": {
                  "type": "array",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/partitionKey/properties/paths"
                    },
                    "description": "Optional. List of paths using which data within the container can be partitioned."
                  },
                  "nullable": true
                }
              },
              "metadata": {
                "description": "The type of a graph.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "gremlin-database/main.bicep"
                }
              }
            },
            "managedIdentityAllType": {
              "type": "object",
              "properties": {
                "systemAssigned": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Enables system assigned managed identity on the resource."
                  }
                },
                "userAssignedResourceIds": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The resource ID(s) to assign to the resource. Required if a user assigned identity is used for encryption."
                  }
                }
              },
              "metadata": {
                "description": "An AVM-aligned type for a managed identity configuration. To be used if both a system-assigned & user-assigned identities are supported by the resource provider.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                }
              }
            },
            "nestedSqlRoleAssignmentType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Name unique identifier of the SQL Role Assignment."
                  }
                },
                "principalId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                  }
                },
                "scope": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                  }
                }
              },
              "metadata": {
                "description": "The type for the SQL Role Assignments.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "sql-role-definition/main.bicep",
                  "originalIdentifier": "sqlRoleAssignmentType"
                }
              }
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the account."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Optional. Defaults to the current resource group scope location. Location for all resources."
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.DocumentDB/databaseAccounts@2024-11-15#properties/tags"
                },
                "description": "Optional. Tags for the resource."
              },
              "nullable": true
            },
            "managedIdentities": {
              "$ref": "#/definitions/managedIdentityAllType",
              "nullable": true,
              "metadata": {
                "description": "Optional. The managed identity definition for this resource."
              }
            },
            "databaseAccountOfferType": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Standard"
              ],
              "metadata": {
                "description": "Optional. The offer type for the account. Defaults to \"Standard\"."
              }
            },
            "failoverLocations": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/failoverLocationType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. The set of locations enabled for the account. Defaults to the location where the account is deployed."
              }
            },
            "zoneRedundant": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Indicates whether the single-region account is zone redundant. Defaults to true. This property is ignored for multi-region accounts."
              }
            },
            "defaultConsistencyLevel": {
              "type": "string",
              "defaultValue": "Session",
              "allowedValues": [
                "Eventual",
                "ConsistentPrefix",
                "Session",
                "BoundedStaleness",
                "Strong"
              ],
              "metadata": {
                "description": "Optional. The default consistency level of the account. Defaults to \"Session\"."
              }
            },
            "disableLocalAuthentication": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Opt-out of local authentication and ensure that only Microsoft Entra can be used exclusively for authentication. Defaults to true."
              }
            },
            "enableAnalyticalStorage": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Flag to indicate whether to enable storage analytics. Defaults to false."
              }
            },
            "enableAutomaticFailover": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable automatic failover for regions. Defaults to true."
              }
            },
            "enableFreeTier": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Flag to indicate whether \"Free Tier\" is enabled. Defaults to false."
              }
            },
            "enableMultipleWriteLocations": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Enables the account to write in multiple locations. Periodic backup must be used if enabled. Defaults to false."
              }
            },
            "disableKeyBasedMetadataWriteAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Disable write operations on metadata resources (databases, containers, throughput) via account keys. Defaults to true."
              }
            },
            "maxStalenessPrefix": {
              "type": "int",
              "defaultValue": 100000,
              "minValue": 1,
              "maxValue": 2147483647,
              "metadata": {
                "description": "Optional. The maximum stale requests. Required for \"BoundedStaleness\" consistency level. Valid ranges, Single Region: 10 to 1000000. Multi Region: 100000 to 1000000. Defaults to 100000."
              }
            },
            "maxIntervalInSeconds": {
              "type": "int",
              "defaultValue": 300,
              "minValue": 5,
              "maxValue": 86400,
              "metadata": {
                "description": "Optional. The maximum lag time in minutes. Required for \"BoundedStaleness\" consistency level. Valid ranges, Single Region: 5 to 84600. Multi Region: 300 to 86400. Defaults to 300."
              }
            },
            "serverVersion": {
              "type": "string",
              "defaultValue": "4.2",
              "allowedValues": [
                "3.2",
                "3.6",
                "4.0",
                "4.2",
                "5.0",
                "6.0",
                "7.0"
              ],
              "metadata": {
                "description": "Optional. Specifies the MongoDB server version to use if using Azure Cosmos DB for MongoDB RU. Defaults to \"4.2\"."
              }
            },
            "sqlDatabases": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/sqlDatabaseType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Configuration for databases when using Azure Cosmos DB for NoSQL."
              }
            },
            "mongodbDatabases": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/mongoDbType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Configuration for databases when using Azure Cosmos DB for MongoDB RU."
              }
            },
            "gremlinDatabases": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/gremlinDatabaseType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Configuration for databases when using Azure Cosmos DB for Apache Gremlin."
              }
            },
            "tables": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/tableType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Configuration for databases when using Azure Cosmos DB for Table."
              }
            },
            "cassandraKeyspaces": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/cassandraKeyspaceType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Configuration for keyspaces when using Azure Cosmos DB for Apache Cassandra."
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable/Disable usage telemetry for module."
              }
            },
            "totalThroughputLimit": {
              "type": "int",
              "defaultValue": -1,
              "metadata": {
                "description": "Optional. The total throughput limit imposed on this account in request units per second (RU/s). Default to unlimited throughput."
              }
            },
            "capabilitiesToAdd": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "nullable": true,
              "allowedValues": [
                "EnableCassandra",
                "EnableTable",
                "EnableGremlin",
                "EnableMongo",
                "DisableRateLimitingResponses",
                "EnableServerless",
                "EnableNoSQLVectorSearch",
                "EnableNoSQLFullTextSearch",
                "EnableMaterializedViews",
                "DeleteAllItemsByPartitionKey"
              ],
              "metadata": {
                "description": "Optional. A list of Azure Cosmos DB specific capabilities for the account."
              }
            },
            "backupPolicyType": {
              "type": "string",
              "defaultValue": "Continuous",
              "allowedValues": [
                "Periodic",
                "Continuous"
              ],
              "metadata": {
                "description": "Optional. Configures the backup mode. Periodic backup must be used if multiple write locations are used. Defaults to \"Continuous\"."
              }
            },
            "backupPolicyContinuousTier": {
              "type": "string",
              "defaultValue": "Continuous30Days",
              "allowedValues": [
                "Continuous30Days",
                "Continuous7Days"
              ],
              "metadata": {
                "description": "Optional. Configuration values to specify the retention period for continuous mode backup. Default to \"Continuous30Days\"."
              }
            },
            "backupIntervalInMinutes": {
              "type": "int",
              "defaultValue": 240,
              "minValue": 60,
              "maxValue": 1440,
              "metadata": {
                "description": "Optional. An integer representing the interval in minutes between two backups. This setting only applies to the periodic backup type. Defaults to 240."
              }
            },
            "backupRetentionIntervalInHours": {
              "type": "int",
              "defaultValue": 8,
              "minValue": 2,
              "maxValue": 720,
              "metadata": {
                "description": "Optional. An integer representing the time (in hours) that each backup is retained. This setting only applies to the periodic backup type. Defaults to 8."
              }
            },
            "backupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local",
              "allowedValues": [
                "Geo",
                "Local",
                "Zone"
              ],
              "metadata": {
                "description": "Optional. Setting that indicates the type of backup residency. This setting only applies to the periodic backup type. Defaults to \"Local\"."
              }
            },
            "networkRestrictions": {
              "$ref": "#/definitions/networkRestrictionType",
              "defaultValue": {
                "ipRules": [],
                "virtualNetworkRules": [],
                "publicNetworkAccess": "Disabled"
              },
              "metadata": {
                "description": "Optional. The network configuration of this module. Defaults to `{ ipRules: [], virtualNetworkRules: [], publicNetworkAccess: 'Disabled' }`."
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "Tls12",
              "allowedValues": [
                "Tls12"
              ],
              "metadata": {
                "description": "Optional. Setting that indicates the minimum allowed TLS version. Azure Cosmos DB for MongoDB RU and Apache Cassandra only work with TLS 1.2 or later. Defaults to \"Tls12\" (TLS 1.2)."
              }
            },
            "enableBurstCapacity": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Flag to indicate enabling/disabling of Burst Capacity feature on the account. Cannot be enabled for serverless accounts."
              }
            },
            "enableCassandraConnector": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Enables the cassandra connector on the Cosmos DB C* account."
              }
            },
            "enablePartitionMerge": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Flag to enable/disable the 'Partition Merge' feature on the account."
              }
            },
            "enablePerRegionPerPartitionAutoscale": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Flag to enable/disable the 'PerRegionPerPartitionAutoscale' feature on the account."
              }
            },
            "analyticalStorageConfiguration": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.DocumentDB/databaseAccounts@2025-04-15#properties/properties/properties/analyticalStorageConfiguration"
                },
                "description": "Optional. Analytical storage specific properties."
              },
              "nullable": true
            },
            "cors": {
              "type": "array",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.DocumentDB/databaseAccounts@2025-04-15#properties/properties/properties/cors"
                },
                "description": "Optional. The CORS policy for the Cosmos DB database account."
              },
              "nullable": true
            },
            "defaultIdentity": {
              "$ref": "#/definitions/defaultIdentityType",
              "defaultValue": {
                "name": "FirstPartyIdentity"
              },
              "metadata": {
                "description": "Optional. The default identity for accessing key vault used in features like customer managed keys. Use `FirstPartyIdentity` to use the tenant-level CosmosDB enterprise application. The default identity needs to be explicitly set by the users."
              }
            },
            "customerManagedKey": {
              "$ref": "#/definitions/customerManagedKeyType",
              "nullable": true,
              "metadata": {
                "description": "Optional. The customer managed key definition. If specified, the parameter `defaultIdentity` must be configured as well."
              }
            }
          },
          "variables": {
            "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
            "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(variables('formattedUserAssignedIdentities'))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(variables('formattedUserAssignedIdentities'))), 'UserAssigned', null())), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
            "isHSMManagedCMK": "[equals(tryGet(split(coalesce(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), ''), '/'), 7), 'managedHSMs')]"
          },
          "resources": {
            "cMKKeyVault::cMKKey": {
              "condition": "[and(and(not(empty(parameters('customerManagedKey'))), not(variables('isHSMManagedCMK'))), and(not(empty(parameters('customerManagedKey'))), not(variables('isHSMManagedCMK'))))]",
              "existing": true,
              "type": "Microsoft.KeyVault/vaults/keys",
              "apiVersion": "2024-11-01",
              "subscriptionId": "[split(parameters('customerManagedKey').keyVaultResourceId, '/')[2]]",
              "resourceGroup": "[split(parameters('customerManagedKey').keyVaultResourceId, '/')[4]]",
              "name": "[format('{0}/{1}', last(split(parameters('customerManagedKey').keyVaultResourceId, '/')), parameters('customerManagedKey').keyName)]"
            },
            "avmTelemetry": {
              "condition": "[parameters('enableTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2024-07-01",
              "name": "[format('46d3xbcp.res.documentdb-databaseaccount.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": [],
                  "outputs": {
                    "telemetry": {
                      "type": "String",
                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                    }
                  }
                }
              }
            },
            "cMKKeyVault": {
              "condition": "[and(not(empty(parameters('customerManagedKey'))), not(variables('isHSMManagedCMK')))]",
              "existing": true,
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "subscriptionId": "[split(parameters('customerManagedKey').keyVaultResourceId, '/')[2]]",
              "resourceGroup": "[split(parameters('customerManagedKey').keyVaultResourceId, '/')[4]]",
              "name": "[last(split(parameters('customerManagedKey').keyVaultResourceId, '/'))]"
            },
            "databaseAccount": {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2025-04-15",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": "[variables('identity')]",
              "kind": "[if(not(empty(parameters('mongodbDatabases'))), 'MongoDB', 'GlobalDocumentDB')]",
              "properties": "[shallowMerge(createArray(createObject('enableBurstCapacity', if(not(contains(coalesce(parameters('capabilitiesToAdd'), createArray()), 'EnableServerless')), parameters('enableBurstCapacity'), false()), 'databaseAccountOfferType', parameters('databaseAccountOfferType'), 'analyticalStorageConfiguration', parameters('analyticalStorageConfiguration'), 'defaultIdentity', if(and(not(empty(parameters('defaultIdentity'))), not(equals(tryGet(parameters('defaultIdentity'), 'name'), 'UserAssignedIdentity'))), parameters('defaultIdentity').name, format('UserAssignedIdentity={0}', tryGet(parameters('defaultIdentity'), 'resourceId'))), 'keyVaultKeyUri', if(not(empty(parameters('customerManagedKey'))), if(not(variables('isHSMManagedCMK')), format('{0}', reference('cMKKeyVault::cMKKey').keyUri), format('https://{0}.managedhsm.azure.net/keys/{1}', last(split(parameters('customerManagedKey').keyVaultResourceId, '/')), parameters('customerManagedKey').keyName)), null()), 'cors', parameters('cors'), 'enablePartitionMerge', parameters('enablePartitionMerge'), 'enablePerRegionPerPartitionAutoscale', parameters('enablePerRegionPerPartitionAutoscale'), 'backupPolicy', shallowMerge(createArray(createObject('type', parameters('backupPolicyType')), if(equals(parameters('backupPolicyType'), 'Continuous'), createObject('continuousModeProperties', createObject('tier', parameters('backupPolicyContinuousTier'))), createObject()), if(equals(parameters('backupPolicyType'), 'Periodic'), createObject('periodicModeProperties', createObject('backupIntervalInMinutes', parameters('backupIntervalInMinutes'), 'backupRetentionIntervalInHours', parameters('backupRetentionIntervalInHours'), 'backupStorageRedundancy', parameters('backupStorageRedundancy'))), createObject()))), 'capabilities', map(coalesce(parameters('capabilitiesToAdd'), createArray()), lambda('capability', createObject('name', lambdaVariables('capability'))))), if(not(empty(parameters('cors'))), createObject('cors', parameters('cors')), createObject()), if(contains(coalesce(parameters('capabilitiesToAdd'), createArray()), 'EnableCassandra'), createObject('connectorOffer', if(parameters('enableCassandraConnector'), 'Small', null()), 'enableCassandraConnector', parameters('enableCassandraConnector')), createObject()), createObject('minimalTlsVersion', parameters('minimumTlsVersion'), 'capacity', createObject('totalThroughputLimit', parameters('totalThroughputLimit')), 'publicNetworkAccess', coalesce(tryGet(parameters('networkRestrictions'), 'publicNetworkAccess'), 'Disabled')), if(or(or(or(or(not(empty(parameters('sqlDatabases'))), not(empty(parameters('mongodbDatabases')))), not(empty(parameters('gremlinDatabases')))), not(empty(parameters('tables')))), not(empty(parameters('cassandraKeyspaces')))), createObject('consistencyPolicy', shallowMerge(createArray(createObject('defaultConsistencyLevel', parameters('defaultConsistencyLevel')), if(equals(parameters('defaultConsistencyLevel'), 'BoundedStaleness'), createObject('maxStalenessPrefix', parameters('maxStalenessPrefix'), 'maxIntervalInSeconds', parameters('maxIntervalInSeconds')), createObject()))), 'enableMultipleWriteLocations', parameters('enableMultipleWriteLocations'), 'locations', if(not(empty(parameters('failoverLocations'))), map(parameters('failoverLocations'), lambda('failoverLocation', createObject('failoverPriority', lambdaVariables('failoverLocation').failoverPriority, 'locationName', lambdaVariables('failoverLocation').locationName, 'isZoneRedundant', coalesce(tryGet(lambdaVariables('failoverLocation'), 'isZoneRedundant'), true())))), createArray(createObject('failoverPriority', 0, 'locationName', parameters('location'), 'isZoneRedundant', parameters('zoneRedundant')))), 'ipRules', map(coalesce(tryGet(parameters('networkRestrictions'), 'ipRules'), createArray()), lambda('ipRule', createObject('ipAddressOrRange', lambdaVariables('ipRule')))), 'virtualNetworkRules', map(coalesce(tryGet(parameters('networkRestrictions'), 'virtualNetworkRules'), createArray()), lambda('rule', createObject('id', lambdaVariables('rule').subnetResourceId, 'ignoreMissingVNetServiceEndpoint', false()))), 'networkAclBypass', coalesce(tryGet(parameters('networkRestrictions'), 'networkAclBypass'), 'None'), 'networkAclBypassResourceIds', tryGet(parameters('networkRestrictions'), 'networkAclBypassResourceIds'), 'isVirtualNetworkFilterEnabled', or(not(empty(tryGet(parameters('networkRestrictions'), 'ipRules'))), not(empty(tryGet(parameters('networkRestrictions'), 'virtualNetworkRules')))), 'enableFreeTier', parameters('enableFreeTier'), 'enableAutomaticFailover', parameters('enableAutomaticFailover'), 'enableAnalyticalStorage', parameters('enableAnalyticalStorage')), createObject()), if(or(or(not(empty(parameters('mongodbDatabases'))), not(empty(parameters('gremlinDatabases')))), not(empty(parameters('cassandraKeyspaces')))), createObject('disableLocalAuth', false(), 'disableKeyBasedMetadataWriteAccess', false()), createObject('disableLocalAuth', parameters('disableLocalAuthentication'), 'disableKeyBasedMetadataWriteAccess', parameters('disableKeyBasedMetadataWriteAccess'))), if(not(empty(parameters('mongodbDatabases'))), createObject('apiProperties', createObject('serverVersion', parameters('serverVersion'))), createObject())))]",
              "dependsOn": [
                "cMKKeyVault::cMKKey"
              ]
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the database account."
              },
              "value": "[parameters('name')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the database account."
              },
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The name of the resource group the database account was created in."
              },
              "value": "[resourceGroup().name]"
            },
            "systemAssignedMIPrincipalId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "The principal ID of the system assigned identity."
              },
              "value": "[tryGet(tryGet(reference('databaseAccount', '2025-04-15', 'full'), 'identity'), 'principalId')]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location the resource was deployed into."
              },
              "value": "[reference('databaseAccount', '2025-04-15', 'full').location]"
            },
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "The endpoint of the database account."
              },
              "value": "[reference('databaseAccount').documentEndpoint]"
            },
            "primaryReadWriteKey": {
              "type": "securestring",
              "metadata": {
                "description": "The primary read-write key."
              },
              "value": "[listKeys('databaseAccount', '2025-04-15').primaryMasterKey]"
            },
            "primaryReadOnlyKey": {
              "type": "securestring",
              "metadata": {
                "description": "The primary read-only key."
              },
              "value": "[listKeys('databaseAccount', '2025-04-15').primaryReadonlyMasterKey]"
            },
            "primaryReadWriteConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "The primary read-write connection string."
              },
              "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[0].connectionString]"
            },
            "primaryReadOnlyConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "The primary read-only connection string."
              },
              "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[2].connectionString]"
            },
            "secondaryReadWriteKey": {
              "type": "securestring",
              "metadata": {
                "description": "The secondary read-write key."
              },
              "value": "[listKeys('databaseAccount', '2025-04-15').secondaryMasterKey]"
            },
            "secondaryReadOnlyKey": {
              "type": "securestring",
              "metadata": {
                "description": "The secondary read-only key."
              },
              "value": "[listKeys('databaseAccount', '2025-04-15').secondaryReadonlyMasterKey]"
            },
            "secondaryReadWriteConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "The secondary read-write connection string."
              },
              "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[1].connectionString]"
            },
            "secondaryReadOnlyConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "The secondary read-only connection string."
              },
              "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[3].connectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "nestedDependencies",
        "resourceGroup"
      ]
    }
  }
}