{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.28.1.47646",
      "templateHash": "9519342785600081088"
    },
    "name": "DocumentDB Mongo Clusters Config FireWall Rules",
    "description": "This module config firewall rules for DocumentDB Mongo Cluster.",
    "owner": "Azure/module-maintainers"
  },
  "parameters": {
    "allowAllIPsFirewall": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Whether to allow all IPs or not. Warning: No IP addresses will be blocked and any host on the Internet can access the coordinator in this server group. It is strongly recommended to use this rule only temporarily and only on test clusters that do not contain sensitive data."
      }
    },
    "allowAzureIPsFirewall": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Whether to allow Azure internal IPs or not."
      }
    },
    "allowedSingleIPs": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. IP addresses to allow access to the cluster from."
      }
    },
    "mongoClusterName": {
      "type": "string",
      "metadata": {
        "description": "Required. Name of the Mongo Cluster."
      }
    }
  },
  "resources": [
    {
      "condition": "[parameters('allowAllIPsFirewall')]",
      "type": "Microsoft.DocumentDB/mongoClusters/firewallRules",
      "apiVersion": "2024-02-15-preview",
      "name": "[format('{0}/{1}', parameters('mongoClusterName'), 'allow-all-IPs')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "255.255.255.255"
      }
    },
    {
      "condition": "[parameters('allowAzureIPsFirewall')]",
      "type": "Microsoft.DocumentDB/mongoClusters/firewallRules",
      "apiVersion": "2024-02-15-preview",
      "name": "[format('{0}/{1}', parameters('mongoClusterName'), 'allow-all-azure-internal-IPs')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      }
    },
    {
      "copy": {
        "name": "firewall_single",
        "count": "[length(parameters('allowedSingleIPs'))]"
      },
      "type": "Microsoft.DocumentDB/mongoClusters/firewallRules",
      "apiVersion": "2024-02-15-preview",
      "name": "[format('{0}/{1}', parameters('mongoClusterName'), format('allow-single-{0}', replace(parameters('allowedSingleIPs')[copyIndex()], '.', '')))]",
      "properties": {
        "startIpAddress": "[parameters('allowedSingleIPs')[copyIndex()]]",
        "endIpAddress": "[parameters('allowedSingleIPs')[copyIndex()]]"
      }
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the resource group the mongo cluster was created in."
      },
      "value": "[resourceGroup().name]"
    }
  }
}