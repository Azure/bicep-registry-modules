{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4891575914914695678"
    },
    "name": "API Management Service Workspace",
    "description": "This module deploys an API Management Service Workspace."
  },
  "definitions": {
    "apiType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256,
          "metadata": {
            "description": "Required. API revision identifier. Must be unique in the current API Management workspace. Non-current revision has ;rev=n as a suffix where n is the revision number."
          }
        },
        "policies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_1.policyType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. Array of Policies to apply to the Service API."
          }
        },
        "diagnostics": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_1.diagnosticType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. Array of diagnostics to apply to the Service API."
          }
        },
        "operations": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_1.operationType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. The operations of the api."
          }
        },
        "apiRevision": {
          "type": "string",
          "nullable": true,
          "minLength": 1,
          "maxLength": 100,
          "metadata": {
            "description": "Optional. Describes the Revision of the API. If no value is provided, default revision 1 is created."
          }
        },
        "apiRevisionDescription": {
          "type": "string",
          "nullable": true,
          "maxLength": 256,
          "metadata": {
            "description": "Optional. Description of the API Revision."
          }
        },
        "apiType": {
          "type": "string",
          "allowedValues": [
            "graphql",
            "http",
            "soap",
            "websocket"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Type of API to create.\n* `http` creates a REST API\n* `soap` creates a SOAP pass-through API\n* `websocket` creates websocket API\n* `graphql` creates GraphQL API."
          }
        },
        "apiVersion": {
          "type": "string",
          "nullable": true,
          "maxLength": 100,
          "metadata": {
            "description": "Optional. Indicates the Version identifier of the API if the API is versioned."
          }
        },
        "apiVersionDescription": {
          "type": "string",
          "nullable": true,
          "maxLength": 256,
          "metadata": {
            "description": "Optional. Description of the API Version."
          }
        },
        "authenticationSettings": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis@2024-05-01#properties/properties/properties/authenticationSettings"
            },
            "description": "Optional. Collection of authentication settings included into this API."
          },
          "nullable": true
        },
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Description of the API. May include HTML formatting tags."
          }
        },
        "displayName": {
          "type": "string",
          "maxLength": 300,
          "metadata": {
            "description": "Required. API display name."
          }
        },
        "format": {
          "type": "string",
          "allowedValues": [
            "graphql-link",
            "grpc",
            "grpc-link",
            "odata",
            "odata-link",
            "openapi",
            "openapi+json",
            "openapi+json-link",
            "openapi-link",
            "swagger-json",
            "swagger-link-json",
            "wadl-link-json",
            "wadl-xml",
            "wsdl",
            "wsdl-link"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Format of the Content in which the API is getting imported."
          }
        },
        "isCurrent": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Indicates if API revision is current API revision."
          }
        },
        "path": {
          "type": "string",
          "maxLength": 400,
          "metadata": {
            "description": "Required. Relative URL uniquely identifying this API and all of its resource paths within the API Management service instance. It is appended to the API endpoint base URL specified during the service instance creation to form a public URL for this API."
          }
        },
        "protocols": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. Describes on which protocols the operations in this API can be invoked."
          }
        },
        "serviceUrl": {
          "type": "string",
          "nullable": true,
          "maxLength": 2000,
          "metadata": {
            "description": "Optional. Absolute URL of the backend service implementing this API."
          }
        },
        "apiVersionSetName": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of the API version set to link."
          }
        },
        "sourceApiId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. API identifier of the source API."
          }
        },
        "subscriptionKeyParameterNames": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis@2024-05-01#properties/properties/properties/subscriptionKeyParameterNames"
            },
            "description": "Optional. Protocols over which API is made available."
          },
          "nullable": true
        },
        "subscriptionRequired": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Specifies whether an API or Product subscription is required for accessing the API."
          }
        },
        "type": {
          "type": "string",
          "allowedValues": [
            "graphql",
            "grpc",
            "http",
            "odata",
            "soap",
            "websocket"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Type of API."
          }
        },
        "value": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Content value when Importing an API."
          }
        },
        "wsdlSelector": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis@2024-05-01#properties/properties/properties/wsdlSelector"
            },
            "description": "Optional. Criteria to limit import of WSDL to a subset of the document."
          },
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace API."
      }
    },
    "apiVersionSetType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. API Version set name."
          }
        },
        "displayName": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "metadata": {
            "description": "Required. The display name of the API Version Set."
          }
        },
        "versioningScheme": {
          "type": "string",
          "allowedValues": [
            "Header",
            "Query",
            "Segment"
          ],
          "metadata": {
            "description": "Required. An value that determines where the API Version identifier will be located in a HTTP request."
          }
        },
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Description of API Version Set."
          }
        },
        "versionHeaderName": {
          "type": "string",
          "nullable": true,
          "minLength": 1,
          "maxLength": 100,
          "metadata": {
            "description": "Optional. Name of HTTP header parameter that indicates the API Version if versioningScheme is set to header."
          }
        },
        "versionQueryName": {
          "type": "string",
          "nullable": true,
          "minLength": 1,
          "maxLength": 100,
          "metadata": {
            "description": "Optional. Name of query parameter that indicates the API Version if versioningScheme is set to query."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace API Version Set."
      }
    },
    "backendType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. Backend Name."
          }
        },
        "credentials": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/credentials"
            },
            "description": "Optional. Backend Credentials Contract Properties. Not supported for Backend Pools."
          },
          "nullable": true
        },
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Backend Description."
          }
        },
        "protocol": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Backend communication protocol. http or soap. Not supported for Backend Pools."
          }
        },
        "proxy": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/proxy"
            },
            "description": "Optional. Backend Proxy Contract Properties. Not supported for Backend Pools."
          },
          "nullable": true
        },
        "resourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Management Uri of the Resource in External System. This URL can be the Arm Resource ID of Logic Apps, Function Apps or API Apps. Not supported for Backend Pools."
          }
        },
        "serviceFabricCluster": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/properties/properties/serviceFabricCluster"
            },
            "description": "Optional. Backend Service Fabric Cluster Properties. Not supported for Backend Pools."
          },
          "nullable": true
        },
        "title": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Backend Title."
          }
        },
        "tls": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/tls"
            },
            "description": "Optional. Backend TLS Properties. Not supported for Backend Pools. If not specified and type is Single, TLS properties will default to validateCertificateChain and validateCertificateName set to true."
          },
          "nullable": true
        },
        "url": {
          "type": "string",
          "nullable": true,
          "minLength": 1,
          "maxLength": 2000,
          "metadata": {
            "description": "Conditional. Runtime URL of the Backend. Required if type is Single and not supported if type is Pool."
          }
        },
        "circuitBreaker": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/circuitBreaker"
            },
            "description": "Optional. Backend Circuit Breaker Configuration. Not supported for Backend Pools."
          },
          "nullable": true
        },
        "pool": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/pool"
            },
            "description": "Conditional. Backend pool configuration for load balancing. Required if type is Pool and not supported if type is Single."
          },
          "nullable": true
        },
        "type": {
          "type": "string",
          "allowedValues": [
            "Pool",
            "Single"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Type of the backend. A backend can be either Single or Pool."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Backend."
      }
    },
    "diagnosticType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. Diagnostic Name."
          }
        },
        "loggerResourceId": {
          "type": "string",
          "metadata": {
            "description": "Required. Logger resource ID."
          }
        },
        "alwaysLog": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Specifies for what type of messages sampling settings should not apply."
          }
        },
        "backend": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/diagnostics@2024-05-01#properties/properties/properties/backend"
            },
            "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Backend."
          },
          "nullable": true
        },
        "frontend": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/diagnostics@2024-05-01#properties/properties/properties/frontend"
            },
            "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Gateway."
          },
          "nullable": true
        },
        "httpCorrelationProtocol": {
          "type": "string",
          "allowedValues": [
            "Legacy",
            "None",
            "W3C"
          ],
          "nullable": true,
          "metadata": {
            "description": "Conditional. Sets correlation protocol to use for Application Insights diagnostics. Required if using Application Insights."
          }
        },
        "logClientIp": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Log the ClientIP."
          }
        },
        "metrics": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Conditional. Emit custom metrics via emit-metric policy. Required if using Application Insights."
          }
        },
        "operationNameFormat": {
          "type": "string",
          "allowedValues": [
            "Name",
            "Url"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. The format of the Operation Name for Application Insights telemetries."
          }
        },
        "samplingPercentage": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Optional. Rate of sampling for fixed-rate sampling. Specifies the percentage of requests that are logged."
          }
        },
        "verbosity": {
          "type": "string",
          "allowedValues": [
            "error",
            "information",
            "verbose"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. The verbosity level applied to traces emitted by trace policies."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Diagnostic."
      }
    },
    "loggerType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. Logger name."
          }
        },
        "description": {
          "type": "string",
          "nullable": true,
          "maxLength": 256,
          "metadata": {
            "description": "Optional. Description of the logger."
          }
        },
        "isBuffered": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Whether records are buffered in the logger before publishing."
          }
        },
        "type": {
          "type": "string",
          "allowedValues": [
            "applicationInsights",
            "azureEventHub",
            "azureMonitor"
          ],
          "metadata": {
            "description": "Required. Logger type."
          }
        },
        "targetResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Conditional. Azure Resource Id of a log target (either Azure Event Hub resource or Azure Application Insights resource). Required if loggerType = applicationInsights or azureEventHub."
          }
        },
        "credentials": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/loggers@2024-05-01#properties/properties/properties/credentials"
            },
            "description": "Conditional. The name and SendRule connection string of the event hub for azureEventHub logger. Instrumentation key for applicationInsights logger. Required if loggerType = applicationInsights or azureEventHub, ignored if loggerType = azureMonitor."
          },
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Logger."
      }
    },
    "namedValueType": {
      "type": "object",
      "properties": {
        "displayName": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256,
          "metadata": {
            "description": "Required. Unique name of NamedValue. It may contain only letters, digits, period, dash, and underscore characters."
          }
        },
        "keyVault": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/namedValues@2024-05-01#properties/properties/properties/keyVault"
            },
            "description": "Optional. KeyVault location details of the namedValue."
          },
          "nullable": true
        },
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. The name of the named value."
          }
        },
        "tags": {
          "type": "array",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/namedValues@2024-05-01#properties/properties/properties/tags"
            },
            "description": "Optional. Tags that when provided can be used to filter the NamedValue list."
          },
          "nullable": true
        },
        "secret": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Determines whether the value is a secret and should be encrypted or not."
          }
        },
        "value": {
          "type": "string",
          "nullable": true,
          "maxLength": 4096,
          "metadata": {
            "description": "Optional. Value of the NamedValue. Can contain policy expressions. It may not be empty or consist only of whitespace. This property will not be filled on 'GET' operations! Use '/listSecrets' POST request to get the value."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Named Value."
      }
    },
    "policyType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of the policy."
          }
        },
        "format": {
          "type": "string",
          "allowedValues": [
            "rawxml",
            "rawxml-link",
            "xml",
            "xml-link"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Format of the policyContent."
          }
        },
        "value": {
          "type": "string",
          "metadata": {
            "description": "Required. Contents of the Policy as defined by the format."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Policy."
      }
    },
    "productType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256,
          "metadata": {
            "description": "Required. Product Name."
          }
        },
        "displayName": {
          "type": "string",
          "minLength": 1,
          "maxLength": 300,
          "metadata": {
            "description": "Required. Product display name."
          }
        },
        "approvalRequired": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Whether subscription approval is required. If false, new subscriptions will be approved automatically enabling developers to call the product's APIs immediately after subscribing. If true, administrators must manually approve the subscription before the developer can any of the product's APIs. Can be present only if subscriptionRequired property is present and has a value of false."
          }
        },
        "description": {
          "type": "string",
          "nullable": true,
          "maxLength": 1000,
          "metadata": {
            "description": "Optional. Product description. May include HTML formatting tags."
          }
        },
        "apiLinks": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_3.apiLinkType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. Names of Product API Links."
          }
        },
        "groupLinks": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_3.groupLinkType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. Names of Product Group Links."
          }
        },
        "policies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_3.productPolicyType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. Array of Policies to apply to the Product."
          }
        },
        "state": {
          "type": "string",
          "allowedValues": [
            "notPublished",
            "published"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Whether product is published or not. Published products are discoverable by users of developer portal. Non published products are visible only to administrators."
          }
        },
        "subscriptionRequired": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Whether a product subscription is required for accessing APIs included in this product. If true, the product is referred to as \"protected\" and a valid subscription key is required for a request to an API included in the product to succeed. If false, the product is referred to as \"open\" and requests to an API included in the product can be made without a subscription key. If property is omitted when creating a new product it's value is assumed to be true."
          }
        },
        "subscriptionsLimit": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Optional. Whether the number of subscriptions a user can have to this product at the same time. Set to null or omit to allow unlimited per user subscriptions. Can be present only if subscriptionRequired property is present and has a value of false."
          }
        },
        "terms": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Product terms of use. Developers trying to subscribe to the product will be presented and required to accept these terms before they can complete the subscription process."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Product."
      }
    },
    "subscriptionType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. Subscription name."
          }
        },
        "displayName": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "metadata": {
            "description": "Required. API Management Service Subscriptions name."
          }
        },
        "allowTracing": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Determines whether tracing can be enabled."
          }
        },
        "ownerId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. User (user ID path) for whom subscription is being created in form /users/{userId}."
          }
        },
        "primaryKey": {
          "type": "string",
          "nullable": true,
          "minLength": 1,
          "maxLength": 256,
          "metadata": {
            "description": "Optional. Primary subscription key. If not specified during request key will be generated automatically."
          }
        },
        "scope": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Scope like \"/products/{productId}\" or \"/apis\" or \"/apis/{apiId}\"."
          }
        },
        "secondaryKey": {
          "type": "string",
          "nullable": true,
          "minLength": 1,
          "maxLength": 256,
          "metadata": {
            "description": "Optional. Secondary subscription key. If not specified during request key will be generated automatically."
          }
        },
        "state": {
          "type": "string",
          "allowedValues": [
            "active",
            "cancelled",
            "expired",
            "rejected",
            "submitted",
            "suspended"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Initial subscription state. If no value is specified, subscription is created with Submitted state. Possible states are:\n* active - the subscription is active\n* suspended - the subscription is blocked, and the subscriber cannot call any APIs of the product\n* submitted - the subscription request has been made by the developer, but has not yet been approved or rejected\n* rejected - the subscription request has been denied by an administrator\n* cancelled - the subscription has been cancelled by the developer or administrator\n* expired - the subscription reached its expiration date and was deactivated."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Subscription."
      }
    },
    "gatewayConfigType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. Gateway name."
          }
        },
        "location": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Location where the gateway will be deployed."
          }
        },
        "capacity": {
          "type": "int",
          "nullable": true,
          "minValue": 1,
          "maxValue": 32,
          "metadata": {
            "description": "Optional. Gateway SKU capacity. Defaults to 1."
          }
        },
        "virtualNetworkType": {
          "type": "string",
          "allowedValues": [
            "External",
            "Internal",
            "None"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Virtual Network Type of the gateway. Defaults to None."
          }
        },
        "subnetResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Conditional. The resource ID of the subnet to associate with the gateway backend. Required if virtualNetworkType is External or Internal. The subnet must be in the same region and subscription as the APIM instance and must be delegated to the required service: `Microsoft.Web/serverFarms` for External virtualNetworkType, `Microsoft.Web/hostingEnvironments` for Internal virtualNetworkType."
          }
        }
      },
      "metadata": {
        "__bicep_export!": true,
        "description": "The type of an API Management workspace Gateway configuration."
      }
    },
    "_1.diagnosticType": {
      "type": "object",
      "properties": {
        "loggerName": {
          "type": "string",
          "metadata": {
            "description": "Required. The name of the target logger."
          }
        },
        "name": {
          "type": "string",
          "allowedValues": [
            "applicationinsights",
            "azuremonitor",
            "local"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. The identifier of the Diagnostic."
          }
        },
        "alwaysLog": {
          "type": "string",
          "allowedValues": [
            "allErrors"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Specifies for what type of messages sampling settings should not apply."
          }
        },
        "backend": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics@2024-05-01#properties/properties/properties/backend"
            },
            "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Backend."
          },
          "nullable": true
        },
        "frontend": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics@2024-05-01#properties/properties/properties/frontend"
            },
            "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Gateway."
          },
          "nullable": true
        },
        "httpCorrelationProtocol": {
          "type": "string",
          "allowedValues": [
            "Legacy",
            "None",
            "W3C"
          ],
          "nullable": true,
          "metadata": {
            "description": "Conditional. Sets correlation protocol to use for Application Insights diagnostics. Required if using Application Insights."
          }
        },
        "logClientIp": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Log the ClientIP."
          }
        },
        "metrics": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Conditional. Emit custom metrics via emit-metric policy. Required if using Application Insights."
          }
        },
        "operationNameFormat": {
          "type": "string",
          "allowedValues": [
            "Name",
            "Url"
          ],
          "nullable": true,
          "metadata": {
            "description": "Conditional. The format of the Operation Name for Application Insights telemetries. Required if using Application Insights."
          }
        },
        "samplingPercentage": {
          "type": "int",
          "nullable": true,
          "minValue": 0,
          "maxValue": 100,
          "metadata": {
            "description": "Optional. Rate of sampling for fixed-rate sampling. Specifies the percentage of requests that are logged."
          }
        },
        "verbosity": {
          "type": "string",
          "allowedValues": [
            "error",
            "information",
            "verbose"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. The verbosity level applied to traces emitted by trace policies."
          }
        }
      },
      "metadata": {
        "description": "The type of a diagnostic configuration.",
        "__bicep_imported_from!": {
          "sourceTemplate": "api/main.bicep"
        }
      }
    },
    "_1.operationType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. The name of the operation."
          }
        },
        "displayName": {
          "type": "string",
          "metadata": {
            "description": "Required. The display name of the operation."
          }
        },
        "policies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_2.policyType"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. The policies to apply to the operation."
          }
        },
        "method": {
          "type": "string",
          "metadata": {
            "description": "Required. A Valid HTTP Operation Method. Typical Http Methods like GET, PUT, POST but not limited by only them."
          }
        },
        "urlTemplate": {
          "type": "string",
          "minLength": 1,
          "maxLength": 1000,
          "metadata": {
            "description": "Required. Relative URL template identifying the target resource for this operation. May include parameters. Example: /customers/{cid}/orders/{oid}/?date={date}."
          }
        },
        "description": {
          "type": "string",
          "nullable": true,
          "maxLength": 1000,
          "metadata": {
            "description": "Optional. Description of the operation. May include HTML formatting tags. Must not be longer than 1.000 characters."
          }
        },
        "request": {
          "type": "object",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/request"
            },
            "description": "Optional. An entity containing request details."
          },
          "nullable": true
        },
        "responses": {
          "type": "array",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/responses"
            },
            "description": "Optional. Array of Operation responses."
          },
          "nullable": true
        },
        "templateParameters": {
          "type": "array",
          "metadata": {
            "__bicep_resource_derived_type!": {
              "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/templateParameters"
            },
            "description": "Optional. Collection of URL template parameters."
          },
          "nullable": true
        }
      },
      "metadata": {
        "description": "The type of an operation.",
        "__bicep_imported_from!": {
          "sourceTemplate": "api/main.bicep"
        }
      }
    },
    "_1.policyType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of the policy."
          }
        },
        "format": {
          "type": "string",
          "allowedValues": [
            "rawxml",
            "rawxml-link",
            "xml",
            "xml-link"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Format of the policyContent."
          }
        },
        "value": {
          "type": "string",
          "metadata": {
            "description": "Required. Contents of the Policy as defined by the format."
          }
        }
      },
      "metadata": {
        "description": "The type of a policy.",
        "__bicep_imported_from!": {
          "sourceTemplate": "api/main.bicep"
        }
      }
    },
    "_2.policyType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of the policy."
          }
        },
        "format": {
          "type": "string",
          "allowedValues": [
            "rawxml",
            "rawxml-link",
            "xml",
            "xml-link"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Format of the policyContent."
          }
        },
        "value": {
          "type": "string",
          "metadata": {
            "description": "Required. Contents of the Policy as defined by the format."
          }
        }
      },
      "metadata": {
        "description": "The type of a policy.",
        "__bicep_imported_from!": {
          "sourceTemplate": "api/operation/main.bicep"
        }
      }
    },
    "_3.apiLinkType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. The name of the API link."
          }
        },
        "apiResourceId": {
          "type": "string",
          "metadata": {
            "description": "Required. Full resource Id of an API."
          }
        }
      },
      "metadata": {
        "description": "The type of a product API link.",
        "__bicep_imported_from!": {
          "sourceTemplate": "product/main.bicep"
        }
      }
    },
    "_3.groupLinkType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "metadata": {
            "description": "Required. The name of the Product Group link."
          }
        },
        "groupResourceId": {
          "type": "string",
          "metadata": {
            "description": "Required. Full resource Id of a Group."
          }
        }
      },
      "metadata": {
        "description": "The type of a product group link.",
        "__bicep_imported_from!": {
          "sourceTemplate": "product/main.bicep"
        }
      }
    },
    "_3.productPolicyType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of the policy."
          }
        },
        "format": {
          "type": "string",
          "allowedValues": [
            "rawxml",
            "rawxml-link",
            "xml",
            "xml-link"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Format of the policyContent."
          }
        },
        "value": {
          "type": "string",
          "metadata": {
            "description": "Required. Contents of the Policy as defined by the format."
          }
        }
      },
      "metadata": {
        "description": "The type of a product policy.",
        "__bicep_imported_from!": {
          "sourceTemplate": "product/main.bicep"
        }
      }
    },
    "diagnosticSettingLogsOnlyType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of diagnostic setting."
          }
        },
        "logCategoriesAndGroups": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "category": {
                "type": "string",
                "nullable": true,
                "metadata": {
                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                }
              },
              "categoryGroup": {
                "type": "string",
                "nullable": true,
                "metadata": {
                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                }
              },
              "enabled": {
                "type": "bool",
                "nullable": true,
                "metadata": {
                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                }
              }
            }
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
          }
        },
        "logAnalyticsDestinationType": {
          "type": "string",
          "allowedValues": [
            "AzureDiagnostics",
            "Dedicated"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
          }
        },
        "workspaceResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
          }
        },
        "storageAccountResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
          }
        },
        "eventHubAuthorizationRuleResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
          }
        },
        "eventHubName": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
          }
        },
        "marketplacePartnerResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
          }
        }
      },
      "metadata": {
        "description": "An AVM-aligned type for a diagnostic setting. To be used if only logs are supported by the resource provider.",
        "__bicep_imported_from!": {
          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
        }
      }
    },
    "roleAssignmentType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
          }
        },
        "roleDefinitionIdOrName": {
          "type": "string",
          "metadata": {
            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
          }
        },
        "principalId": {
          "type": "string",
          "metadata": {
            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
          }
        },
        "principalType": {
          "type": "string",
          "allowedValues": [
            "Device",
            "ForeignGroup",
            "Group",
            "ServicePrincipal",
            "User"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. The principal type of the assigned principal ID."
          }
        },
        "description": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The description of the role assignment."
          }
        },
        "condition": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
          }
        },
        "conditionVersion": {
          "type": "string",
          "allowedValues": [
            "2.0"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Version of the condition."
          }
        },
        "delegatedManagedIdentityResourceId": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. The Resource Id of the delegated managed identity resource."
          }
        }
      },
      "metadata": {
        "description": "An AVM-aligned type for a role assignment.",
        "__bicep_imported_from!": {
          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
        }
      }
    }
  },
  "parameters": {
    "apiManagementServiceName": {
      "type": "string",
      "metadata": {
        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
      }
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "Required. Workspace Name."
      }
    },
    "displayName": {
      "type": "string",
      "metadata": {
        "description": "Required. Name of the workspace."
      }
    },
    "description": {
      "type": "string",
      "nullable": true,
      "metadata": {
        "description": "Optional. Description of the workspace."
      }
    },
    "apis": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/apiType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. APIs to deploy in this workspace."
      }
    },
    "apiVersionSets": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/apiVersionSetType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. API Version Sets to deploy in this workspace."
      }
    },
    "backends": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/backendType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Backends to deploy in this workspace."
      }
    },
    "diagnostics": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/diagnosticType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Diagnostics to deploy in this workspace."
      }
    },
    "loggers": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/loggerType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Loggers to deploy in this workspace."
      }
    },
    "namedValues": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/namedValueType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Named values to deploy in this workspace."
      }
    },
    "policies": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/policyType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Policies to deploy in this workspace."
      }
    },
    "products": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/productType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Products to deploy in this workspace."
      }
    },
    "subscriptions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/subscriptionType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Subscriptions to deploy in this workspace."
      }
    },
    "gateway": {
      "$ref": "#/definitions/gatewayConfigType",
      "metadata": {
        "description": "Required. Gateway to deploy for this workspace."
      }
    },
    "roleAssignments": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/roleAssignmentType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. Array of role assignments to create."
      }
    },
    "diagnosticSettings": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/diagnosticSettingLogsOnlyType"
      },
      "nullable": true,
      "metadata": {
        "description": "Optional. The diagnostic settings of the service."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "formattedRoleAssignments",
        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
      }
    ],
    "builtInRoleNames": {
      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]",
      "API Management Developer Portal Content Editor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c031e6a8-4391-4de0-8d69-4706a7ed3729')]",
      "API Management Service Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '312a565d-c81f-4fd8-895a-4e21e48d571c')]",
      "API Management Service Operator Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e022efe7-f5ba-4159-bbe4-b44f577e9b61')]",
      "API Management Service Reader Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '71522526-b88f-4d52-b57f-d31fc3546d0d')]",
      "API Management Service Workspace API Developer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '9565a273-41b9-4368-97d2-aeb0c976a9b3')]",
      "API Management Service Workspace API Product Manager": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'd59a3e9c-6d52-4a5a-aeed-6bf3cf0e31da')]",
      "API Management Workspace API Developer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '56328988-075d-4c6a-8766-d93edd6725b6')]",
      "API Management Workspace API Product Manager": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '73c2c328-d004-4c5e-938c-35c6f5679a1f')]",
      "API Management Workspace Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0c34c906-8d99-4cb7-8bb7-33f5b0a1a799')]",
      "API Management Workspace Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ef1c2c96-4a77-49e8-b9a4-6179fe1d2fd2')]"
    }
  },
  "resources": {
    "service": {
      "existing": true,
      "type": "Microsoft.ApiManagement/service",
      "apiVersion": "2024-05-01",
      "name": "[parameters('apiManagementServiceName')]"
    },
    "workspace": {
      "type": "Microsoft.ApiManagement/service/workspaces",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('name'))]",
      "properties": {
        "displayName": "[parameters('displayName')]",
        "description": "[parameters('description')]"
      }
    },
    "workspace_roleAssignments": {
      "copy": {
        "name": "workspace_roleAssignments",
        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ApiManagement/service/{0}/workspaces/{1}', parameters('apiManagementServiceName'), parameters('name'))]",
      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.ApiManagement/service/workspaces', parameters('apiManagementServiceName'), parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
      "properties": {
        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
      },
      "dependsOn": [
        "workspace"
      ]
    },
    "workspace_diagnosticSettings": {
      "copy": {
        "name": "workspace_diagnosticSettings",
        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
      },
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.ApiManagement/service/{0}/workspaces/{1}', parameters('apiManagementServiceName'), parameters('name'))]",
      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
      "properties": {
        "copy": [
          {
            "name": "logs",
            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
            "input": {
              "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
              "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
            }
          }
        ],
        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
      },
      "dependsOn": [
        "workspace"
      ]
    },
    "workspace_apis": {
      "copy": {
        "name": "workspace_apis",
        "count": "[length(coalesce(parameters('apis'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Api-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[coalesce(parameters('apis'), createArray())[copyIndex()].name]"
          },
          "policies": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'policies')]"
          },
          "diagnostics": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'diagnostics')]"
          },
          "operations": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'operations')]"
          },
          "apiRevision": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'apiRevision')]"
          },
          "apiRevisionDescription": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'apiRevisionDescription')]"
          },
          "apiType": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'apiType')]"
          },
          "apiVersion": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'apiVersion')]"
          },
          "apiVersionDescription": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'apiVersionDescription')]"
          },
          "authenticationSettings": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'authenticationSettings')]"
          },
          "description": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'description')]"
          },
          "displayName": {
            "value": "[coalesce(parameters('apis'), createArray())[copyIndex()].displayName]"
          },
          "format": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'format')]"
          },
          "isCurrent": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'isCurrent')]"
          },
          "path": {
            "value": "[coalesce(parameters('apis'), createArray())[copyIndex()].path]"
          },
          "protocols": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'protocols')]"
          },
          "serviceUrl": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'serviceUrl')]"
          },
          "apiVersionSetName": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'apiVersionSetName')]"
          },
          "sourceApiId": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'sourceApiId')]"
          },
          "subscriptionKeyParameterNames": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'subscriptionKeyParameterNames')]"
          },
          "subscriptionRequired": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'subscriptionRequired')]"
          },
          "type": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'type')]"
          },
          "value": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'value')]"
          },
          "wsdlSelector": {
            "value": "[tryGet(coalesce(parameters('apis'), createArray())[copyIndex()], 'wsdlSelector')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12078706820434986202"
            },
            "name": "API Management Workspace APIs",
            "description": "This module deploys an API in an API Management Workspace."
          },
          "definitions": {
            "operationType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the operation."
                  }
                },
                "displayName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The display name of the operation."
                  }
                },
                "policies": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/_1.policyType"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The policies to apply to the operation."
                  }
                },
                "method": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. A Valid HTTP Operation Method. Typical Http Methods like GET, PUT, POST but not limited by only them."
                  }
                },
                "urlTemplate": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 1000,
                  "metadata": {
                    "description": "Required. Relative URL template identifying the target resource for this operation. May include parameters. Example: /customers/{cid}/orders/{oid}/?date={date}."
                  }
                },
                "description": {
                  "type": "string",
                  "nullable": true,
                  "maxLength": 1000,
                  "metadata": {
                    "description": "Optional. Description of the operation. May include HTML formatting tags. Must not be longer than 1.000 characters."
                  }
                },
                "request": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/request"
                    },
                    "description": "Optional. An entity containing request details."
                  },
                  "nullable": true
                },
                "responses": {
                  "type": "array",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/responses"
                    },
                    "description": "Optional. Array of Operation responses."
                  },
                  "nullable": true
                },
                "templateParameters": {
                  "type": "array",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/templateParameters"
                    },
                    "description": "Optional. Collection of URL template parameters."
                  },
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of an operation."
              }
            },
            "policyType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The name of the policy."
                  }
                },
                "format": {
                  "type": "string",
                  "allowedValues": [
                    "rawxml",
                    "rawxml-link",
                    "xml",
                    "xml-link"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Format of the policyContent."
                  }
                },
                "value": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Contents of the Policy as defined by the format."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of a policy."
              }
            },
            "diagnosticType": {
              "type": "object",
              "properties": {
                "loggerName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the target logger."
                  }
                },
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "applicationinsights",
                    "azuremonitor",
                    "local"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The identifier of the Diagnostic."
                  }
                },
                "alwaysLog": {
                  "type": "string",
                  "allowedValues": [
                    "allErrors"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Specifies for what type of messages sampling settings should not apply."
                  }
                },
                "backend": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics@2024-05-01#properties/properties/properties/backend"
                    },
                    "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Backend."
                  },
                  "nullable": true
                },
                "frontend": {
                  "type": "object",
                  "metadata": {
                    "__bicep_resource_derived_type!": {
                      "source": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics@2024-05-01#properties/properties/properties/frontend"
                    },
                    "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Gateway."
                  },
                  "nullable": true
                },
                "httpCorrelationProtocol": {
                  "type": "string",
                  "allowedValues": [
                    "Legacy",
                    "None",
                    "W3C"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Conditional. Sets correlation protocol to use for Application Insights diagnostics. Required if using Application Insights."
                  }
                },
                "logClientIp": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Log the ClientIP."
                  }
                },
                "metrics": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Conditional. Emit custom metrics via emit-metric policy. Required if using Application Insights."
                  }
                },
                "operationNameFormat": {
                  "type": "string",
                  "allowedValues": [
                    "Name",
                    "Url"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Conditional. The format of the Operation Name for Application Insights telemetries. Required if using Application Insights."
                  }
                },
                "samplingPercentage": {
                  "type": "int",
                  "nullable": true,
                  "minValue": 0,
                  "maxValue": 100,
                  "metadata": {
                    "description": "Optional. Rate of sampling for fixed-rate sampling. Specifies the percentage of requests that are logged."
                  }
                },
                "verbosity": {
                  "type": "string",
                  "allowedValues": [
                    "error",
                    "information",
                    "verbose"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The verbosity level applied to traces emitted by trace policies."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of a diagnostic configuration."
              }
            },
            "_1.policyType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The name of the policy."
                  }
                },
                "format": {
                  "type": "string",
                  "allowedValues": [
                    "rawxml",
                    "rawxml-link",
                    "xml",
                    "xml-link"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Format of the policyContent."
                  }
                },
                "value": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Contents of the Policy as defined by the format."
                  }
                }
              },
              "metadata": {
                "description": "The type of a policy.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "operation/main.bicep"
                }
              }
            }
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "minLength": 1,
              "maxLength": 256,
              "metadata": {
                "description": "Required. API revision identifier. Must be unique in the current API Management workspace. Non-current revision has ;rev=n as a suffix where n is the revision number."
              }
            },
            "policies": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/policyType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Array of Policies to apply to the Service API."
              }
            },
            "diagnostics": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/diagnosticType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Array of diagnostics to apply to the Service API."
              }
            },
            "operations": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/operationType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. The operations of the api."
              }
            },
            "apiRevision": {
              "type": "string",
              "nullable": true,
              "minLength": 1,
              "maxLength": 100,
              "metadata": {
                "description": "Optional. Describes the Revision of the API. If no value is provided, default revision 1 is created."
              }
            },
            "apiRevisionDescription": {
              "type": "string",
              "nullable": true,
              "maxLength": 256,
              "metadata": {
                "description": "Optional. Description of the API Revision."
              }
            },
            "apiType": {
              "type": "string",
              "defaultValue": "http",
              "allowedValues": [
                "graphql",
                "http",
                "soap",
                "websocket"
              ],
              "metadata": {
                "description": "Optional. Type of API to create.\n* `http` creates a REST API\n* `soap` creates a SOAP pass-through API\n* `websocket` creates websocket API\n* `graphql` creates GraphQL API."
              }
            },
            "apiVersion": {
              "type": "string",
              "nullable": true,
              "maxLength": 100,
              "metadata": {
                "description": "Optional. Indicates the Version identifier of the API if the API is versioned."
              }
            },
            "apiVersionDescription": {
              "type": "string",
              "nullable": true,
              "maxLength": 256,
              "metadata": {
                "description": "Optional. Description of the API Version."
              }
            },
            "authenticationSettings": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/apis@2024-05-01#properties/properties/properties/authenticationSettings"
                },
                "description": "Optional. Collection of authentication settings included into this API."
              },
              "nullable": true
            },
            "description": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Description of the API. May include HTML formatting tags."
              }
            },
            "displayName": {
              "type": "string",
              "maxLength": 300,
              "metadata": {
                "description": "Required. API display name."
              }
            },
            "format": {
              "type": "string",
              "defaultValue": "openapi",
              "allowedValues": [
                "graphql-link",
                "grpc",
                "grpc-link",
                "odata",
                "odata-link",
                "openapi",
                "openapi+json",
                "openapi+json-link",
                "openapi-link",
                "swagger-json",
                "swagger-link-json",
                "wadl-link-json",
                "wadl-xml",
                "wsdl",
                "wsdl-link"
              ],
              "metadata": {
                "description": "Optional. Format of the Content in which the API is getting imported."
              }
            },
            "isCurrent": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Indicates if API revision is current API revision."
              }
            },
            "path": {
              "type": "string",
              "maxLength": 400,
              "metadata": {
                "description": "Required. Relative URL uniquely identifying this API and all of its resource paths within the API Management service instance. It is appended to the API endpoint base URL specified during the service instance creation to form a public URL for this API."
              }
            },
            "protocols": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": [
                "https"
              ],
              "allowedValues": [
                "http",
                "https",
                "ws",
                "wss"
              ],
              "metadata": {
                "description": "Optional. Describes on which protocols the operations in this API can be invoked."
              }
            },
            "serviceUrl": {
              "type": "string",
              "nullable": true,
              "maxLength": 2000,
              "metadata": {
                "description": "Optional. Absolute URL of the backend service implementing this API."
              }
            },
            "apiVersionSetName": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. The name of the API version set to link."
              }
            },
            "sourceApiId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. API identifier of the source API."
              }
            },
            "subscriptionKeyParameterNames": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/apis@2024-05-01#properties/properties/properties/subscriptionKeyParameterNames"
                },
                "description": "Optional. Protocols over which API is made available."
              },
              "nullable": true
            },
            "subscriptionRequired": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Specifies whether an API or Product subscription is required for accessing the API."
              }
            },
            "type": {
              "type": "string",
              "defaultValue": "http",
              "allowedValues": [
                "graphql",
                "grpc",
                "http",
                "odata",
                "soap",
                "websocket"
              ],
              "metadata": {
                "description": "Optional. Type of API."
              }
            },
            "value": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Content value when Importing an API."
              }
            },
            "wsdlSelector": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/apis@2024-05-01#properties/properties/properties/wsdlSelector"
                },
                "description": "Optional. Criteria to limit import of WSDL to a subset of the document."
              },
              "nullable": true
            }
          },
          "resources": {
            "service::workspace::apiVersionSet": {
              "condition": "[not(empty(parameters('apiVersionSetName')))]",
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces/apiVersionSets",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiVersionSetName'))]"
            },
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "api": {
              "type": "Microsoft.ApiManagement/service/workspaces/apis",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "apiRevision": "[parameters('apiRevision')]",
                "apiRevisionDescription": "[parameters('apiRevisionDescription')]",
                "apiType": "[parameters('apiType')]",
                "apiVersion": "[parameters('apiVersion')]",
                "apiVersionDescription": "[parameters('apiVersionDescription')]",
                "apiVersionSetId": "[if(not(empty(parameters('apiVersionSetName'))), resourceId('Microsoft.ApiManagement/service/workspaces/apiVersionSets', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiVersionSetName')), null())]",
                "authenticationSettings": "[coalesce(parameters('authenticationSettings'), createObject())]",
                "description": "[coalesce(parameters('description'), '')]",
                "displayName": "[parameters('displayName')]",
                "format": "[if(not(empty(parameters('value'))), parameters('format'), null())]",
                "isCurrent": "[parameters('isCurrent')]",
                "path": "[parameters('path')]",
                "protocols": "[parameters('protocols')]",
                "serviceUrl": "[parameters('serviceUrl')]",
                "sourceApiId": "[parameters('sourceApiId')]",
                "subscriptionKeyParameterNames": "[parameters('subscriptionKeyParameterNames')]",
                "subscriptionRequired": "[parameters('subscriptionRequired')]",
                "type": "[parameters('type')]",
                "value": "[parameters('value')]",
                "wsdlSelector": "[coalesce(parameters('wsdlSelector'), createObject())]"
              }
            },
            "api_policies": {
              "copy": {
                "name": "api_policies",
                "count": "[length(coalesce(parameters('policies'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-Pol-{1}', deployment().name, copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "apiManagementServiceName": {
                    "value": "[parameters('apiManagementServiceName')]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "apiName": {
                    "value": "[parameters('name')]"
                  },
                  "format": {
                    "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'format')]"
                  },
                  "value": {
                    "value": "[coalesce(parameters('policies'), createArray())[copyIndex()].value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "7389406741103376997"
                    },
                    "name": "API Management Workspace APIs Policies",
                    "description": "This module deploys an API Policy in an API Management Workspace."
                  },
                  "parameters": {
                    "apiManagementServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                      }
                    },
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                      }
                    },
                    "apiName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "policy",
                      "metadata": {
                        "description": "Optional. The name of the policy."
                      }
                    },
                    "format": {
                      "type": "string",
                      "defaultValue": "xml",
                      "allowedValues": [
                        "rawxml",
                        "rawxml-link",
                        "xml",
                        "xml-link"
                      ],
                      "metadata": {
                        "description": "Optional. Format of the policyContent."
                      }
                    },
                    "value": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Contents of the Policy as defined by the format."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/workspaces/apis/policies",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('name'))]",
                      "properties": {
                        "format": "[parameters('format')]",
                        "value": "[parameters('value')]"
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the workspace API policy."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/apis/policies', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the workspace API policy."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the workspace API policy was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "api"
              ]
            },
            "api_diagnostics": {
              "copy": {
                "name": "api_diagnostics",
                "count": "[length(coalesce(parameters('diagnostics'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-Diag-{1}', deployment().name, copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'name')]"
                  },
                  "apiManagementServiceName": {
                    "value": "[parameters('apiManagementServiceName')]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "apiName": {
                    "value": "[parameters('name')]"
                  },
                  "loggerName": {
                    "value": "[coalesce(parameters('diagnostics'), createArray())[copyIndex()].loggerName]"
                  },
                  "alwaysLog": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'alwaysLog')]"
                  },
                  "backend": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'backend')]"
                  },
                  "frontend": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'frontend')]"
                  },
                  "httpCorrelationProtocol": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'httpCorrelationProtocol')]"
                  },
                  "logClientIp": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'logClientIp')]"
                  },
                  "metrics": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'metrics')]"
                  },
                  "operationNameFormat": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'operationNameFormat')]"
                  },
                  "samplingPercentage": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'samplingPercentage')]"
                  },
                  "verbosity": {
                    "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'verbosity')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15670376638740090520"
                    },
                    "name": "API Management Workspace APIs Diagnostics",
                    "description": "This module deploys an API Diagnostic in an API Management Workspace."
                  },
                  "parameters": {
                    "apiManagementServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                      }
                    },
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                      }
                    },
                    "apiName": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the parent API."
                      }
                    },
                    "loggerName": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the logger."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "local",
                      "allowedValues": [
                        "azuremonitor",
                        "applicationinsights",
                        "local"
                      ],
                      "metadata": {
                        "description": "Optional. Name of diagnostic resource."
                      }
                    },
                    "alwaysLog": {
                      "type": "string",
                      "defaultValue": "allErrors",
                      "metadata": {
                        "description": "Optional. Specifies for what type of messages sampling settings should not apply."
                      }
                    },
                    "backend": {
                      "type": "object",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics@2024-05-01#properties/properties/properties/backend"
                        },
                        "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Backend."
                      },
                      "nullable": true
                    },
                    "frontend": {
                      "type": "object",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics@2024-05-01#properties/properties/properties/frontend"
                        },
                        "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Gateway."
                      },
                      "nullable": true
                    },
                    "httpCorrelationProtocol": {
                      "type": "string",
                      "defaultValue": "Legacy",
                      "allowedValues": [
                        "Legacy",
                        "None",
                        "W3C"
                      ],
                      "metadata": {
                        "description": "Conditional. Sets correlation protocol to use for Application Insights diagnostics. Required if using Application Insights."
                      }
                    },
                    "logClientIp": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. Log the ClientIP."
                      }
                    },
                    "metrics": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Conditional. Emit custom metrics via emit-metric policy. Required if using Application Insights."
                      }
                    },
                    "operationNameFormat": {
                      "type": "string",
                      "defaultValue": "Name",
                      "allowedValues": [
                        "Name",
                        "Url"
                      ],
                      "metadata": {
                        "description": "Conditional. The format of the Operation Name for Application Insights telemetries. Required if using Application Insights."
                      }
                    },
                    "samplingPercentage": {
                      "type": "int",
                      "defaultValue": 100,
                      "metadata": {
                        "description": "Optional. Rate of sampling for fixed-rate sampling. Specifies the percentage of requests that are logged."
                      }
                    },
                    "verbosity": {
                      "type": "string",
                      "defaultValue": "error",
                      "allowedValues": [
                        "error",
                        "information",
                        "verbose"
                      ],
                      "metadata": {
                        "description": "Optional. The verbosity level applied to traces emitted by trace policies."
                      }
                    }
                  },
                  "resources": {
                    "service::workspace::api": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service/workspaces/apis",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'))]"
                    },
                    "service::workspace::logger": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service/workspaces/loggers",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('loggerName'))]"
                    },
                    "service::workspace": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service/workspaces",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
                    },
                    "service": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service",
                      "apiVersion": "2024-05-01",
                      "name": "[parameters('apiManagementServiceName')]"
                    },
                    "diagnostic": {
                      "type": "Microsoft.ApiManagement/service/workspaces/apis/diagnostics",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('name'))]",
                      "properties": {
                        "alwaysLog": "[parameters('alwaysLog')]",
                        "backend": "[parameters('backend')]",
                        "frontend": "[parameters('frontend')]",
                        "httpCorrelationProtocol": "[parameters('httpCorrelationProtocol')]",
                        "logClientIp": "[parameters('logClientIp')]",
                        "loggerId": "[resourceId('Microsoft.ApiManagement/service/workspaces/loggers', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('loggerName'))]",
                        "metrics": "[parameters('metrics')]",
                        "operationNameFormat": "[parameters('operationNameFormat')]",
                        "sampling": {
                          "percentage": "[parameters('samplingPercentage')]",
                          "samplingType": "fixed"
                        },
                        "verbosity": "[parameters('verbosity')]"
                      }
                    }
                  },
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the workspace API diagnostic."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/apis/diagnostics', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the workspace API diagnostic."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the workspace API diagnostic was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "api"
              ]
            },
            "api_operations": {
              "copy": {
                "name": "api_operations",
                "count": "[length(coalesce(parameters('operations'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-Opr-{1}', deployment().name, copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[coalesce(parameters('operations'), createArray())[copyIndex()].name]"
                  },
                  "apiManagementServiceName": {
                    "value": "[parameters('apiManagementServiceName')]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "apiName": {
                    "value": "[parameters('name')]"
                  },
                  "displayName": {
                    "value": "[coalesce(parameters('operations'), createArray())[copyIndex()].displayName]"
                  },
                  "method": {
                    "value": "[coalesce(parameters('operations'), createArray())[copyIndex()].method]"
                  },
                  "urlTemplate": {
                    "value": "[coalesce(parameters('operations'), createArray())[copyIndex()].urlTemplate]"
                  },
                  "description": {
                    "value": "[tryGet(coalesce(parameters('operations'), createArray())[copyIndex()], 'description')]"
                  },
                  "policies": {
                    "value": "[tryGet(coalesce(parameters('operations'), createArray())[copyIndex()], 'policies')]"
                  },
                  "request": {
                    "value": "[tryGet(coalesce(parameters('operations'), createArray())[copyIndex()], 'request')]"
                  },
                  "responses": {
                    "value": "[tryGet(coalesce(parameters('operations'), createArray())[copyIndex()], 'responses')]"
                  },
                  "templateParameters": {
                    "value": "[tryGet(coalesce(parameters('operations'), createArray())[copyIndex()], 'templateParameters')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "8627306097038622921"
                    },
                    "name": "API Management Workspace API Operations",
                    "description": "This module deploys an API Operation under an API Management Workspace."
                  },
                  "definitions": {
                    "policyType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of the policy."
                          }
                        },
                        "format": {
                          "type": "string",
                          "allowedValues": [
                            "rawxml",
                            "rawxml-link",
                            "xml",
                            "xml-link"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Format of the policyContent."
                          }
                        },
                        "value": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Contents of the Policy as defined by the format."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type of a policy."
                      }
                    }
                  },
                  "parameters": {
                    "apiManagementServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                      }
                    },
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                      }
                    },
                    "apiName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the operation."
                      }
                    },
                    "displayName": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The display name of the operation."
                      }
                    },
                    "policies": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/policyType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The policies to apply to the operation."
                      }
                    },
                    "method": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. A Valid HTTP Operation Method. Typical Http Methods like GET, PUT, POST but not limited by only them."
                      }
                    },
                    "urlTemplate": {
                      "type": "string",
                      "minLength": 1,
                      "maxLength": 1000,
                      "metadata": {
                        "description": "Required. Relative URL template identifying the target resource for this operation. May include parameters. Example: /customers/{cid}/orders/{oid}/?date={date}."
                      }
                    },
                    "description": {
                      "type": "string",
                      "nullable": true,
                      "maxLength": 1000,
                      "metadata": {
                        "description": "Optional. Description of the operation. May include HTML formatting tags."
                      }
                    },
                    "request": {
                      "type": "object",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/request"
                        },
                        "description": "Optional. An entity containing request details."
                      },
                      "nullable": true
                    },
                    "responses": {
                      "type": "array",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/responses"
                        },
                        "description": "Optional. An entity containing request details."
                      },
                      "nullable": true
                    },
                    "templateParameters": {
                      "type": "array",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.ApiManagement/service/workspaces/apis/operations@2024-05-01#properties/properties/properties/templateParameters"
                        },
                        "description": "Optional. Collection of URL template parameters."
                      },
                      "nullable": true
                    }
                  },
                  "resources": {
                    "service::workspace::api": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service/workspaces/apis",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'))]"
                    },
                    "service::workspace": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service/workspaces",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
                    },
                    "service": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service",
                      "apiVersion": "2024-05-01",
                      "name": "[parameters('apiManagementServiceName')]"
                    },
                    "operation": {
                      "type": "Microsoft.ApiManagement/service/workspaces/apis/operations",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('name'))]",
                      "properties": {
                        "displayName": "[parameters('displayName')]",
                        "method": "[parameters('method')]",
                        "urlTemplate": "[parameters('urlTemplate')]",
                        "description": "[parameters('description')]",
                        "request": "[parameters('request')]",
                        "responses": "[parameters('responses')]",
                        "templateParameters": "[parameters('templateParameters')]"
                      }
                    },
                    "operation_policies": {
                      "copy": {
                        "name": "operation_policies",
                        "count": "[length(coalesce(parameters('policies'), createArray()))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('{0}-Pol-{1}', deployment().name, copyIndex())]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "apiManagementServiceName": {
                            "value": "[parameters('apiManagementServiceName')]"
                          },
                          "workspaceName": {
                            "value": "[parameters('workspaceName')]"
                          },
                          "apiName": {
                            "value": "[parameters('apiName')]"
                          },
                          "operationName": {
                            "value": "[parameters('name')]"
                          },
                          "name": {
                            "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'name')]"
                          },
                          "format": {
                            "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'format')]"
                          },
                          "value": {
                            "value": "[coalesce(parameters('policies'), createArray())[copyIndex()].value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "16589306317113419029"
                            },
                            "name": "API Management Workspace API Operation Policies",
                            "description": "This module deploys an API Operation Policy in an API Management Workspace."
                          },
                          "parameters": {
                            "apiManagementServiceName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                              }
                            },
                            "workspaceName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                              }
                            },
                            "apiName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent API. Required if the template is used in a standalone deployment."
                              }
                            },
                            "operationName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent operation. Required if the template is used in a standalone deployment."
                              }
                            },
                            "name": {
                              "type": "string",
                              "defaultValue": "policy",
                              "metadata": {
                                "description": "Optional. The name of the policy."
                              }
                            },
                            "format": {
                              "type": "string",
                              "defaultValue": "xml",
                              "allowedValues": [
                                "rawxml",
                                "rawxml-link",
                                "xml",
                                "xml-link"
                              ],
                              "metadata": {
                                "description": "Optional. Format of the policyContent."
                              }
                            },
                            "value": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. Contents of the Policy as defined by the format."
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ApiManagement/service/workspaces/apis/operations/policies",
                              "apiVersion": "2024-05-01",
                              "name": "[format('{0}/{1}/{2}/{3}/{4}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('operationName'), parameters('name'))]",
                              "properties": {
                                "value": "[parameters('value')]",
                                "format": "[parameters('format')]"
                              }
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the workspace API operation policy."
                              },
                              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/apis/operations/policies', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('operationName'), parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the workspace API operation policy."
                              },
                              "value": "[parameters('name')]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource group the workspace API operation policy was deployed into."
                              },
                              "value": "[resourceGroup().name]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "operation"
                      ]
                    }
                  },
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the operation."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/apis/operations', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('apiName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the operation."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the operation was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "api"
              ]
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace API."
              },
              "value": "[parameters('name')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace API."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/apis', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace API was deployed to."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace",
        "workspace_apiVersionSets",
        "workspace_loggers"
      ]
    },
    "workspace_apiVersionSets": {
      "copy": {
        "name": "workspace_apiVersionSets",
        "count": "[length(coalesce(parameters('apiVersionSets'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-ApiVerSet-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[coalesce(parameters('apiVersionSets'), createArray())[copyIndex()].name]"
          },
          "displayName": {
            "value": "[coalesce(parameters('apiVersionSets'), createArray())[copyIndex()].displayName]"
          },
          "versioningScheme": {
            "value": "[coalesce(parameters('apiVersionSets'), createArray())[copyIndex()].versioningScheme]"
          },
          "description": {
            "value": "[tryGet(coalesce(parameters('apiVersionSets'), createArray())[copyIndex()], 'description')]"
          },
          "versionHeaderName": {
            "value": "[tryGet(coalesce(parameters('apiVersionSets'), createArray())[copyIndex()], 'versionHeaderName')]"
          },
          "versionQueryName": {
            "value": "[tryGet(coalesce(parameters('apiVersionSets'), createArray())[copyIndex()], 'versionQueryName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15034813524419131585"
            },
            "name": "API Management Workspace API Version Sets",
            "description": "This module deploys an API Version Set in an API Management Workspace."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Optional. API Version set name."
              }
            },
            "displayName": {
              "type": "string",
              "minLength": 1,
              "maxLength": 100,
              "metadata": {
                "description": "Required. The display name of the API Version Set."
              }
            },
            "versioningScheme": {
              "type": "string",
              "allowedValues": [
                "Header",
                "Query",
                "Segment"
              ],
              "metadata": {
                "description": "Required. An value that determines where the API Version identifier will be located in a HTTP request."
              }
            },
            "description": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Description of API Version Set."
              }
            },
            "versionHeaderName": {
              "type": "string",
              "nullable": true,
              "minLength": 1,
              "maxLength": 100,
              "metadata": {
                "description": "Optional. Name of HTTP header parameter that indicates the API Version if versioningScheme is set to header."
              }
            },
            "versionQueryName": {
              "type": "string",
              "nullable": true,
              "minLength": 1,
              "maxLength": 100,
              "metadata": {
                "description": "Optional. Name of query parameter that indicates the API Version if versioningScheme is set to query."
              }
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "apiVersionSet": {
              "type": "Microsoft.ApiManagement/service/workspaces/apiVersionSets",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "displayName": "[parameters('displayName')]",
                "versioningScheme": "[parameters('versioningScheme')]",
                "description": "[parameters('description')]",
                "versionHeaderName": "[parameters('versionHeaderName')]",
                "versionQueryName": "[parameters('versionQueryName')]"
              }
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the API Version set."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/apiVersionSets', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the API Version set."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the API Version set was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace"
      ]
    },
    "workspace_backends": {
      "copy": {
        "name": "workspace_backends",
        "count": "[length(coalesce(parameters('backends'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Bcknd-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "url": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'url')]"
          },
          "description": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'description')]"
          },
          "credentials": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'credentials')]"
          },
          "name": {
            "value": "[coalesce(parameters('backends'), createArray())[copyIndex()].name]"
          },
          "protocol": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'protocol')]"
          },
          "proxy": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'proxy')]"
          },
          "resourceId": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'resourceId')]"
          },
          "serviceFabricCluster": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'serviceFabricCluster')]"
          },
          "title": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'title')]"
          },
          "tls": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'tls')]"
          },
          "circuitBreaker": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'circuitBreaker')]"
          },
          "pool": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'pool')]"
          },
          "type": {
            "value": "[tryGet(coalesce(parameters('backends'), createArray())[copyIndex()], 'type')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16927512650051470600"
            },
            "name": "API Management Workspace Backends",
            "description": "This module deploys a Backend in an API Management Workspace."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. Backend Name."
              }
            },
            "credentials": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/credentials"
                },
                "description": "Optional. Backend Credentials Contract Properties. Not supported for Backend Pools."
              },
              "nullable": true
            },
            "description": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Backend Description."
              }
            },
            "protocol": {
              "type": "string",
              "defaultValue": "http",
              "metadata": {
                "description": "Optional. Backend communication protocol. http or soap. Not supported for Backend Pools."
              }
            },
            "proxy": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/proxy"
                },
                "description": "Optional. Backend Proxy Contract Properties. Not supported for Backend Pools."
              },
              "nullable": true
            },
            "resourceId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Management Uri of the Resource in External System. This URL can be the Arm Resource ID of Logic Apps, Function Apps or API Apps. Not supported for Backend Pools."
              }
            },
            "serviceFabricCluster": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/properties/properties/serviceFabricCluster"
                },
                "description": "Optional. Backend Service Fabric Cluster Properties. Not supported for Backend Pools."
              },
              "nullable": true
            },
            "title": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Backend Title."
              }
            },
            "tls": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/tls"
                },
                "description": "Optional. Backend TLS Properties. Not supported for Backend Pools. If not specified and type is Single, TLS properties will default to validateCertificateChain and validateCertificateName set to true."
              },
              "nullable": true
            },
            "url": {
              "type": "string",
              "nullable": true,
              "minLength": 1,
              "maxLength": 2000,
              "metadata": {
                "description": "Conditional. Runtime URL of the Backend. Required if type is Single and not supported if type is Pool."
              }
            },
            "circuitBreaker": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/circuitBreaker"
                },
                "description": "Optional. Backend Circuit Breaker Configuration. Not supported for Backend Pools."
              },
              "nullable": true
            },
            "pool": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/backends@2024-05-01#properties/properties/properties/pool"
                },
                "description": "Conditional. Backend pool configuration for load balancing. Required if type is Pool and not supported if type is Single."
              },
              "nullable": true
            },
            "type": {
              "type": "string",
              "defaultValue": "Single",
              "allowedValues": [
                "Single",
                "Pool"
              ],
              "metadata": {
                "description": "Optional. Type of the backend. A backend can be either Single or Pool."
              }
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "backend": {
              "type": "Microsoft.ApiManagement/service/workspaces/backends",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": "[shallowMerge(createArray(createObject('description', parameters('description'), 'title', parameters('title'), 'type', parameters('type')), if(equals(parameters('type'), 'Single'), createObject('resourceId', parameters('resourceId'), 'credentials', parameters('credentials'), 'proxy', parameters('proxy'), 'circuitBreaker', parameters('circuitBreaker'), 'protocol', parameters('protocol'), 'properties', createObject('serviceFabricCluster', parameters('serviceFabricCluster')), 'tls', coalesce(parameters('tls'), createObject('validateCertificateChain', true(), 'validateCertificateName', true())), 'url', parameters('url')), createObject('pool', parameters('pool')))))]"
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace backend."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/backends', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace backend."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace backend was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace"
      ]
    },
    "workspace_diagnostics": {
      "copy": {
        "name": "workspace_diagnostics",
        "count": "[length(coalesce(parameters('diagnostics'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Diag-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[coalesce(parameters('diagnostics'), createArray())[copyIndex()].name]"
          },
          "loggerResourceId": {
            "value": "[coalesce(parameters('diagnostics'), createArray())[copyIndex()].loggerResourceId]"
          },
          "alwaysLog": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'alwaysLog')]"
          },
          "backend": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'backend')]"
          },
          "frontend": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'frontend')]"
          },
          "httpCorrelationProtocol": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'httpCorrelationProtocol')]"
          },
          "logClientIp": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'logClientIp')]"
          },
          "metrics": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'metrics')]"
          },
          "operationNameFormat": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'operationNameFormat')]"
          },
          "samplingPercentage": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'samplingPercentage')]"
          },
          "verbosity": {
            "value": "[tryGet(coalesce(parameters('diagnostics'), createArray())[copyIndex()], 'verbosity')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6466928030405979367"
            },
            "name": "API Management Workspace Diagnostics",
            "description": "This module deploys a Diagnostic at API Management Workspace scope."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. Diagnostic Name."
              }
            },
            "loggerResourceId": {
              "type": "string",
              "metadata": {
                "description": "Required. Logger resource ID."
              }
            },
            "alwaysLog": {
              "type": "string",
              "defaultValue": "allErrors",
              "metadata": {
                "description": "Optional. Specifies for what type of messages sampling settings should not apply."
              }
            },
            "backend": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/diagnostics@2024-05-01#properties/properties/properties/backend"
                },
                "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Backend."
              },
              "nullable": true
            },
            "frontend": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/diagnostics@2024-05-01#properties/properties/properties/frontend"
                },
                "description": "Optional. Diagnostic settings for incoming/outgoing HTTP messages to the Gateway."
              },
              "nullable": true
            },
            "httpCorrelationProtocol": {
              "type": "string",
              "defaultValue": "Legacy",
              "allowedValues": [
                "Legacy",
                "None",
                "W3C"
              ],
              "metadata": {
                "description": "Conditional. Sets correlation protocol to use for Application Insights diagnostics. Required if using Application Insights."
              }
            },
            "logClientIp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Log the ClientIP."
              }
            },
            "metrics": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Conditional. Emit custom metrics via emit-metric policy. Required if using Application Insights."
              }
            },
            "operationNameFormat": {
              "type": "string",
              "defaultValue": "Name",
              "allowedValues": [
                "Name",
                "Url"
              ],
              "metadata": {
                "description": "Optional. The format of the Operation Name for Application Insights telemetries."
              }
            },
            "samplingPercentage": {
              "type": "int",
              "defaultValue": 100,
              "metadata": {
                "description": "Optional. Rate of sampling for fixed-rate sampling. Specifies the percentage of requests that are logged."
              }
            },
            "verbosity": {
              "type": "string",
              "defaultValue": "information",
              "allowedValues": [
                "error",
                "information",
                "verbose"
              ],
              "metadata": {
                "description": "Optional. The verbosity level applied to traces emitted by trace policies."
              }
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "diagnostic": {
              "type": "Microsoft.ApiManagement/service/workspaces/diagnostics",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "loggerId": "[parameters('loggerResourceId')]",
                "alwaysLog": "[parameters('alwaysLog')]",
                "backend": "[parameters('backend')]",
                "frontend": "[parameters('frontend')]",
                "httpCorrelationProtocol": "[parameters('httpCorrelationProtocol')]",
                "logClientIp": "[parameters('logClientIp')]",
                "metrics": "[parameters('metrics')]",
                "operationNameFormat": "[parameters('operationNameFormat')]",
                "sampling": {
                  "percentage": "[parameters('samplingPercentage')]",
                  "samplingType": "fixed"
                },
                "verbosity": "[parameters('verbosity')]"
              }
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace diagnostic."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/diagnostics', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace diagnostic."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace diagnostic was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace",
        "workspace_loggers"
      ]
    },
    "workspace_loggers": {
      "copy": {
        "name": "workspace_loggers",
        "count": "[length(coalesce(parameters('loggers'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Logg-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[coalesce(parameters('loggers'), createArray())[copyIndex()].name]"
          },
          "credentials": {
            "value": "[tryGet(coalesce(parameters('loggers'), createArray())[copyIndex()], 'credentials')]"
          },
          "isBuffered": {
            "value": "[tryGet(coalesce(parameters('loggers'), createArray())[copyIndex()], 'isBuffered')]"
          },
          "description": {
            "value": "[tryGet(coalesce(parameters('loggers'), createArray())[copyIndex()], 'description')]"
          },
          "type": {
            "value": "[coalesce(parameters('loggers'), createArray())[copyIndex()].type]"
          },
          "targetResourceId": {
            "value": "[tryGet(coalesce(parameters('loggers'), createArray())[copyIndex()], 'targetResourceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3983342881327906024"
            },
            "name": "API Management Workspace Loggers",
            "description": "This module deploys a Logger in an API Management Workspace."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. Logger name."
              }
            },
            "description": {
              "type": "string",
              "nullable": true,
              "maxLength": 256,
              "metadata": {
                "description": "Optional. Description of the logger."
              }
            },
            "isBuffered": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Whether records are buffered in the logger before publishing."
              }
            },
            "type": {
              "type": "string",
              "allowedValues": [
                "applicationInsights",
                "azureEventHub",
                "azureMonitor"
              ],
              "metadata": {
                "description": "Required. Logger type."
              }
            },
            "targetResourceId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Conditional. Azure Resource Id of a log target (either Azure Event Hub resource or Azure Application Insights resource). Required if loggerType = applicationInsights or azureEventHub."
              }
            },
            "credentials": {
              "type": "secureObject",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/loggers@2024-05-01#properties/properties/properties/credentials"
                },
                "description": "Conditional. The name and SendRule connection string of the event hub for azureEventHub logger. Instrumentation key for applicationInsights logger. Required if loggerType = applicationInsights or azureEventHub, ignored if loggerType = azureMonitor."
              },
              "nullable": true
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "logger": {
              "type": "Microsoft.ApiManagement/service/workspaces/loggers",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": "[shallowMerge(createArray(createObject('description', parameters('description'), 'isBuffered', parameters('isBuffered'), 'loggerType', parameters('type'), 'resourceId', parameters('targetResourceId')), if(not(equals(parameters('type'), 'azureMonitor')), createObject('credentials', parameters('credentials')), createObject())))]"
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace logger."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/loggers', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace logger."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace logger was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace",
        "workspace_namedValues"
      ]
    },
    "workspace_namedValues": {
      "copy": {
        "name": "workspace_namedValues",
        "count": "[length(coalesce(parameters('namedValues'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-NamVal-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "displayName": {
            "value": "[coalesce(parameters('namedValues'), createArray())[copyIndex()].displayName]"
          },
          "keyVault": {
            "value": "[tryGet(coalesce(parameters('namedValues'), createArray())[copyIndex()], 'keyVault')]"
          },
          "name": {
            "value": "[coalesce(parameters('namedValues'), createArray())[copyIndex()].name]"
          },
          "tags": {
            "value": "[tryGet(coalesce(parameters('namedValues'), createArray())[copyIndex()], 'tags')]"
          },
          "secret": {
            "value": "[tryGet(coalesce(parameters('namedValues'), createArray())[copyIndex()], 'secret')]"
          },
          "value": {
            "value": "[tryGet(coalesce(parameters('namedValues'), createArray())[copyIndex()], 'value')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8239145656546334716"
            },
            "name": "API Management Workspace Named Values",
            "description": "This module deploys a Named Value in an API Management Workspace."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "displayName": {
              "type": "string",
              "minLength": 1,
              "maxLength": 256,
              "metadata": {
                "description": "Required. Unique name of NamedValue. It may contain only letters, digits, period, dash, and underscore characters."
              }
            },
            "keyVault": {
              "type": "object",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/namedValues@2024-05-01#properties/properties/properties/keyVault"
                },
                "description": "Optional. KeyVault location details of the namedValue."
              },
              "nullable": true
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the named value."
              }
            },
            "tags": {
              "type": "array",
              "metadata": {
                "__bicep_resource_derived_type!": {
                  "source": "Microsoft.ApiManagement/service/workspaces/namedValues@2024-05-01#properties/properties/properties/tags"
                },
                "description": "Optional. Tags that when provided can be used to filter the NamedValue list."
              },
              "nullable": true
            },
            "secret": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Determines whether the value is a secret and should be encrypted or not."
              }
            },
            "value": {
              "type": "securestring",
              "defaultValue": "[newGuid()]",
              "maxLength": 4096,
              "metadata": {
                "description": "Optional. Value of the NamedValue. Can contain policy expressions. It may not be empty or consist only of whitespace. This property will not be filled on 'GET' operations! Use '/listSecrets' POST request to get the value."
              }
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "namedValue": {
              "type": "Microsoft.ApiManagement/service/workspaces/namedValues",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "tags": "[parameters('tags')]",
                "secret": "[parameters('secret')]",
                "displayName": "[parameters('displayName')]",
                "value": "[if(empty(parameters('keyVault')), parameters('value'), null())]",
                "keyVault": "[parameters('keyVault')]"
              }
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace named value."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/namedValues', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace named value."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace named value was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace"
      ]
    },
    "workspace_policies": {
      "copy": {
        "name": "workspace_policies",
        "count": "[length(coalesce(parameters('policies'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Pol-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'name')]"
          },
          "format": {
            "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'format')]"
          },
          "value": {
            "value": "[coalesce(parameters('policies'), createArray())[copyIndex()].value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14191666701815015096"
            },
            "name": "API Management Workspace Policies",
            "description": "This module deploys a Policy at API Management Workspace scope."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "policy",
              "metadata": {
                "description": "Optional. The name of the policy."
              }
            },
            "format": {
              "type": "string",
              "defaultValue": "xml",
              "allowedValues": [
                "rawxml",
                "rawxml-link",
                "xml",
                "xml-link"
              ],
              "metadata": {
                "description": "Optional. Format of the policyContent."
              }
            },
            "value": {
              "type": "string",
              "metadata": {
                "description": "Required. Contents of the Policy as defined by the format."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ApiManagement/service/workspaces/policies",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "format": "[parameters('format')]",
                "value": "[parameters('value')]"
              }
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace policy."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/policies', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace policy."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace policy was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace"
      ]
    },
    "workspace_products": {
      "copy": {
        "name": "workspace_products",
        "count": "[length(coalesce(parameters('products'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Prd-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[coalesce(parameters('products'), createArray())[copyIndex()].name]"
          },
          "displayName": {
            "value": "[coalesce(parameters('products'), createArray())[copyIndex()].displayName]"
          },
          "approvalRequired": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'approvalRequired')]"
          },
          "description": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'description')]"
          },
          "apiLinks": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'apiLinks')]"
          },
          "groupLinks": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'groupLinks')]"
          },
          "policies": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'policies')]"
          },
          "state": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'state')]"
          },
          "subscriptionRequired": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'subscriptionRequired')]"
          },
          "subscriptionsLimit": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'subscriptionsLimit')]"
          },
          "terms": {
            "value": "[tryGet(coalesce(parameters('products'), createArray())[copyIndex()], 'terms')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17739451536850644299"
            },
            "name": "API Management Workspace Products",
            "description": "This module deploys a Product in an API Management Workspace."
          },
          "definitions": {
            "productPolicyType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The name of the policy."
                  }
                },
                "format": {
                  "type": "string",
                  "allowedValues": [
                    "rawxml",
                    "rawxml-link",
                    "xml",
                    "xml-link"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Format of the policyContent."
                  }
                },
                "value": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Contents of the Policy as defined by the format."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of a product policy."
              }
            },
            "apiLinkType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the API link."
                  }
                },
                "apiResourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Full resource Id of an API."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of a product API link."
              }
            },
            "groupLinkType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the Product Group link."
                  }
                },
                "groupResourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Full resource Id of a Group."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true,
                "description": "The type of a product group link."
              }
            }
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "minLength": 1,
              "maxLength": 256,
              "metadata": {
                "description": "Required. Product Name."
              }
            },
            "displayName": {
              "type": "string",
              "minLength": 1,
              "maxLength": 300,
              "metadata": {
                "description": "Required. Product display name."
              }
            },
            "approvalRequired": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Whether subscription approval is required. If false, new subscriptions will be approved automatically enabling developers to call the product's APIs immediately after subscribing. If true, administrators must manually approve the subscription before the developer can any of the product's APIs. Can be present only if subscriptionRequired property is present and has a value of false."
              }
            },
            "description": {
              "type": "string",
              "defaultValue": "",
              "maxLength": 1000,
              "metadata": {
                "description": "Optional. Product description. May include HTML formatting tags."
              }
            },
            "apiLinks": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/apiLinkType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Names of Product API Links."
              }
            },
            "groupLinks": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/groupLinkType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Names of Product Group Links."
              }
            },
            "policies": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/productPolicyType"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. Array of Policies to apply to the Product."
              }
            },
            "state": {
              "type": "string",
              "defaultValue": "published",
              "allowedValues": [
                "notPublished",
                "published"
              ],
              "metadata": {
                "description": "Optional. Whether product is published or not. Published products are discoverable by users of developer portal. Non published products are visible only to administrators."
              }
            },
            "subscriptionRequired": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Whether a product subscription is required for accessing APIs included in this product. If true, the product is referred to as \"protected\" and a valid subscription key is required for a request to an API included in the product to succeed. If false, the product is referred to as \"open\" and requests to an API included in the product can be made without a subscription key. If property is omitted when creating a new product it's value is assumed to be true."
              }
            },
            "subscriptionsLimit": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Optional. Whether the number of subscriptions a user can have to this product at the same time. Set to null or omit to allow unlimited per user subscriptions. Can be present only if subscriptionRequired property is present and has a value of false."
              }
            },
            "terms": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. Product terms of use. Developers trying to subscribe to the product will be presented and required to accept these terms before they can complete the subscription process."
              }
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "product": {
              "type": "Microsoft.ApiManagement/service/workspaces/products",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "description": "[parameters('description')]",
                "displayName": "[parameters('displayName')]",
                "terms": "[parameters('terms')]",
                "subscriptionRequired": "[parameters('subscriptionRequired')]",
                "approvalRequired": "[if(parameters('subscriptionRequired'), parameters('approvalRequired'), null())]",
                "subscriptionsLimit": "[if(parameters('subscriptionRequired'), parameters('subscriptionsLimit'), null())]",
                "state": "[parameters('state')]"
              }
            },
            "product_apiLinks": {
              "copy": {
                "name": "product_apiLinks",
                "count": "[length(coalesce(parameters('apiLinks'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-ApiLnk-{1}', deployment().name, copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "apiManagementServiceName": {
                    "value": "[parameters('apiManagementServiceName')]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "productName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[coalesce(parameters('apiLinks'), createArray())[copyIndex()].name]"
                  },
                  "apiResourceId": {
                    "value": "[coalesce(parameters('apiLinks'), createArray())[copyIndex()].apiResourceId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "10398416687685575846"
                    },
                    "name": "API Management Workspace Product API Links",
                    "description": "This module deploys an Product API Link in an API Management Workspace."
                  },
                  "parameters": {
                    "apiManagementServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                      }
                    },
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                      }
                    },
                    "productName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the Product API link."
                      }
                    },
                    "apiResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Full resource Id of an API."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/workspaces/products/apiLinks",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('productName'), parameters('name'))]",
                      "properties": {
                        "apiId": "[parameters('apiResourceId')]"
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the workspace product API link."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/products/apiLinks', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('productName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the workspace product API link."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the workspace product API link was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "product"
              ]
            },
            "product_groupLinks": {
              "copy": {
                "name": "product_groupLinks",
                "count": "[length(coalesce(parameters('groupLinks'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-GrpLnk-{1}', deployment().name, copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "apiManagementServiceName": {
                    "value": "[parameters('apiManagementServiceName')]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "productName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[coalesce(parameters('groupLinks'), createArray())[copyIndex()].name]"
                  },
                  "groupResourceId": {
                    "value": "[coalesce(parameters('groupLinks'), createArray())[copyIndex()].groupResourceId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "9816498973930744055"
                    },
                    "name": "API Management Workspace Product Group Links",
                    "description": "This module deploys a Product Group Link in an API Management Workspace."
                  },
                  "parameters": {
                    "apiManagementServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                      }
                    },
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                      }
                    },
                    "productName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Product. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. The name of the Product Group link."
                      }
                    },
                    "groupResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Full resource Id of a Group."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/workspaces/products/groupLinks",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('productName'), parameters('name'))]",
                      "properties": {
                        "groupId": "[parameters('groupResourceId')]"
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the workspace product group link."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/products/groupLinks', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('productName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the workspace product group link."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the workspace product group link was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "product"
              ]
            },
            "product_policies": {
              "copy": {
                "name": "product_policies",
                "count": "[length(coalesce(parameters('policies'), createArray()))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('{0}-Pol-{1}', deployment().name, copyIndex())]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "apiManagementServiceName": {
                    "value": "[parameters('apiManagementServiceName')]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "productName": {
                    "value": "[parameters('name')]"
                  },
                  "name": {
                    "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'name')]"
                  },
                  "format": {
                    "value": "[tryGet(coalesce(parameters('policies'), createArray())[copyIndex()], 'format')]"
                  },
                  "value": {
                    "value": "[coalesce(parameters('policies'), createArray())[copyIndex()].value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "10248235472065827019"
                    },
                    "name": "API Management Workspace Product Policies",
                    "description": "This module deploys a Policy for a Product in an API Management Workspace."
                  },
                  "parameters": {
                    "apiManagementServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
                      }
                    },
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
                      }
                    },
                    "productName": {
                      "type": "string",
                      "metadata": {
                        "description": "Conditional. The name of the parent product. Required if the template is used in a standalone deployment."
                      }
                    },
                    "name": {
                      "type": "string",
                      "defaultValue": "policy",
                      "metadata": {
                        "description": "Optional. The name of the policy."
                      }
                    },
                    "format": {
                      "type": "string",
                      "defaultValue": "xml",
                      "allowedValues": [
                        "rawxml",
                        "rawxml-link",
                        "xml",
                        "xml-link"
                      ],
                      "metadata": {
                        "description": "Optional. Format of the policyContent."
                      }
                    },
                    "value": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Contents of the Policy as defined by the format."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/workspaces/products/policies",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}/{2}/{3}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('productName'), parameters('name'))]",
                      "properties": {
                        "format": "[parameters('format')]",
                        "value": "[parameters('value')]"
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the workspace product policy."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/products/policies', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('productName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the workspace product policy."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the workspace product policy was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    }
                  }
                }
              },
              "dependsOn": [
                "product"
              ]
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace product."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/products', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace product."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace product was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace",
        "workspace_apis"
      ]
    },
    "workspace_subscriptions": {
      "copy": {
        "name": "workspace_subscriptions",
        "count": "[length(coalesce(parameters('subscriptions'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Sub-{1}', deployment().name, copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementServiceName": {
            "value": "[parameters('apiManagementServiceName')]"
          },
          "workspaceName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "[coalesce(parameters('subscriptions'), createArray())[copyIndex()].name]"
          },
          "displayName": {
            "value": "[coalesce(parameters('subscriptions'), createArray())[copyIndex()].displayName]"
          },
          "allowTracing": {
            "value": "[tryGet(coalesce(parameters('subscriptions'), createArray())[copyIndex()], 'allowTracing')]"
          },
          "ownerId": {
            "value": "[tryGet(coalesce(parameters('subscriptions'), createArray())[copyIndex()], 'ownerId')]"
          },
          "primaryKey": {
            "value": "[tryGet(coalesce(parameters('subscriptions'), createArray())[copyIndex()], 'primaryKey')]"
          },
          "scope": {
            "value": "[tryGet(coalesce(parameters('subscriptions'), createArray())[copyIndex()], 'scope')]"
          },
          "secondaryKey": {
            "value": "[tryGet(coalesce(parameters('subscriptions'), createArray())[copyIndex()], 'secondaryKey')]"
          },
          "state": {
            "value": "[tryGet(coalesce(parameters('subscriptions'), createArray())[copyIndex()], 'state')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10226887119813429553"
            },
            "name": "API Management Workspace Subscriptions",
            "description": "This module deploys a Subscription in an API Management Workspace."
          },
          "parameters": {
            "apiManagementServiceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent API Management service. Required if the template is used in a standalone deployment."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent Workspace. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. Subscription name."
              }
            },
            "displayName": {
              "type": "string",
              "minLength": 1,
              "maxLength": 100,
              "metadata": {
                "description": "Required. API Management Service Subscriptions name."
              }
            },
            "allowTracing": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Determines whether tracing can be enabled."
              }
            },
            "ownerId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. User (user ID path) for whom subscription is being created in form /users/{userId}."
              }
            },
            "primaryKey": {
              "type": "securestring",
              "nullable": true,
              "minLength": 1,
              "maxLength": 256,
              "metadata": {
                "description": "Optional. Primary subscription key. If not specified during request key will be generated automatically."
              }
            },
            "scope": {
              "type": "string",
              "defaultValue": "/apis",
              "metadata": {
                "description": "Optional. Scope like \"/products/{productId}\" or \"/apis\" or \"/apis/{apiId}\"."
              }
            },
            "secondaryKey": {
              "type": "securestring",
              "nullable": true,
              "minLength": 1,
              "maxLength": 256,
              "metadata": {
                "description": "Optional. Secondary subscription key. If not specified during request key will be generated automatically."
              }
            },
            "state": {
              "type": "string",
              "nullable": true,
              "allowedValues": [
                "active",
                "cancelled",
                "expired",
                "rejected",
                "submitted",
                "suspended"
              ],
              "metadata": {
                "description": "Optional. Initial subscription state. If no value is specified, subscription is created with Submitted state. Possible states are:\n* active - the subscription is active\n* suspended - the subscription is blocked, and the subscriber cannot call any APIs of the product\n* submitted - the subscription request has been made by the developer, but has not yet been approved or rejected\n* rejected - the subscription request has been denied by an administrator\n* cancelled - the subscription has been cancelled by the developer or administrator\n* expired - the subscription reached its expiration date and was deactivated."
              }
            }
          },
          "resources": {
            "service::workspace": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service/workspaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('apiManagementServiceName'), parameters('workspaceName'))]"
            },
            "service": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2024-05-01",
              "name": "[parameters('apiManagementServiceName')]"
            },
            "subscription": {
              "type": "Microsoft.ApiManagement/service/workspaces/subscriptions",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]",
              "properties": {
                "displayName": "[parameters('displayName')]",
                "allowTracing": "[parameters('allowTracing')]",
                "ownerId": "[parameters('ownerId')]",
                "primaryKey": "[parameters('primaryKey')]",
                "scope": "[parameters('scope')]",
                "secondaryKey": "[parameters('secondaryKey')]",
                "state": "[parameters('state')]"
              }
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the workspace subscription."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service/workspaces/subscriptions', parameters('apiManagementServiceName'), parameters('workspaceName'), parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace subscription."
              },
              "value": "[parameters('name')]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The resource group the workspace subscription was deployed into."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "workspace",
        "workspace_apis",
        "workspace_products"
      ]
    },
    "workspace_gateway": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-Gw', deployment().name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('gateway').name]"
          },
          "location": {
            "value": "[tryGet(parameters('gateway'), 'location')]"
          },
          "capacity": {
            "value": "[tryGet(parameters('gateway'), 'capacity')]"
          },
          "virtualNetworkType": {
            "value": "[tryGet(parameters('gateway'), 'virtualNetworkType')]"
          },
          "subnetResourceId": {
            "value": "[tryGet(parameters('gateway'), 'subnetResourceId')]"
          },
          "workspaceResourceId": {
            "value": "[resourceId('Microsoft.ApiManagement/service/workspaces', parameters('apiManagementServiceName'), parameters('name'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1435160831078296813"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the API Management Workspace Gateway."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Optional. The location for the API Management Gateway. Defaults to the resource group location."
              }
            },
            "capacity": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Optional. The capacity of the API Management Workspace Gateway. Default is 1."
              }
            },
            "virtualNetworkType": {
              "type": "string",
              "defaultValue": "None",
              "allowedValues": [
                "None",
                "External",
                "Internal"
              ],
              "metadata": {
                "description": "Optional. The virtual network type for the API Management Workspace Gateway."
              }
            },
            "subnetResourceId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Conditional. The resource ID of the subnet to associate with the gateway backend. Required if virtualNetworkType is External or Internal. The subnet must be in the same region and subscription as the APIM instance and must be delegated to the required service: `Microsoft.Web/serverFarms` for External virtualNetworkType, `Microsoft.Web/hostingEnvironments` for Internal virtualNetworkType."
              }
            },
            "workspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "Required. The resource ID of the API Management workspace to connect to."
              }
            }
          },
          "resources": {
            "gateway": {
              "type": "Microsoft.ApiManagement/gateways",
              "apiVersion": "2024-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "WorkspaceGatewayPremium",
                "capacity": "[parameters('capacity')]"
              },
              "properties": {
                "backend": {
                  "subnet": "[if(not(empty(parameters('subnetResourceId'))), createObject('id', parameters('subnetResourceId')), null())]"
                },
                "virtualNetworkType": "[parameters('virtualNetworkType')]"
              }
            },
            "configConnection": {
              "type": "Microsoft.ApiManagement/gateways/configConnections",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), take(format('{0}-{1}', take(parameters('name'), 24), uniqueString(parameters('workspaceResourceId'))), 30))]",
              "properties": {
                "sourceId": "[parameters('workspaceResourceId')]"
              },
              "dependsOn": [
                "gateway"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "workspace"
      ]
    }
  },
  "outputs": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the API management workspace."
      },
      "value": "[parameters('name')]"
    },
    "resourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the API management workspace."
      },
      "value": "[resourceId('Microsoft.ApiManagement/service/workspaces', parameters('apiManagementServiceName'), parameters('name'))]"
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The resource group the API management workspace was deployed into."
      },
      "value": "[resourceGroup().name]"
    }
  }
}