{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.27.1.19265",
      "templateHash": "16143234107381767540"
    },
    "name": "Container App Jobs",
    "description": "This module deploys a Container App Job.",
    "owner": "Azure/module-maintainers"
  },
  "definitions": {
    "managedIdentitiesType": {
      "type": "object",
      "properties": {
        "systemAssigned": {
          "type": "bool",
          "nullable": true,
          "metadata": {
            "description": "Optional. Enables system assigned managed identity on the resource."
          }
        },
        "userAssignedResourceIds": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "nullable": true,
          "metadata": {
            "description": "Optional. The resource ID(s) to assign to the resource."
          }
        }
      },
      "nullable": true
    },
    "lockType": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Specify the name of lock."
          }
        },
        "kind": {
          "type": "string",
          "allowedValues": [
            "CanNotDelete",
            "None",
            "ReadOnly"
          ],
          "nullable": true,
          "metadata": {
            "description": "Optional. Specify the type of lock."
          }
        }
      },
      "nullable": true
    },
    "roleAssignmentType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "roleDefinitionIdOrName": {
            "type": "string",
            "metadata": {
              "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
            }
          },
          "principalId": {
            "type": "string",
            "metadata": {
              "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
            }
          },
          "principalType": {
            "type": "string",
            "allowedValues": [
              "Device",
              "ForeignGroup",
              "Group",
              "ServicePrincipal",
              "User"
            ],
            "nullable": true,
            "metadata": {
              "description": "Optional. The principal type of the assigned principal ID."
            }
          },
          "description": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. The description of the role assignment."
            }
          },
          "condition": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
            }
          },
          "conditionVersion": {
            "type": "string",
            "allowedValues": [
              "2.0"
            ],
            "nullable": true,
            "metadata": {
              "description": "Optional. Version of the condition."
            }
          },
          "delegatedManagedIdentityResourceId": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. The Resource Id of the delegated managed identity resource."
            }
          }
        }
      },
      "nullable": true
    },
    "registryCredentialsType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "server": {
            "type": "string",
            "metadata": {
              "example": "myregistry.azurecr.io",
              "description": "Required. The FQDN name of the container registry."
            }
          },
          "identity": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "example": "    user-assigned identity: /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myManagedIdentity\r\n    system-assigned identity: system\r\n    ",
              "description": "Optional. The resource ID of the (user) managed identity, which is used to access the Azure Container Registry."
            }
          },
          "username": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. The username for the container registry."
            }
          },
          "passwordSecretRef": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Conditional. The name of the secret contains the login password. Required if `username` is not null."
            }
          }
        }
      },
      "nullable": true
    },
    "secretsType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "identity": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. Resource ID of a managed identity to authenticate with Azure Key Vault, or System to use a system-assigned identity."
            }
          },
          "keyVaultUrl": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "example": "    https://myvault${environment().suffixes.keyvaultDns}/secrets/mysecret\r\n    ",
              "description": "Conditional. Azure Key Vault URL pointing to the secret referenced by the Container App Job. Required if `value` is null."
            }
          },
          "name": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. The name of the secret."
            }
          },
          "value": {
            "type": "securestring",
            "nullable": true,
            "metadata": {
              "description": "Conditional. The secret value, if not fetched from Key Vault. Required if `keyVaultUrl` is not null."
            }
          }
        }
      },
      "nullable": true
    },
    "secretVolumeItemType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "path": {
            "type": "string",
            "metadata": {
              "description": "Required. Path to project secret to. If no path is provided, path defaults to name of secret listed in secretRef."
            }
          },
          "secretRef": {
            "type": "string",
            "metadata": {
              "description": "Required. Name of the Container App secret from which to pull the secret value."
            }
          }
        }
      },
      "nullable": true
    },
    "volumeType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "metadata": {
              "description": "Required. The name of the volume."
            }
          },
          "mountOptions": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Conditional. Mount options used while mounting the Azure file share or NFS Azure file share. Must be a comma-separated string. Required if `storageType` is not `EmptyDir`."
            }
          },
          "secrets": {
            "$ref": "#/definitions/secretVolumeItemType",
            "metadata": {
              "description": "Optional. List of secrets to be added in volume. If no secrets are provided, all secrets in collection will be added to volume."
            }
          },
          "storageName": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Conditional. The storage account name. Not needed for EmptyDir and Secret. Required if `storageType` is `AzureFile` or `NfsAzureFile`."
            }
          },
          "storageType": {
            "type": "string",
            "allowedValues": [
              "AzureFile",
              "EmptyDir",
              "NfsAzureFile",
              "Secret"
            ],
            "metadata": {
              "description": "Required. The container name."
            }
          }
        }
      },
      "nullable": true
    },
    "containerEnvironmentVariablesType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "metadata": {
              "description": "Required. The environment variable name."
            }
          },
          "secretRef": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Conditional. The name of the Container App secret from which to pull the envrionment variable value. Required if `value` is null."
            }
          },
          "value": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Conditional. The environment variable value. Required if `secretRef` is null."
            }
          }
        }
      },
      "nullable": true
    },
    "containerProbeHttpGetHttpHeadersItem": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "metadata": {
              "description": "Required. The header field name."
            }
          },
          "value": {
            "type": "string",
            "metadata": {
              "description": "Required. The header field value."
            }
          }
        }
      },
      "nullable": true
    },
    "containerProbeHttpGetType": {
      "type": "object",
      "properties": {
        "host": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Optional. Host name to connect to, defaults to the pod IP."
          }
        },
        "httpHeaders": {
          "$ref": "#/definitions/containerProbeHttpGetHttpHeadersItem",
          "metadata": {
            "description": "Optional. Custom headers to set in the request."
          }
        },
        "path": {
          "type": "string",
          "metadata": {
            "description": "Required. Path to access on the HTTP server."
          }
        },
        "port": {
          "type": "int",
          "minValue": 1,
          "maxValue": 65535,
          "metadata": {
            "description": "Required. Name of the port to access on the container. If not specified, the containerPort is used."
          }
        },
        "scheme": {
          "type": "string",
          "allowedValues": [
            "HTTP",
            "HTTPS"
          ],
          "nullable": true,
          "metadata": {
            "description": "Required. Scheme to use for connecting to the host. Defaults to HTTP."
          }
        }
      },
      "nullable": true
    },
    "containerProbeTcpSocketType": {
      "type": "object",
      "properties": {
        "host": {
          "type": "string",
          "metadata": {
            "description": "Optional. Host name to connect to, defaults to the pod IP."
          }
        },
        "port": {
          "type": "int",
          "minValue": 1,
          "maxValue": 65535,
          "metadata": {
            "description": "Required. Name of the port to access on the container. If not specified, the containerPort is used."
          }
        }
      },
      "nullable": true
    },
    "containerProbeType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "failureThreshold": {
            "type": "int",
            "nullable": true,
            "minValue": 1,
            "maxValue": 10,
            "metadata": {
              "description": "Optional. Minimum consecutive failures for the probe to be considered failed after having succeeded. Defaults to 3."
            }
          },
          "httpGet": {
            "$ref": "#/definitions/containerProbeHttpGetType",
            "metadata": {
              "description": "Optional. HTTPGet specifies the http request to perform."
            }
          },
          "initialDelaySeconds": {
            "type": "int",
            "minValue": 1,
            "maxValue": 60,
            "metadata": {
              "description": "Optional. Number of seconds after the container has started before liveness probes are initiated."
            }
          },
          "periodSeconds": {
            "type": "int",
            "minValue": 1,
            "maxValue": 60,
            "metadata": {
              "description": "Optional. How often (in seconds) to perform the probe. Default to 10 seconds."
            }
          },
          "successThreshold": {
            "type": "int",
            "nullable": true,
            "minValue": 1,
            "maxValue": 10,
            "metadata": {
              "description": "Optional. Minimum consecutive successes for the probe to be considered successful after having failed. Defaults to 1."
            }
          },
          "tcpSocket": {
            "$ref": "#/definitions/containerProbeTcpSocketType",
            "metadata": {
              "description": "Optional. TCPSocket specifies an action involving a TCP port."
            }
          },
          "terminationGracePeriodSeconds": {
            "type": "int",
            "nullable": true,
            "minValue": 0,
            "maxValue": 3600,
            "metadata": {
              "description": "Optional. Duration in seconds the pod needs to terminate gracefully upon probe failure. This is an alpha field and requires enabling ProbeTerminationGracePeriod feature gate."
            }
          },
          "timeoutSeconds": {
            "type": "int",
            "nullable": true,
            "minValue": 1,
            "maxValue": 240,
            "metadata": {
              "description": "Optional. Number of seconds after which the probe times out. Defaults to 1 second."
            }
          },
          "type": {
            "type": "string",
            "allowedValues": [
              "Liveness",
              "Readiness",
              "Startup"
            ],
            "metadata": {
              "description": "Required. The type of probe."
            }
          }
        }
      },
      "nullable": true
    },
    "containerResourceType": {
      "type": "object",
      "properties": {
        "cpu": {
          "type": "string",
          "metadata": {
            "example": "    '0.25'\r\n    '1'\r\n    ",
            "description": "Required. The CPU limit of the container in cores."
          }
        },
        "memory": {
          "type": "string",
          "metadata": {
            "example": "    '250Mb'\r\n    '1.5Gi'\r\n    '1500Mi'\r\n    ",
            "description": "Optional. The required memory."
          }
        }
      },
      "nullable": true
    },
    "containerVolumeMountType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "mountPath": {
            "type": "string",
            "metadata": {
              "description": "Required. The path within the container at which the volume should be mounted. Must not contain ':'."
            }
          },
          "subPath": {
            "type": "string",
            "nullable": true,
            "metadata": {
              "description": "Optional. Path within the volume from which the container's volume should be mounted."
            }
          },
          "volumeName": {
            "type": "string",
            "metadata": {
              "description": "Required. This must match the Name of a Volume."
            }
          }
        }
      },
      "nullable": true
    },
    "jobConfigurationManualTriggerConfigType": {
      "type": "object",
      "properties": {
        "parallelism": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Optional. Number of parallel replicas of a job that can run at a given time. Defaults to 1."
          }
        },
        "replicaCompletionCount": {
          "type": "int",
          "metadata": {
            "description": "Required. Minimum number of successful replica completions before overall job completion."
          }
        }
      }
    },
    "jobConfigurationScheduleTriggerconfigType": {
      "type": "object",
      "properties": {
        "cronExpression": {
          "type": "string",
          "metadata": {
            "description": "Required. Cron formatted repeating schedule (\"* * * * *\") of a Cron Job."
          }
        },
        "parallelism": {
          "type": "int",
          "metadata": {
            "description": "Required. Number of parallel replicas of a job that can run at a given time."
          }
        },
        "replicaCompletionCount": {
          "type": "int",
          "metadata": {
            "description": "Optional. Number of successful completions of a job that are necessary to consider the job complete."
          }
        }
      }
    },
    "jobConfigurationEventTriggerConfigType": {
      "type": "object",
      "properties": {
        "parallelism": {
          "type": "int",
          "metadata": {
            "description": "Required. Number of parallel replicas of a job that can run at a given time."
          }
        },
        "replicaCompletionCount": {
          "type": "int",
          "metadata": {
            "description": "Optional. Minimum number of successful replica completions before overall job completion."
          }
        },
        "scale": {
          "$ref": "#/definitions/jobScaleType",
          "metadata": {
            "description": "Required. Scaling configurations for event driven jobs."
          }
        }
      }
    },
    "jobScaleType": {
      "type": "object",
      "properties": {
        "maxExecutions": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Optional. Maximum number of job executions that are created for a trigger, default 100."
          }
        },
        "minExecutions": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Optional. Minimum number of job executions that are created for a trigger, default 0."
          }
        },
        "pollingInterval": {
          "type": "int",
          "nullable": true,
          "metadata": {
            "description": "Optional. Interval to check each event source in seconds. Defaults to 30s."
          }
        },
        "rules": {
          "$ref": "#/definitions/jobScaleRuleType",
          "metadata": {
            "description": "Optional. Scaling rules for the job."
          }
        }
      }
    },
    "jobScaleRuleType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "auth": {
            "$ref": "#/definitions/scaleRuleAuthType",
            "metadata": {
              "description": "Required. Authentication secrets for the scale rule."
            }
          },
          "metadata": {
            "type": "object",
            "metadata": {
              "example": "    {\r\n      \"// for type azure-queue\r\n      {\r\n        queueName: 'default'\r\n        storageAccountResourceId: '/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.Storage/storageAccounts/myStorageAccount'\r\n      }\"\r\n    }\r\n    ",
              "description": "Optional. Metadata properties to describe the scale rule."
            }
          },
          "name": {
            "type": "string",
            "metadata": {
              "description": "Required. The name of the scale rule."
            }
          },
          "type": {
            "type": "string",
            "metadata": {
              "example": "    {\r\n      \"azure-servicebus\"\r\n      \"azure-queue\"\r\n      \"redis\"\r\n    }\r\n    ",
              "description": "Optional. The type of the rule."
            }
          }
        }
      }
    },
    "scaleRuleAuthType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "secretRef": {
            "type": "string",
            "metadata": {
              "description": "Required. Name of the secret from which to pull the auth params."
            }
          },
          "triggerParameter": {
            "type": "string",
            "metadata": {
              "description": "Required. Trigger Parameter that uses the secret."
            }
          }
        }
      },
      "nullable": true
    },
    "initContainerType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "args": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "metadata": {
              "description": "Optional. Container start command arguments."
            }
          },
          "command": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "metadata": {
              "description": "Optional. Container start command."
            }
          },
          "env": {
            "$ref": "#/definitions/containerEnvironmentVariablesType",
            "metadata": {
              "description": "Optional. The environment variables to set in the container."
            }
          },
          "image": {
            "type": "string",
            "metadata": {
              "description": "Required. The image of the container."
            }
          },
          "name": {
            "type": "string",
            "metadata": {
              "description": "Required. The name of the container."
            }
          },
          "resources": {
            "$ref": "#/definitions/containerResourceType",
            "metadata": {
              "description": "Required. Container resource requirements."
            }
          },
          "volumeMounts": {
            "$ref": "#/definitions/containerVolumeMountType",
            "metadata": {
              "description": "Optional. The volume mounts to attach to the container."
            }
          }
        }
      }
    },
    "containerType": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "args": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "nullable": true,
            "metadata": {
              "description": "Optional. Container start command arguments."
            }
          },
          "command": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "nullable": true,
            "metadata": {
              "description": "Optional. The command to run in the container."
            }
          },
          "env": {
            "$ref": "#/definitions/containerEnvironmentVariablesType",
            "metadata": {
              "description": "Optional. The environment variables to set in the container."
            }
          },
          "image": {
            "type": "string",
            "metadata": {
              "description": "Required. The image of the container."
            }
          },
          "name": {
            "type": "string",
            "metadata": {
              "description": "Required. The name of the container."
            }
          },
          "probes": {
            "$ref": "#/definitions/containerProbeType",
            "metadata": {
              "description": "Optional. The probes of the container."
            }
          },
          "resources": {
            "$ref": "#/definitions/containerResourceType",
            "metadata": {
              "description": "Optional. The resources to allocate to the container."
            }
          },
          "volumeMounts": {
            "$ref": "#/definitions/containerVolumeMountType",
            "metadata": {
              "description": "Optional. The volume mounts to attach to the container."
            }
          }
        }
      }
    }
  },
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Required. Name of the Container App."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. Location for all Resources."
      }
    },
    "environmentResourceId": {
      "type": "string",
      "metadata": {
        "description": "Required. Resource ID of Container Apps Environment."
      }
    },
    "lock": {
      "$ref": "#/definitions/lockType",
      "metadata": {
        "description": "Optional. The lock settings of the service."
      }
    },
    "tags": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "example": "  {\r\n      \"key1\": \"value1\",\r\n      \"key2\": \"value2\"\r\n  }\r\n  ",
        "description": "Optional. Tags of the resource."
      }
    },
    "registries": {
      "$ref": "#/definitions/registryCredentialsType",
      "nullable": true,
      "metadata": {
        "example": "[[\r\n  {\r\n    \"server\": \"myregistry.azurecr.io\",\r\n    \"identity\": \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myManagedIdentity\"\r\n  },\r\n  {\r\n    \"server\": \"myregistry2.azurecr.io\",\r\n    \"identity\": \"system\"\r\n  }\r\n  ,\r\n  {\r\n    \"server\": \"myregistry3.azurecr.io\",\r\n    \"username\": \"myusername\",\r\n    \"passwordSecretRef\": \"secret-name\"\r\n  }\r\n]",
        "description": "Optional. Collection of private container registry credentials for containers used by the Container app."
      }
    },
    "managedIdentities": {
      "$ref": "#/definitions/managedIdentitiesType",
      "metadata": {
        "example": "  {\r\n    \"systemAssigned\": true,\r\n    \"userAssignedResourceIds\": [\r\n      \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myManagedIdentity\"\r\n    ]\r\n  },\r\n  {\r\n    \"systemAssigned\": true\r\n  }\r\n  ",
        "description": "Optional. The managed identity definition for this resource."
      }
    },
    "roleAssignments": {
      "$ref": "#/definitions/roleAssignmentType",
      "metadata": {
        "description": "Optional. Array of role assignments to create."
      }
    },
    "enableTelemetry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable/Disable usage telemetry for module."
      }
    },
    "containers": {
      "$ref": "#/definitions/containerType",
      "metadata": {
        "description": "Required. List of container definitions for the Container App."
      }
    },
    "initContainersTemplate": {
      "$ref": "#/definitions/initContainerType",
      "nullable": true,
      "metadata": {
        "description": "Optional. List of specialized containers that run before app containers."
      }
    },
    "eventTriggerConfig": {
      "$ref": "#/definitions/jobConfigurationEventTriggerConfigType",
      "nullable": true,
      "metadata": {
        "description": "Optional. Required if TriggerType is Event. Configuration of an event driven job."
      }
    },
    "scheduleTriggerConfig": {
      "$ref": "#/definitions/jobConfigurationScheduleTriggerconfigType",
      "nullable": true,
      "metadata": {
        "description": "Optional. Required if TriggerType is Schedule. Configuration of a schedule based job."
      }
    },
    "manualTriggerConfig": {
      "$ref": "#/definitions/jobConfigurationManualTriggerConfigType",
      "nullable": true,
      "metadata": {
        "description": "Optional. Required if TriggerType is Manual. Configuration of a manual job."
      }
    },
    "replicaRetryLimit": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Optional. The maximum number of times a replica can be retried."
      }
    },
    "workloadProfileName": {
      "type": "string",
      "defaultValue": "Consumption",
      "metadata": {
        "description": "Optional. The name of the workload profile to use."
      }
    },
    "secrets": {
      "$ref": "#/definitions/secretsType",
      "nullable": true,
      "metadata": {
        "examle": "{\r\n  \"name\": \"mysecret\"\r\n  \"identity\": \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myManagedIdentity\",\r\n  \"keyVaultUrl\": \"https://myvault${environment().suffixes.keyvaultDns}/secrets/mysecret\",\r\n},\r\n{\r\n  \"name\": \"mysecret\"\r\n  \"identity\": \"system\",\r\n  \"keyVaultUrl\": \"https://myvault${environment().suffixes.keyvaultDns}/secrets/mysecret\",\r\n},\r\n{\r\n  \"name\": \"mysecret\",\r\n  \"value\": \"mysecretvalue\"\r\n}\r\n",
        "description": "Optional. The secrets of the Container App."
      }
    },
    "volumes": {
      "$ref": "#/definitions/volumeType",
      "nullable": true,
      "metadata": {
        "description": "Optional. List of volume definitions for the Container App."
      }
    },
    "replicaTimeout": {
      "type": "int",
      "defaultValue": 1800,
      "metadata": {
        "description": "Optional. Maximum number of seconds a replica is allowed to run."
      }
    },
    "triggerType": {
      "type": "string",
      "allowedValues": [
        "Event",
        "Manual",
        "Schedule"
      ],
      "metadata": {
        "description": "Required. Trigger type of the job."
      }
    }
  },
  "variables": {
    "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
    "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'UserAssigned', 'None')), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
    "builtInRoleNames": {
      "ContainerApp Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ad2dd5fb-cd4b-4fd4-a9b6-4fed3630980b')]",
      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
      "Role Based Access Control Administrator (Preview)": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
    }
  },
  "resources": {
    "avmTelemetry": {
      "condition": "[parameters('enableTelemetry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "[format('46d3xbcp.res.app-job.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [],
          "outputs": {
            "telemetry": {
              "type": "String",
              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
            }
          }
        }
      }
    },
    "job": {
      "type": "Microsoft.App/jobs",
      "apiVersion": "2024-03-01",
      "name": "[parameters('name')]",
      "tags": "[parameters('tags')]",
      "location": "[parameters('location')]",
      "identity": "[variables('identity')]",
      "properties": {
        "environmentId": "[parameters('environmentResourceId')]",
        "configuration": {
          "triggerType": "[parameters('triggerType')]",
          "eventTriggerConfig": "[if(equals(parameters('triggerType'), 'Event'), parameters('eventTriggerConfig'), null())]",
          "manualTriggerConfig": "[if(equals(parameters('triggerType'), 'Manual'), parameters('manualTriggerConfig'), null())]",
          "scheduleTriggerConfig": "[if(equals(parameters('triggerType'), 'Schedule'), parameters('scheduleTriggerConfig'), null())]",
          "replicaRetryLimit": "[parameters('replicaRetryLimit')]",
          "replicaTimeout": "[parameters('replicaTimeout')]",
          "registries": "[parameters('registries')]",
          "secrets": "[parameters('secrets')]"
        },
        "template": {
          "containers": "[parameters('containers')]",
          "initContainers": "[parameters('initContainersTemplate')]",
          "volumes": "[parameters('volumes')]"
        },
        "workloadProfileName": "[parameters('workloadProfileName')]"
      }
    },
    "job_lock": {
      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
      "type": "Microsoft.Authorization/locks",
      "apiVersion": "2020-05-01",
      "scope": "[format('Microsoft.App/jobs/{0}', parameters('name'))]",
      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
      "properties": {
        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
        "notes": "[if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.')]"
      },
      "dependsOn": [
        "job"
      ]
    },
    "automationAccount_roleAssignments": {
      "copy": {
        "name": "automationAccount_roleAssignments",
        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.App/jobs/{0}', parameters('name'))]",
      "name": "[guid(resourceId('Microsoft.App/jobs', parameters('name')), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].principalId, coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName)]",
      "properties": {
        "roleDefinitionId": "[if(contains(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName), variables('builtInRoleNames')[coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName], if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex()].roleDefinitionIdOrName)))]",
        "principalId": "[coalesce(parameters('roleAssignments'), createArray())[copyIndex()].principalId]",
        "description": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'description')]",
        "principalType": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'principalType')]",
        "condition": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'condition')]",
        "conditionVersion": "[if(not(empty(tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(parameters('roleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
      },
      "dependsOn": [
        "job"
      ]
    }
  },
  "outputs": {
    "resourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the Container App Job."
      },
      "value": "[resourceId('Microsoft.App/jobs', parameters('name'))]"
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the resource group the Container App Job was deployed into."
      },
      "value": "[resourceGroup().name]"
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the Container App Job."
      },
      "value": "[parameters('name')]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location the resource was deployed into."
      },
      "value": "[reference('job', '2024-03-01', 'full').location]"
    },
    "systemAssignedMIPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal ID of the system assigned identity."
      },
      "value": "[coalesce(tryGet(tryGet(reference('job', '2024-03-01', 'full'), 'identity'), 'principalId'), '')]"
    }
  }
}
