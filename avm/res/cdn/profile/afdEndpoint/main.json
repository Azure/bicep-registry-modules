{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.26.170.59819",
      "templateHash": "1139997023996590437"
    },
    "name": "CDN Profiles AFD Endpoints",
    "description": "This module deploys a CDN Profile AFD Endpoint.",
    "owner": "Azure/module-maintainers"
  },
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Required. The name of the AFD Endpoint."
      }
    },
    "profileName": {
      "type": "string",
      "metadata": {
        "description": "Conditional. The name of the parent CDN profile. Required if the template is used in a standalone deployment."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. The location of the AFD Endpoint."
      }
    },
    "tags": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "description": "Optional. The tags of the AFD Endpoint."
      }
    },
    "autoGeneratedDomainNameLabelScope": {
      "type": "string",
      "defaultValue": "TenantReuse",
      "allowedValues": [
        "NoReuse",
        "ResourceGroupReuse",
        "SubscriptionReuse",
        "TenantReuse"
      ],
      "metadata": {
        "description": "Optional. Indicates the endpoint name reuse scope. The default value is TenantReuse."
      }
    },
    "enabledState": {
      "type": "string",
      "defaultValue": "Enabled",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "metadata": {
        "description": "Optional. Indicates whether the AFD Endpoint is enabled. The default value is Enabled."
      }
    },
    "routes": {
      "type": "array",
      "nullable": true,
      "metadata": {
        "description": "Optional. The list of routes for this AFD Endpoint."
      }
    }
  },
  "resources": {
    "profile": {
      "existing": true,
      "type": "Microsoft.Cdn/profiles",
      "apiVersion": "2023-05-01",
      "name": "[parameters('profileName')]"
    },
    "afdEndpoint": {
      "type": "Microsoft.Cdn/profiles/afdEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('profileName'), parameters('name'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "autoGeneratedDomainNameLabelScope": "[parameters('autoGeneratedDomainNameLabelScope')]",
        "enabledState": "[parameters('enabledState')]"
      },
      "dependsOn": [
        "profile"
      ]
    },
    "afdEndpoint_routes": {
      "copy": {
        "name": "afdEndpoint_routes",
        "count": "[length(coalesce(parameters('routes'), createArray()))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-Profile-AfdEndpoint-Route', uniqueString(deployment().name, coalesce(parameters('routes'), createArray())[copyIndex()].name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[coalesce(parameters('routes'), createArray())[copyIndex()].name]"
          },
          "profileName": {
            "value": "[parameters('profileName')]"
          },
          "afdEndpointName": {
            "value": "[parameters('name')]"
          },
          "cacheConfiguration": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'cacheConfiguration')]"
          },
          "customDomainNames": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'customDomainNames')]"
          },
          "enabledState": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'enabledState')]"
          },
          "forwardingProtocol": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'forwardingProtocol')]"
          },
          "httpsRedirect": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'httpsRedirect')]"
          },
          "linkToDefaultDomain": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'linkToDefaultDomain')]"
          },
          "originGroupName": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'originGroupName')]"
          },
          "originPath": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'originPath')]"
          },
          "patternsToMatch": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'patternsToMatch')]"
          },
          "ruleSets": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'ruleSets')]"
          },
          "supportedProtocols": {
            "value": "[tryGet(coalesce(parameters('routes'), createArray())[copyIndex()], 'supportedProtocols')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.26.170.59819",
              "templateHash": "5770374289363120600"
            },
            "name": "CDN Profiles AFD Endpoint Route",
            "description": "This module deploys a CDN Profile AFD Endpoint route.",
            "owner": "Azure/module-maintainers"
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the route."
              }
            },
            "profileName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the parent CDN profile."
              }
            },
            "afdEndpointName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the AFD endpoint."
              }
            },
            "cacheConfiguration": {
              "type": "object",
              "nullable": true,
              "metadata": {
                "description": "Optional. The caching configuration for this route. To disable caching, do not provide a cacheConfiguration object."
              }
            },
            "customDomainNames": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "nullable": true,
              "metadata": {
                "description": "Optional. The names of the custom domains. The custom domains must be defined in the profile customDomains array."
              }
            },
            "forwardingProtocol": {
              "type": "string",
              "defaultValue": "MatchRequest",
              "allowedValues": [
                "HttpOnly",
                "HttpsOnly",
                "MatchRequest"
              ],
              "metadata": {
                "description": "Optional. The protocol this rule will use when forwarding traffic to backends."
              }
            },
            "enabledState": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "Optional. Whether this route is enabled."
              }
            },
            "httpsRedirect": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "Optional. Whether to automatically redirect HTTP traffic to HTTPS traffic."
              }
            },
            "linkToDefaultDomain": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "Optional. Whether this route will be linked to the default endpoint domain."
              }
            },
            "originGroupName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the origin group. The origin group must be defined in the profile originGroups."
              }
            },
            "originPath": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Optional. A directory path on the origin that AzureFrontDoor can use to retrieve content from, e.g. contoso.cloudapp.net/originpath."
              }
            },
            "patternsToMatch": {
              "type": "array",
              "nullable": true,
              "metadata": {
                "description": "Optional. The route patterns of the rule."
              }
            },
            "ruleSets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional. The rule sets of the rule. The rule sets must be defined in the profile ruleSets."
              }
            },
            "supportedProtocols": {
              "type": "array",
              "nullable": true,
              "allowedValues": [
                "Http",
                "Https"
              ],
              "metadata": {
                "description": "Optional. The supported protocols of the rule."
              }
            }
          },
          "resources": {
            "profile::afdEndpoint": {
              "existing": true,
              "type": "Microsoft.Cdn/profiles/afdEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('profileName'), parameters('afdEndpointName'))]",
              "dependsOn": [
                "profile"
              ]
            },
            "profile::customDomains": {
              "copy": {
                "name": "customDomains",
                "count": "[length(coalesce(parameters('customDomainNames'), createArray()))]"
              },
              "existing": true,
              "type": "Microsoft.Cdn/profiles/customDomains",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('profileName'), coalesce(parameters('customDomainNames'), createArray())[copyIndex()])]",
              "dependsOn": [
                "profile"
              ]
            },
            "profile::originGroup": {
              "existing": true,
              "type": "Microsoft.Cdn/profiles/originGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('profileName'), parameters('originGroupName'))]",
              "dependsOn": [
                "profile"
              ]
            },
            "profile::ruleSet": {
              "copy": {
                "name": "ruleSet",
                "count": "[length(parameters('ruleSets'))]"
              },
              "existing": true,
              "type": "Microsoft.Cdn/profiles/ruleSets",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('profileName'), parameters('ruleSets')[copyIndex()].name)]",
              "dependsOn": [
                "profile"
              ]
            },
            "profile": {
              "existing": true,
              "type": "Microsoft.Cdn/profiles",
              "apiVersion": "2023-05-01",
              "name": "[parameters('profileName')]"
            },
            "route": {
              "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('profileName'), parameters('afdEndpointName'), parameters('name'))]",
              "properties": {
                "copy": [
                  {
                    "name": "customDomains",
                    "count": "[length(range(0, length(coalesce(parameters('customDomainNames'), createArray()))))]",
                    "input": {
                      "id": "[resourceId('Microsoft.Cdn/profiles/customDomains', parameters('profileName'), coalesce(parameters('customDomainNames'), createArray())[range(0, length(coalesce(parameters('customDomainNames'), createArray())))[copyIndex('customDomains')]])]"
                    }
                  },
                  {
                    "name": "ruleSets",
                    "count": "[length(parameters('ruleSets'))]",
                    "input": {
                      "id": "[resourceId('Microsoft.Cdn/profiles/ruleSets', parameters('profileName'), parameters('ruleSets')[copyIndex('ruleSets')].name)]"
                    }
                  }
                ],
                "cacheConfiguration": "[parameters('cacheConfiguration')]",
                "enabledState": "[parameters('enabledState')]",
                "forwardingProtocol": "[parameters('forwardingProtocol')]",
                "httpsRedirect": "[parameters('httpsRedirect')]",
                "linkToDefaultDomain": "[parameters('linkToDefaultDomain')]",
                "originGroup": {
                  "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('profileName'), parameters('originGroupName'))]"
                },
                "originPath": "[parameters('originPath')]",
                "patternsToMatch": "[parameters('patternsToMatch')]",
                "supportedProtocols": "[parameters('supportedProtocols')]"
              },
              "dependsOn": [
                "profile::afdEndpoint"
              ]
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the route."
              },
              "value": "[parameters('name')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the route."
              },
              "value": "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', parameters('profileName'), parameters('afdEndpointName'), parameters('name'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The name of the resource group the route was created in."
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "afdEndpoint",
        "profile"
      ]
    }
  },
  "outputs": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the AFD Endpoint."
      },
      "value": "[parameters('name')]"
    },
    "resourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource id of the AFD Endpoint."
      },
      "value": "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('profileName'), parameters('name'))]"
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the resource group the endpoint was created in."
      },
      "value": "[resourceGroup().name]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location the resource was deployed into."
      },
      "value": "[reference('afdEndpoint', '2023-05-01', 'full').location]"
    }
  }
}
