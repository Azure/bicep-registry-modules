name: On pull request

on:
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  get-module-to-validate:
    uses: Azure/bicep-registry-modules/.github/workflows/get-changed-module.yml@main

  validate-module:
    runs-on: ubuntu-latest
    needs: get-module-to-validate
    if: needs.get-module-to-validate.outputs.module_dir
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 6.0.x

      # TODO: remove once brm is published
      - name: Install Bicep registry module tool
        run: dotnet tool install -g --add-source ./packages Bicep.RegistryModuleTool

      - name: Validate module files
        run: brm validate
        working-directory: ${{ needs.get-module-to-validate.outputs.module_dir }}

  test-module-deployment:
    runs-on: windows-latest
    needs:
      - get-module-to-validate
      - validate-module
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.DEPLOYMENT_TEST_CLIENT_ID }}
          tenant-id: ${{ secrets.DEPLOYMENT_TEST_TENANT_ID }}
          subscription-id: ${{ secrets.DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
          enable-AzPSSession: true
      
      - name: Generate resource group name
        id: generate-rg-name
        uses: actions/github-script@v5
        with:
          result-encoding: string
          script: |
            const pullRequestNumber = context.payload.pull_request.number
            const sha = context.payload.pull_request.base.sha.substring(0, 7)
            const timestamp = Date.now()
            return `brm-test-pr-${pullRequestNumber}-commit-${sha}-ts-${timestamp}`
      
      - name: Create resource group
        uses: azure/powershell@v1
        with:
          inlineScript: |
            New-AzResourceGroup -ResourceGroupName "${{ steps.generate-rg-name.outputs.result }}" -Location "westus"
          azPSVersion: "latest"
      
      # TODO: generate parameters
        
      - name: Deploy test file
        uses: azure/powershell@v1
        with:
          inlineScript: |
            New-AzResourceGroupDeployment -TemplateFile ".\${{ needs.get-module-to-validate.outputs.module_dir }}\test\main.test.bicep" -ResourceGroupName "${{ steps.generate-rg-name.outputs.result }}"
          azPSVersion: "latest"
      
      - name: Clean up resource group
        if: always() && steps.generate-rg-name.outputs.result
        uses: azure/powershell@v1
        with:
          inlineScript: |
            Invoke-WebRequest -Uri https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/test/ci-scripts/Kill-AzResourceGroup.ps1 -OutFile .\Kill-AzResourceGroup.ps1
            .\Kill-AzResourceGroup.ps1 -ResourceGroupName "${{ steps.generate-rg-name.outputs.result }}"
          azPSVersion: "latest"


