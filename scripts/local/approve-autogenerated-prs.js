/*

  This script approves all auto-generated PRs.  It will query interactively for each module.

  Usage:
    Install gh from https://cli.github.com/
    Log in to gh
    cd repos/bicep-registry-modules
    npm i
    node scripts/local/approve-autogenerated-prs.js

    <You'll have the opportunity to review each PR before approving>

*/

const {
  runAsync,
  queryUserAsync,
  queryRunAsync,
} = require("./util/runAsync.js");
const { clearScreen, green, yellow, red, reset } = require("./util/colors");

const { argv } = require("process");

function formatPR(pr) {
  return `#${pr.number} (${pr.author.login} ${pr.state} ${pr.labels.map(
    (l) => l.name
  )}) ${yellow}${pr.title}${reset}`;
}

async function ApprovePRs() {
  const prs = JSON.parse(
    await runAsync(
      `gh pr list --label "Auto-generated" --state open --limit 500 --json number,author,title,state,labels,statusCheckRollup -S "review:required draft:false"`
    )
  );

  console.log(`${yellow}Found these PRs:${reset}`);
  for (pr of prs) {
    console.log(formatPR(pr));
  }
  console.log();

  for (pr of prs) {
    await queryRunAsync(
      [
        `gh pr merge --auto --squash ${pr.number}`,
        `gh pr review --approve ${pr.number}`,
      ],
      `Approve the following PR?${reset}\n${formatPR(pr)}`
    );
  }
}

ApprovePRs();
